import React, { useState, useCallback, useMemo, useRef, useEffect } from 'react';
import { KamDataProvider, useKamDataContext } from './data/KamDataContext';
import BillingChart from './components/BillingChart';
import CollectionChart from './components/CollectionChart';
import {
  AreaChart, Area, BarChart, Bar, ComposedChart, Line,
  ResponsiveContainer, Tooltip, XAxis, YAxis, CartesianGrid, Cell,
  Legend, ReferenceLine, PieChart, Pie
} from 'recharts';
import { formatCrore, getAchievementColor } from './utils/helpers';
import ReactMarkdown from 'react-markdown';
import './App.css';

/* ================================================================
   BusinessNext Official SVG Logo (inline — from businessnext.com)
   ================================================================ */
const BusinessNextLogo = () => (
  <svg width="105" height="53" viewBox="0 0 105 53" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ height: 30, width: 'auto' }}>
    <path d="M74.5369 25.1053L74.7539 23.8672L73.5406 23.6501L72.4768 24.3973L73.6901 24.6143L73.4695 25.8525L74.5369 25.1053Z" fill="#E81F76"/>
    <path d="M71.8968 26.283L72.1138 25.0448L70.9005 24.8278L69.8331 25.5714L71.05 25.7884L70.8294 27.0302L71.8968 26.283Z" fill="#E81F76"/>
    <path d="M44.0802 13.8655L43.9877 12.6096L42.7566 12.7021L41.9062 13.6841L43.1373 13.5951L43.2298 14.8511L44.0802 13.8655Z" fill="#E81F76"/>
    <path d="M52.4057 20.9922L52.7259 19.7753L51.534 19.4587L50.4097 20.1134L51.6052 20.43L51.2814 21.6468L52.4057 20.9922Z" fill="#E81F76"/>
    <path d="M53.8004 18.5372L53.4446 17.3275L52.2634 17.6797L51.6407 18.8218L52.822 18.4732L53.1814 19.6793L53.8004 18.5372Z" fill="#E81F76"/>
    <path d="M47.898 13.186L47.5387 11.9798L46.3574 12.3285L45.7347 13.4706L46.9196 13.1219L47.2754 14.3281L47.898 13.186Z" fill="#E81F76"/>
    <path d="M48.4027 15.5805L48.8759 14.4099L47.7338 13.9509L46.5383 14.4562L47.6804 14.9223L47.2072 16.0893L48.4027 15.5805Z" fill="#E81F76"/>
    <path d="M49.0861 17.5624L48.7268 16.3527L47.5455 16.7049L46.9229 17.847L48.1077 17.4983L48.4635 18.7045L49.0861 17.5624Z" fill="#E81F76"/>
    <path d="M48.3743 23.3726L48.6946 22.1522L47.5026 21.8391L46.3783 22.4902L47.5738 22.8069L47.25 24.0237L48.3743 23.3726Z" fill="#E81F76"/>
    <path d="M45.9589 24.1482L46.2792 22.9313L45.0872 22.6147L43.9629 23.2693L45.1548 23.5824L44.8346 24.8028L45.9589 24.1482Z" fill="#E81F76"/>
    <path d="M48.8548 20.7574L49.175 19.5405L47.9831 19.2274L46.8588 19.8821L48.0507 20.1952L47.7305 21.4156L48.8548 20.7574Z" fill="#E81F76"/>
    <path d="M26.8519 8.58903L26.7345 7.33661L25.507 7.45402L24.678 8.45382L25.9055 8.33641L26.0229 9.59238L26.8519 8.58903Z" fill="#E81F76"/>
    <path d="M51.8511 16.5981L51.4953 15.3919L50.3141 15.737L49.6914 16.8792L50.8727 16.534L51.2285 17.7437L51.8511 16.5981Z" fill="#E81F76"/>
    <path d="M54.4267 16.3953L54.014 15.2069L52.847 15.6125L52.2812 16.7831L53.4447 16.3775L53.861 17.5694L54.4267 16.3953Z" fill="#E81F76"/>
    <path d="M56.9349 16.0465L56.4724 14.8724L55.3267 15.3243L54.8073 16.5198L55.9529 16.0679L56.4155 17.2385L56.9349 16.0465Z" fill="#E81F76"/>
    <path d="M58.9351 17.5658L59.4759 16.4273L58.3623 15.8971L57.1383 16.3312L58.2484 16.8613L57.7076 17.9999L58.9351 17.5658Z" fill="#E81F76"/>
    <path d="M64.7808 21.5259L65.3216 20.3909L64.208 19.8608L62.984 20.2949L64.0977 20.825L63.5533 21.9636L64.7808 21.5259Z" fill="#E81F76"/>
    <path d="M84.4673 13.193L85.0081 12.0544L83.8945 11.5243L82.6705 11.9584L83.7842 12.4885L83.2398 13.6271L84.4673 13.193Z" fill="#E81F76"/>
    <path d="M60.9663 16.5411L61.5072 15.4025L60.3935 14.8724L59.1696 15.3065L60.2797 15.8366L59.7388 16.9752L60.9663 16.5411Z" fill="#E81F76"/>
    <path d="M57.6077 13.5027L57.1451 12.3321L55.9995 12.784L55.48 13.9759L56.6257 13.524L57.0882 14.6982L57.6077 13.5027Z" fill="#E81F76"/>
    <path d="M58.8029 15.1001L58.8492 13.8405L57.6181 13.7979L56.6646 14.6838L57.8992 14.7265L57.8565 15.986L58.8029 15.1001Z" fill="#E81F76"/>
    <path d="M61.3612 14.0293L61.5142 12.7769L60.2902 12.631L59.2655 13.4316L60.4895 13.581L60.34 14.8334L61.3612 14.0293Z" fill="#E81F76"/>
    <path d="M70.338 23.8884L71.1065 22.8922L70.1281 22.1379L68.8401 22.3051L69.815 23.0594L69.0464 24.0556L70.338 23.8884Z" fill="#E81F76"/>
    <path d="M45.9905 21.4404L46.1506 20.1916L44.9267 20.035L43.8984 20.832L45.1224 20.9886L44.9658 22.2374L45.9905 21.4404Z" fill="#E81F76"/>
    <path d="M77.134 21.1452L77.2941 19.8963L76.0701 19.7433L75.0419 20.5368L76.2658 20.6933L76.1093 21.9422L77.134 21.1452Z" fill="#E81F76"/>
    <path d="M76.8282 19.2417L76.9883 17.9929L75.7643 17.8363L74.7361 18.6333L75.96 18.7898L75.8035 20.0387L76.8282 19.2417Z" fill="#E81F76"/>
    <path d="M72.0283 18.0676L72.1848 16.8187L70.9644 16.6657L69.9362 17.4627L71.1601 17.6157L71 18.8646L72.0283 18.0676Z" fill="#E81F76"/>
    <path d="M50.0827 25.3294L50.2428 24.0806L49.0189 23.924L47.9906 24.721L49.2146 24.8776L49.0544 26.1264L50.0827 25.3294Z" fill="#E81F76"/>
    <path d="M70.6759 12.3071L70.0354 11.222L68.9716 11.8517L68.6478 13.1077L69.7117 12.4815L70.3521 13.5667L70.6759 12.3071Z" fill="#E81F76"/>
    <path d="M67.5559 12.3499L66.9155 11.2647L65.8552 11.8909L65.5278 13.1504L66.5917 12.5242L67.2286 13.6094L67.5559 12.3499Z" fill="#E81F76"/>
    <path d="M65.8588 13.6343L65.2183 12.5491L64.1545 13.1753L63.8307 14.4348L64.891 13.8086L65.5314 14.8938L65.8588 13.6343Z" fill="#E81F76"/>
    <path d="M74.6612 18.0069L74.2236 16.8257L73.0672 17.2526L72.5228 18.4339L73.6792 18.0069L74.1168 19.1882L74.6612 18.0069Z" fill="#E81F76"/>
    <path d="M73.6651 16.1L73.8252 14.8476L72.6013 14.6946L71.573 15.4916L72.797 15.6446L72.6368 16.8935L73.6651 16.1Z" fill="#E81F76"/>
    <path d="M79.5958 22.5827L79.7523 21.3339L78.5284 21.1773L77.5001 21.9743L78.7276 22.1308L78.5711 23.3797L79.5958 22.5827Z" fill="#E81F76"/>
    <path d="M67.8335 15.1677L67.9936 13.9153L66.7696 13.7623L65.7378 14.5593L66.9653 14.7123L66.8052 15.9612L67.8335 15.1677Z" fill="#E81F76"/>
    <path d="M21.8498 18.4731L21.5652 17.2456L20.3662 17.5231L19.6759 18.6261L20.8785 18.3486L21.1596 19.5761L21.8498 18.4731Z" fill="#E81F76"/>
    <path d="M79.7703 11.5635L80.3965 10.4712L79.3255 9.85568L78.0731 10.1973L79.1405 10.8128L78.5143 11.9015L79.7703 11.5635Z" fill="#E81F76"/>
    <path d="M74.8315 11.8732L74.1199 10.8342L73.1023 11.528L72.8604 12.8054L73.8779 12.1116L74.5895 13.1505L74.8315 11.8732Z" fill="#E81F76"/>
    <path d="M76.2908 15.5449L75.5792 14.506L74.5616 15.1998L74.3232 16.4807L75.3408 15.7833L76.0489 16.8223L76.2908 15.5449Z" fill="#E81F76"/>
    <path d="M85.1714 19.5939L84.4598 18.555L83.4422 19.2488L83.2039 20.5297L84.2214 19.8323L84.9295 20.8748L85.1714 19.5939Z" fill="#E81F76"/>
    <path d="M36.4163 10.5709L36.1352 9.34335L34.9326 9.62088L34.2423 10.7239L35.4449 10.4463L35.726 11.6738L36.4163 10.5709Z" fill="#E81F76"/>
    <path d="M46.7664 19.6829L46.923 18.4305L45.699 18.2775L44.6708 19.0745L45.8947 19.231L45.7382 20.4799L46.7664 19.6829Z" fill="#E81F76"/>
    <path d="M41.3191 12.8907L42.0165 11.8411L40.9882 11.1615L39.7145 11.4177L40.7427 12.1008L40.0454 13.1504L41.3191 12.8907Z" fill="#E81F76"/>
    <path d="M60.5965 19.4267L60.7566 18.1779L59.5327 18.0213L58.5044 18.8183L59.7283 18.9713L59.5718 20.2237L60.5965 19.4267Z" fill="#E81F76"/>
    <path d="M36.5944 13.5417L36.3133 12.3142L35.1107 12.5917L34.4204 13.6947L35.623 13.4172L35.9077 14.6411L36.5944 13.5417Z" fill="#E81F76"/>
    <path d="M31.1753 9.70612L30.8906 8.47861L29.6916 8.75613L29.0013 9.85911L30.2039 9.58159L30.485 10.8091L31.1753 9.70612Z" fill="#E81F76"/>
    <path d="M24.1765 16.7013L23.8919 15.4738L22.6893 15.7513L22.0026 16.8543L23.2052 16.5768L23.4863 17.8043L24.1765 16.7013Z" fill="#E81F76"/>
    <path d="M98.2897 21.4405L98.4534 20.1917L97.2259 20.0387L96.1976 20.8357L97.4216 20.9887L97.265 22.2375L98.2897 21.4405Z" fill="#E81F76"/>
    <path d="M96.233 22.8068L96.3895 21.5579L95.1691 21.4014L94.1373 22.1984L95.3648 22.3549L95.2047 23.6038L96.233 22.8068Z" fill="#E81F76"/>
    <path d="M26.3436 12.0083L26.059 10.7808L24.8599 11.0618L24.1697 12.1613L25.3723 11.8873L25.6534 13.1112L26.3436 12.0083Z" fill="#E81F76"/>
    <path d="M29.4814 17.146L30.161 16.0857L29.1185 15.4203L27.8483 15.705L28.8908 16.3668L28.2147 17.4306L29.4814 17.146Z" fill="#E81F76"/>
    <path d="M33.1463 13.4208L34.1354 12.6416L33.374 11.6739L32.0825 11.5209L32.8474 12.4886L31.8547 13.2678L33.1463 13.4208Z" fill="#E81F76"/>
    <path d="M48.065 6.53959L47.7377 5.32275L46.5458 5.64297L45.8947 6.77086L47.0901 6.45064L47.4139 7.66392L48.065 6.53959Z" fill="#E81F76"/>
    <path d="M20.9104 16.3169L21.6647 15.31L20.6791 14.5699L19.3911 14.7514L20.3802 15.4915L19.6224 16.5019L20.9104 16.3169Z" fill="#E81F76"/>
    <path d="M49.6095 15.3172L50.6662 14.634L49.9937 13.5986L48.7235 13.3247L49.3924 14.3601L48.3357 15.0467L49.6095 15.3172Z" fill="#E81F76"/>
    <path d="M37.4161 7.87023L36.9572 6.69965L35.8079 7.15151L35.2885 8.33989L36.4377 7.89158L36.8967 9.06572L37.4161 7.87023Z" fill="#E81F76"/>
    <path d="M35.5405 5.50417L35.0815 4.33359L33.9323 4.78545L33.4128 5.97738L34.5585 5.52552L35.0211 6.69966L35.5405 5.50417Z" fill="#E81F76"/>
    <path d="M42.5892 8.23325L43.6459 7.55011L42.977 6.51473L41.7033 6.24432L42.3722 7.27615L41.3154 7.96284L42.5892 8.23325Z" fill="#E81F76"/>
    <path d="M53.5833 22.7962L53.3556 21.558L52.1423 21.7821L51.4022 22.8495L52.6155 22.6289L52.8432 23.8671L53.5833 22.7962Z" fill="#E81F76"/>
    <path d="M65.9476 23.9169L64.962 23.1306L64.1935 24.0948L64.3358 25.3863L65.1079 24.4257L66.0899 25.2084L65.9476 23.9169Z" fill="#E81F76"/>
    <path d="M53.3878 13.7375L52.4022 12.9512L51.6337 13.9154L51.776 15.2069L52.5481 14.2427L53.5301 15.029L53.3878 13.7375Z" fill="#E81F76"/>
    <path d="M65.2642 9.9838L64.2822 9.19748L63.5137 10.1581L63.656 11.4533L64.4245 10.489L65.4101 11.2754L65.2642 9.9838Z" fill="#E81F76"/>
    <path d="M55.9496 23.0131L55.7219 21.7714L54.5086 21.992L53.7686 23.0629L54.9818 22.8423L55.2096 24.0805L55.9496 23.0131Z" fill="#E81F76"/>
    <path d="M55.1884 25.308L54.3807 24.3438L53.4343 25.1337L53.3204 26.4324L54.2669 25.6389L55.0781 26.6031L55.1884 25.308Z" fill="#E81F76"/>
    <path d="M52.5053 24.5182L52.2811 23.28L51.0678 23.5006L50.3278 24.5715L51.541 24.3474L51.7687 25.5891L52.5053 24.5182Z" fill="#E81F76"/>
    <path d="M88.452 22.5364L88.2243 21.2982L87.0146 21.5188L86.2745 22.5898L87.4878 22.3692L87.712 23.6074L88.452 22.5364Z" fill="#E81F76"/>
    <path d="M69.6905 27.0907L69.4628 25.8525L68.2495 26.0731L67.5094 27.1405L68.7227 26.9199L68.9504 28.1616L69.6905 27.0907Z" fill="#E81F76"/>
    <path d="M82.3889 20.6471L82.1648 19.4089L80.9515 19.6295L80.2114 20.7005L81.4247 20.4799L81.6524 21.718L82.3889 20.6471Z" fill="#E81F76"/>
    <path d="M78.7812 17.6264L78.5534 16.3846L77.3402 16.6088L76.6001 17.6797L77.8169 17.4556L78.0411 18.6938L78.7812 17.6264Z" fill="#E81F76"/>
    <path d="M80.0265 20.0032L79.8023 18.765L78.5855 18.9856L77.849 20.053L79.0623 19.8324L79.2864 21.0741L80.0265 20.0032Z" fill="#E81F76"/>
    <path d="M80.6745 14.8439L80.4467 13.6022L79.2335 13.8264L78.4934 14.8938L79.7031 14.6732L79.9344 15.9113L80.6745 14.8439Z" fill="#E81F76"/>
    <path d="M70.1389 15.9185L69.9112 14.6768L68.698 14.9009L67.9579 15.9683L69.1712 15.7477L69.3989 16.9859L70.1389 15.9185Z" fill="#E81F76"/>
    <path d="M87.6585 18.7578L87.4307 17.5196L86.221 17.7438L85.481 18.8112L86.6942 18.5906L86.922 19.8288L87.6585 18.7578Z" fill="#E81F76"/>
    <path d="M83.4388 18.4873L83.2147 17.2456L82.0014 17.4698L81.2614 18.5372L82.4746 18.3166L82.7023 19.5547L83.4388 18.4873Z" fill="#E81F76"/>
    <path d="M42.9696 12.1399L44.0512 11.4995L43.425 10.4392L42.1655 10.1119L42.7917 11.1757L41.7101 11.8162L42.9696 12.1399Z" fill="#E81F76"/>
    <path d="M38.7713 10.7914L39.7675 10.0193L39.0168 9.04795L37.7252 8.87717L38.476 9.85562L37.4797 10.6241L38.7713 10.7914Z" fill="#E81F76"/>
    <path d="M39.7498 7.05907L39.9099 5.81021L38.686 5.65366L37.6577 6.44709L38.8817 6.6072L38.718 7.85606L39.7498 7.05907Z" fill="#E81F76"/>
    <path d="M39.3447 12.9298L38.9213 11.745L37.7614 12.1577L37.2028 13.3318L38.3627 12.9191L38.7896 14.1039L39.3447 12.9298Z" fill="#E81F76"/>
    <path d="M50.9402 22.1237L50.2001 21.1025L49.2039 21.8283L49.0011 23.1128L50.0009 22.3869L50.7374 23.4045L50.9402 22.1237Z" fill="#E81F76"/>
    <path d="M50.986 18.7187L50.2424 17.7011L49.2461 18.4234L49.0433 19.7079L50.0396 18.982L50.7796 20.0032L50.986 18.7187Z" fill="#E81F76"/>
    <path d="M42.714 16.8543L42.7247 15.5912L41.4936 15.5805L40.5649 16.4914L41.7996 16.5021L41.7853 17.7616L42.714 16.8543Z" fill="#E81F76"/>
    <path d="M16.9045 22.878L17.6624 21.8711L16.6732 21.131L15.3853 21.3161L16.3744 22.0561L15.6165 23.063L16.9045 22.878Z" fill="#E81F76"/>
    <path d="M13.5914 19.4302L14.0575 18.2631L12.9082 17.8077L11.7163 18.3201L12.862 18.7755L12.3959 19.9461L13.5914 19.4302Z" fill="#E81F76"/>
    <path d="M13.1967 22.0952L13.6628 20.9246L12.5171 20.4691L11.3217 20.9851L12.4673 21.4405L12.0012 22.6111L13.1967 22.0952Z" fill="#E81F76"/>
    <path d="M6.24787 20.1739L6.71041 19.0069L5.56829 18.5515L4.3728 19.0638L5.51848 19.5192L5.05238 20.6898L6.24787 20.1739Z" fill="#E81F76"/>
    <path d="M7.75261 16.3098L8.44998 15.2602L7.42528 14.5771L6.14795 14.8332L7.17621 15.5164L6.47529 16.566L7.75261 16.3098Z" fill="#E81F76"/>
    <path d="M12.3213 15.7442L12.3035 14.4846L11.0725 14.506L10.1652 15.4382L11.3998 15.4204L11.4176 16.6799L12.3213 15.7442Z" fill="#E81F76"/>
    <path d="M10.0268 14.0577L11.1333 13.4564L10.5463 12.3712L9.2974 12.0012L9.88803 13.0864L8.78149 13.6877L10.0268 14.0577Z" fill="#E81F76"/>
    <path d="M71.6515 15.0112L72.114 13.8406L70.9648 13.3888L69.7728 13.9118L70.9185 14.3601L70.4631 15.5342L71.6515 15.0112Z" fill="#E81F76"/>
    <path d="M11.2751 9.23295L12.5097 9.48912L12.7588 8.28296L12.0436 7.19421L11.7946 8.40393L10.5599 8.14776L11.2751 9.23295Z" fill="#E81F76"/>
    <path d="M18.9035 18.3771L19.6578 17.3702L18.6723 16.6302L17.3843 16.8116L18.3698 17.5552L17.6156 18.5586L18.9035 18.3771Z" fill="#E81F76"/>
    <path d="M83.791 22.9384L84.8477 22.2553L84.1752 21.2199L82.905 20.9495L83.5775 21.9813L82.5172 22.668L83.791 22.9384Z" fill="#E81F76"/>
    <path d="M80.9946 23.7996L82.0513 23.1164L81.3824 22.081L80.1122 21.8071L80.7811 22.8424L79.7244 23.5256L80.9946 23.7996Z" fill="#E81F76"/>
    <path d="M19.5157 21.0527L19.9284 19.8643L18.7649 19.4587L17.5944 20.028L18.7578 20.4336L18.3451 21.6219L19.5157 21.0527Z" fill="#E81F76"/>
    <path d="M9.72418 18.8966L10.9624 18.6618L10.7346 17.452L9.66014 16.7191L9.88785 17.9324L8.64966 18.1636L9.72418 18.8966Z" fill="#E81F76"/>
    <path d="M15.5772 18.2241L16.8154 17.9928L16.5877 16.7831L15.5132 16.0466L15.7409 17.2599L14.5027 17.4912L15.5772 18.2241Z" fill="#E81F76"/>
    <path d="M14.7228 11.7734L15.9539 12.0403L16.2136 10.8341L15.5091 9.74179L15.2494 10.9444L14.0183 10.6775L14.7228 11.7734Z" fill="#E81F76"/>
    <path d="M21.241 13.2927L22.3013 12.6096L21.6324 11.5742L20.3622 11.2967L21.0276 12.3356L19.9708 13.0187L21.241 13.2927Z" fill="#E81F76"/>
    <path d="M11.3894 24.874L12.4461 24.1909L11.7807 23.1555L10.5105 22.878L11.1794 23.9169L10.1191 24.5965L11.3894 24.874Z" fill="#E81F76"/>
    <path d="M23.7034 22.7357L24.5467 21.8035L23.6323 20.978L22.3336 21.042L23.248 21.8675L22.4048 22.8033L23.7034 22.7357Z" fill="#E81F76"/>
    <path d="M15.0506 15.9399L15.6875 14.8512L14.6201 14.2285L13.3641 14.5594L14.4315 15.1821L13.7947 16.2708L15.0506 15.9399Z" fill="#E81F76"/>
    <path d="M80.5245 26.9341L81.3642 25.9984L80.4463 25.1765L79.1476 25.2441L80.0655 26.0695L79.2259 27.0053L80.5245 26.9341Z" fill="#E81F76"/>
    <path d="M76.1948 27.1441L77.0381 26.2083L76.1201 25.3829L74.8214 25.454L75.7394 26.2759L74.8961 27.2152L76.1948 27.1441Z" fill="#E81F76"/>
    <path d="M90.8 26.3257L91.6397 25.3864L90.7218 24.5645L89.4231 24.6321L90.3411 25.4575L89.5014 26.3969L90.8 26.3257Z" fill="#E81F76"/>
    <path d="M96.219 13.1753L97.0587 12.2395L96.1407 11.4141L94.842 11.4853L95.76 12.3107L94.9203 13.2465L96.219 13.1753Z" fill="#E81F76"/>
    <path d="M46.8197 10.4143L47.6594 9.47853L46.7414 8.65308L45.4427 8.72424L46.3643 9.54969L45.521 10.4854L46.8197 10.4143Z" fill="#E81F76"/>
    <path d="M87.7011 26.6922L88.1174 25.5038L86.9539 25.0982L85.7798 25.6604L86.9433 26.0696L86.5305 27.2579L87.7011 26.6922Z" fill="#E81F76"/>
    <path d="M92.7644 27.3966L94.0097 27.2151L93.8318 25.9947L92.7893 25.2155L92.9672 26.4359L91.7219 26.6174L92.7644 27.3966Z" fill="#E81F76"/>
    <path d="M96.8773 24.7673L97.9447 25.4327L98.5994 24.3866L98.3041 23.12L97.6494 24.166L96.582 23.5007L96.8773 24.7673Z" fill="#E81F76"/>
    <path d="M27.6384 14.4775L28.8765 14.2427L28.6488 13.0329L27.5743 12.3L27.802 13.5097L26.5638 13.7445L27.6384 14.4775Z" fill="#E81F76"/>
    <path d="M81.9442 25.4149L83.186 25.6212L83.3888 24.4079L82.6345 23.3477L82.4317 24.5645L81.1899 24.3546L81.9442 25.4149Z" fill="#E81F76"/>
    <path d="M98.1051 32.3672L99.0764 31.563L98.2936 30.6131L96.9985 30.4885L97.7848 31.4385L96.8099 32.2426L98.1051 32.3672Z" fill="#E81F76"/>
    <path d="M1.69005 17.573L2.32338 16.4878L1.25954 15.8652L0 16.1961L1.06384 16.8187L0.430521 17.9075L1.69005 17.573Z" fill="#E81F76"/>
    <path d="M61.8985 29.357L62.8698 28.5565L62.0871 27.6065L60.792 27.482L61.5783 28.432L60.6034 29.2361L61.8985 29.357Z" fill="#E81F76"/>
    <path d="M68.7797 25.4895L69.7511 24.6854L68.9647 23.7354L67.6732 23.6109L68.4559 24.5644L67.4846 25.365L68.7797 25.4895Z" fill="#E81F76"/>
    <path d="M92.0349 20.6365L92.2483 19.3947L91.0315 19.1884L89.9677 19.9391L91.1845 20.149L90.971 21.3908L92.0349 20.6365Z" fill="#E81F76"/>
    <path d="M94.2442 23.7639L94.4577 22.5222L93.2408 22.3158L92.1805 23.0665L93.3974 23.2729L93.1839 24.5146L94.2442 23.7639Z" fill="#E81F76"/>
    <path d="M102.57 28.8056L102.78 27.5639L101.567 27.3575L100.503 28.1118L101.72 28.3182L101.506 29.5599L102.57 28.8056Z" fill="#E81F76"/>
    <path d="M6.41898 6.79935L7.10211 5.73906L6.06318 5.07016L4.79297 5.34412L5.82835 6.01659L5.14521 7.07331L6.41898 6.79935Z" fill="#E81F76"/>
    <path d="M101.923 17.413L102.136 16.1712L100.919 15.9648L99.8627 16.7156L101.076 16.9255L100.862 18.1637L101.923 17.413Z" fill="#E81F76"/>
    <path d="M95.0554 20.1347L95.2653 18.8929L94.0484 18.6866L92.9882 19.4373L94.2014 19.6437L93.9915 20.8854L95.0554 20.1347Z" fill="#E81F76"/>
    <path d="M67.1574 26.9874L67.3673 25.7456L66.1505 25.5393L65.0902 26.29L66.3071 26.4999L66.0971 27.7417L67.1574 26.9874Z" fill="#E81F76"/>
    <path d="M34.9896 8.54635L34.7619 7.30817L33.5486 7.53232L32.8121 8.60328L34.0254 8.37912L34.2531 9.61731L34.9896 8.54635Z" fill="#E81F76"/>
    <path d="M89.1813 24.383L89.0603 23.1306L87.8363 23.248L87.0073 24.2513L88.2348 24.1339L88.3558 25.3863L89.1813 24.383Z" fill="#E81F76"/>
    <path d="M55.0852 28.368L55.2275 27.1156L54 26.9804L52.986 27.7916L54.2099 27.9304L54.0747 29.1793L55.0852 28.368Z" fill="#E81F76"/>
    <path d="M57.7251 27.7951L57.8603 26.5462L56.6363 26.411L55.6223 27.2222L56.8463 27.3574L56.7075 28.6099L57.7251 27.7951Z" fill="#E81F76"/>
    <path d="M49.7196 11.158L49.8584 9.90559L48.6344 9.77039L47.6168 10.5852L48.8408 10.7204L48.7056 11.9728L49.7196 11.158Z" fill="#E81F76"/>
    <path d="M22.2765 9.39306L21.7286 8.25806L20.6185 8.79176L20.188 10.0193L21.2981 9.48557L21.846 10.6206L22.2765 9.39306Z" fill="#E81F76"/>
    <path d="M93.3977 16.3703L92.8036 15.2603L91.7148 15.8402L91.3376 17.0855L92.4264 16.502L93.017 17.6156L93.3977 16.3703Z" fill="#E81F76"/>
    <path d="M88.559 15.6161L87.9683 14.5025L86.8832 15.086L86.5024 16.3313L87.5912 15.7478L88.1818 16.8614L88.559 15.6161Z" fill="#E81F76"/>
    <path d="M85.748 25.0092L86.4596 23.9702L85.442 23.2729L84.1647 23.5148L85.1823 24.2122L84.4707 25.2511L85.748 25.0092Z" fill="#E81F76"/>
    <path d="M105 9.38241L104.772 8.14423L103.559 8.36838L102.823 9.43934L104.036 9.21518L104.264 10.4534L105 9.38241Z" fill="#E81F76"/>
    <path d="M90.6293 14.1964L91.6256 13.4208L90.8677 12.4495L89.5761 12.2858L90.334 13.2607L89.3413 14.0328L90.6293 14.1964Z" fill="#E81F76"/>
    <path d="M91.0708 23.2339L91.1384 21.9743L89.9074 21.9103L88.9396 22.7784L90.1706 22.8425L90.103 24.102L91.0708 23.2339Z" fill="#E81F76"/>
    <path d="M56.2163 18.8575L56.5437 17.6406L55.3517 17.3204L54.2274 17.968L55.4158 18.2882L55.0849 19.505L56.2163 18.8575Z" fill="#E81F76"/>
    <path d="M55.462 11.6845L55.0493 10.4926L53.8822 10.8982L53.3165 12.0688L54.4836 11.6632L54.8963 12.8551L55.462 11.6845Z" fill="#E81F76"/>
    <path d="M55.6683 14.1751L55.2556 12.9867L54.0921 13.3923L53.5228 14.5629L54.6899 14.1573L55.1026 15.3492L55.6683 14.1751Z" fill="#E81F76"/>
    <path d="M64.4851 28.1687L65.4244 27.329L64.6061 26.411L63.3074 26.3363L64.1293 27.2543L63.1864 28.094L64.4851 28.1687Z" fill="#E81F76"/>
    <path d="M59.5714 29.3465L60.5107 28.5068L59.6888 27.5888L58.3937 27.5141L59.212 28.4321L58.2692 29.2718L59.5714 29.3465Z" fill="#E81F76"/>
    <path d="M52.8116 11.7841L52.0715 10.7629L51.0717 11.4887L50.8689 12.7696L51.8687 12.0473L52.6052 13.0685L52.8116 11.7841Z" fill="#E81F76"/>
    <path d="M51.1358 12.446L50.3957 11.4248L49.3995 12.1471L49.1931 13.4315L50.1929 12.7093L50.9294 13.7304L51.1358 12.446Z" fill="#E81F76"/>
    <path d="M46.1545 11.3357L45.4179 10.3181L44.4182 11.0404L44.2118 12.3249L45.2116 11.6026L45.9481 12.6202L46.1545 11.3357Z" fill="#E81F76"/>
    <path d="M28.6344 10.3432L27.5919 9.6387L26.9016 10.6634L27.1542 11.9407L27.8409 10.916L28.887 11.6205L28.6344 10.3432Z" fill="#E81F76"/>
    <path d="M28.9515 6.40087L27.9055 5.69638L27.2152 6.72109L27.4678 7.99841L28.1545 6.97371L29.2041 7.67819L28.9515 6.40087Z" fill="#E81F76"/>
    <path d="M41.6679 8.51788L40.6219 7.81696L39.9316 8.84166L40.1843 10.119L40.8709 9.09428L41.917 9.7952L41.6679 8.51788Z" fill="#E81F76"/>
    <path d="M51.4736 27.3576L52.4129 26.5214L51.591 25.5999L50.2959 25.5252L51.1142 26.4467L50.1749 27.2864L51.4736 27.3576Z" fill="#E81F76"/>
    <path d="M76.2268 22.3408L75.0455 22.7748L75.4689 23.9312L76.6502 24.4791L76.2268 23.3192L77.408 22.8887L76.2268 22.3408Z" fill="#E81F76"/>
    <path d="M74.4193 21.2164L73.1597 21.2057L73.149 22.4368L74.0599 23.3654L74.0706 22.1308L75.3301 22.1415L74.4193 21.2164Z" fill="#E81F76"/>
    <path d="M72.2487 21.3801L70.9892 21.3658L70.9821 22.6005L71.8929 23.5255L71.9 22.2945L73.1631 22.3052L72.2487 21.3801Z" fill="#E81F76"/>
    <path d="M78.6105 23.554L77.351 23.5434L77.3403 24.778L78.2512 25.7031L78.2619 24.472L79.5214 24.4791L78.6105 23.554Z" fill="#E81F76"/>
    <path d="M73.0991 18.9178L71.8751 19.2167L72.1704 20.4158L73.2841 21.0882L72.9888 19.8892L74.2127 19.5903L73.0991 18.9178Z" fill="#E81F76"/>
    <path d="M70.5092 7.8598L69.2532 7.74594L69.1429 8.97345L69.9755 9.97325L70.0858 8.74218L71.3418 8.85604L70.5092 7.8598Z" fill="#E81F76"/>
    <path d="M69.5906 17.5268L68.3347 17.4129L68.2244 18.6404L69.0569 19.6402L69.1672 18.4127L70.4197 18.5266L69.5906 17.5268Z" fill="#E81F76"/>
    <path d="M67.7621 16.1035L66.5062 15.9896L66.3959 17.2171L67.2284 18.2169L67.3387 16.9894L68.5947 17.1033L67.7621 16.1035Z" fill="#E81F76"/>
    <path d="M66.7907 16.9824L65.5347 16.8686L65.4244 18.0961L66.257 19.0959L66.3673 17.8648L67.6233 17.9822L66.7907 16.9824Z" fill="#E81F76"/>
    <path d="M70.7796 19.6829L69.5236 19.569L69.4133 20.7965L70.2459 21.7963L70.3562 20.5688L71.6122 20.6827L70.7796 19.6829Z" fill="#E81F76"/>
    <path d="M68.2742 19.5156L67.0218 19.4017L66.908 20.6328L67.7441 21.629L67.8544 20.4015L69.1104 20.5154L68.2742 19.5156Z" fill="#E81F76"/>
    <path d="M68.4876 19.4517L67.2316 19.3343L67.1213 20.5653L67.9539 21.5616L68.0678 20.3341L69.3202 20.4515L68.4876 19.4517Z" fill="#E81F76"/>
    <path d="M64.0301 17.4057L62.7777 17.2919L62.6638 18.5194L63.4964 19.5192L63.6067 18.2917L64.8627 18.4055L64.0301 17.4057Z" fill="#E81F76"/>
    <path d="M62.3609 17.1674L61.1085 17.05L60.9982 18.281L61.8272 19.2773L61.941 18.0498L63.1935 18.1636L62.3609 17.1674Z" fill="#E81F76"/>
    <path d="M62.1228 19.4837L61.0198 20.0885L61.6104 21.1702L62.8593 21.5331L62.2686 20.4515L63.3716 19.8466L62.1228 19.4837Z" fill="#E81F76"/>
    <path d="M83.4531 14.9757L82.4213 14.2534L81.7133 15.2639L81.9374 16.5447L82.6455 15.5343L83.6773 16.2565L83.4531 14.9757Z" fill="#E81F76"/>
    <path d="M33.214 9.24373L32.1964 8.50366L31.4706 9.50346L31.6769 10.7879L32.4028 9.7881L33.4239 10.5282L33.214 9.24373Z" fill="#E81F76"/>
    <path d="M26.5356 14.5025L25.7813 13.4955L24.7922 14.2285L24.6036 15.5165L25.5928 14.78L26.3471 15.7905L26.5356 14.5025Z" fill="#E81F76"/>
    <path d="M58.6003 22.4831L58.1414 21.3125L56.9921 21.7643L56.4727 22.9563L57.6219 22.5044L58.0844 23.675L58.6003 22.4831Z" fill="#E81F76"/>
    <path d="M58.2126 19.8786L57.7536 18.7044L56.6044 19.1599L56.0885 20.3518L57.2342 19.8999L57.6967 21.0705L58.2126 19.8786Z" fill="#E81F76"/>
    <path d="M45.5319 14.6945L45.6885 13.4457L44.4645 13.2927L43.4398 14.0897L44.6638 14.2426L44.5037 15.4915L45.5319 14.6945Z" fill="#E81F76"/>
    <path d="M24.0021 14.3673L23.8918 13.1113L22.6643 13.2216L21.8281 14.2178L23.0556 14.1111L23.1659 15.3635L24.0021 14.3673Z" fill="#E81F76"/>
    <path d="M60.4504 22.4937L59.3474 23.1021L59.9416 24.1801L61.1905 24.5431L60.5963 23.4614L61.6992 22.8566L60.4504 22.4937Z" fill="#E81F76"/>
    <path d="M60.1091 20.1454L59.0061 20.7538L59.5967 21.8355L60.8456 22.1984L60.255 21.1167L61.3579 20.5083L60.1091 20.1454Z" fill="#E81F76"/>
    <path d="M63.813 23.3298L63.354 22.1556L62.2048 22.6111L61.6853 23.803L62.8345 23.3511L63.2971 24.5217L63.813 23.3298Z" fill="#E81F76"/>
    <path d="M59.6744 11.9442L59.2154 10.7736L58.0662 11.2255L57.5503 12.4174L58.696 11.9656L59.1585 13.1397L59.6744 11.9442Z" fill="#E81F76"/>
    <path d="M62.7204 25.639L62.2579 24.4649L61.1122 24.9167L60.5963 26.1122L61.742 25.6604L62.2045 26.8309L62.7204 25.639Z" fill="#E81F76"/>
    <path d="M63.4852 14.3353L63.0227 13.1612L61.877 13.613L61.3575 14.8085L62.5068 14.3567L62.9658 15.5272L63.4852 14.3353Z" fill="#E81F76"/>
    <path d="M65.0404 16.4878L64.5779 15.3172L63.4322 15.7691L62.9127 16.961L64.062 16.5092L64.5245 17.6833L65.0404 16.4878Z" fill="#E81F76"/>
    <path d="M72.9143 10.9516L72.4553 9.78101L71.3061 10.2329L70.7902 11.4248L71.9358 10.9694L72.3984 12.1435L72.9143 10.9516Z" fill="#E81F76"/>
    <path d="M60.0735 25.8525L59.6109 24.6819L58.4617 25.1338L57.9458 26.3257L59.095 25.8738L59.554 27.048L60.0735 25.8525Z" fill="#E81F76"/>
    <path d="M53.9216 9.50695L53.4591 8.33636L52.3099 8.78823L51.7939 9.98016L52.9396 9.5283L53.4022 10.7024L53.9216 9.50695Z" fill="#E81F76"/>
    <path d="M54.59 21.3943L55.1308 20.2558L54.0172 19.7292L52.7932 20.1633L53.9069 20.6934L53.366 21.8284L54.59 21.3943Z" fill="#E81F76"/>
    <path d="M43.9949 22.9954L44.5357 21.8569L43.4221 21.3267L42.1981 21.7644L43.3118 22.2945L42.771 23.4295L43.9949 22.9954Z" fill="#E81F76"/>
    <path d="M66.9794 22.0881L66.5168 20.9175L65.3711 21.3693L64.8517 22.5613L65.9974 22.1094L66.4599 23.28L66.9794 22.0881Z" fill="#E81F76"/>
    <path d="M62.443 12.1292L61.984 10.9586L60.8348 11.4105L60.3153 12.6024L61.4645 12.1506L61.9235 13.3212L62.443 12.1292Z" fill="#E81F76"/>
    <path d="M57.718 25.1693L57.8781 23.9205L56.6541 23.7639L55.6259 24.5645L56.8498 24.7175L56.6933 25.9663L57.718 25.1693Z" fill="#E81F76"/>
    <path d="M57.6465 11.4923L57.803 10.2435L56.579 10.0869L55.5508 10.8875L56.7747 11.0405L56.6182 12.2893L57.6465 11.4923Z" fill="#E81F76"/>
    <path d="M59.0272 8.00189L59.1873 6.75303L57.9633 6.60004L56.9351 7.39703L58.159 7.55003L58.0025 8.79888L59.0272 8.00189Z" fill="#E81F76"/>
    <path d="M44.8271 18.1921L44.9872 16.9397L43.7632 16.7867L42.735 17.5837L43.9589 17.7367L43.8024 18.9856L44.8271 18.1921Z" fill="#E81F76"/>
    <path d="M46.9688 16.8685L47.1254 15.6161L45.905 15.4631L44.8767 16.2601L46.1007 16.4167L45.9441 17.662L46.9688 16.8685Z" fill="#E81F76"/>
    <path d="M81.222 18.1352L81.3786 16.8863L80.1546 16.7298L79.1263 17.5268L80.3503 17.6833L80.1937 18.9358L81.222 18.1352Z" fill="#E81F76"/>
    <path d="M31.6947 12.5313L31.5844 11.2789L30.3569 11.3892L29.5208 12.3855L30.7518 12.2752L30.8621 13.5311L31.6947 12.5313Z" fill="#E81F76"/>
    <path d="M67.9508 21.2271L66.8478 21.8355L67.442 22.9135L68.6873 23.28L68.0966 22.1984L69.1996 21.5935L67.9508 21.2271Z" fill="#E81F76"/>
    <path d="M49.3959 7.35443L48.2893 7.95929L48.8835 9.04092L50.1323 9.40384L49.5382 8.32221L50.6447 7.71379L49.3959 7.35443Z" fill="#E81F76"/>
    <path d="M51.0218 5.92758L51.1819 4.67872L49.9579 4.52573L48.9297 5.31916L50.1536 5.47571L49.9935 6.72457L51.0218 5.92758Z" fill="#E81F76"/>
    <path d="M45.0127 9.2437L45.1692 7.99484L43.9488 7.83829L42.917 8.63528L44.1409 8.79183L43.9844 10.0407L45.0127 9.2437Z" fill="#E81F76"/>
    <path d="M46.9654 1.83593L47.9118 1.00336L47.0935 0.0782765L45.7984 0L46.6132 0.92508L45.6667 1.75765L46.9654 1.83593Z" fill="#E81F76"/>
    <path d="M66.8836 4.51511L65.9016 3.72879L65.1331 4.69301L65.2754 5.98457L66.0439 5.0239L67.0295 5.81022L66.8836 4.51511Z" fill="#E81F76"/>
    <path d="M56.8854 3.61138L56.6577 2.3732L55.4479 2.5938L54.7079 3.66475L55.9212 3.4406L56.1453 4.68234L56.8854 3.61138Z" fill="#E81F76"/>
    <path d="M56.131 5.90989L55.3198 4.94211L54.3769 5.73554L54.2595 7.03065L55.206 6.23722L56.0136 7.205L56.131 5.90989Z" fill="#E81F76"/>
    <path d="M53.4445 5.11645L53.2203 3.87827L52.007 4.09886L51.267 5.16982L52.4802 4.94923L52.7044 6.18741L53.4445 5.11645Z" fill="#E81F76"/>
    <path d="M68.1359 10.1902L67.9082 8.952L66.6984 9.17259L65.9584 10.2435L67.1681 10.0194L67.3958 11.2611L68.1359 10.1902Z" fill="#E81F76"/>
    <path d="M31.7018 5.40112L32.5415 4.46536L31.6235 3.64346L30.3248 3.71107L31.2392 4.53652L30.3995 5.47584L31.7018 5.40112Z" fill="#E81F76"/>
    <path d="M41.9737 4.79263L42.817 3.85332L41.899 3.02786L40.6003 3.09902L41.5183 3.92448L40.6751 4.86379L41.9737 4.79263Z" fill="#E81F76"/>
    <path d="M38.8748 5.15908L39.2946 3.97071L38.1276 3.56509L36.957 4.12726L38.1205 4.53643L37.7042 5.7248L38.8748 5.15908Z" fill="#E81F76"/>
    <path d="M43.9414 5.86361L45.1867 5.68215L45.0088 4.46176L43.9663 3.68256L44.1442 4.90295L42.8989 5.08797L43.9414 5.86361Z" fill="#E81F76"/>
    <path d="M48.0549 3.23424L49.1223 3.89959L49.7734 2.85353L49.4781 1.58688L48.8269 2.63649L47.756 1.96759L48.0549 3.23424Z" fill="#E81F76"/>
    <path d="M33.1182 3.88174L34.3635 4.09167L34.5663 2.87483L33.812 1.81454L33.6092 3.03138L32.3639 2.82146L33.1182 3.88174Z" fill="#E81F76"/>
    <path d="M99.0442 12.9653L100.016 12.1612L99.2328 11.2112L97.9377 11.0903L98.724 12.0403L97.7527 12.8408L99.0442 12.9653Z" fill="#E81F76"/>
    <path d="M98.0798 16.2494L99.0511 15.4488L98.2683 14.4988L96.9732 14.3743L97.7595 15.3243L96.7882 16.1284L98.0798 16.2494Z" fill="#E81F76"/>
    <path d="M62.8376 9.95888L63.8089 9.15834L63.0226 8.20479L61.7311 8.08026L62.5138 9.03381L61.5425 9.83436L62.8376 9.95888Z" fill="#E81F76"/>
    <path d="M45.4214 2.23087L45.6313 0.989129L44.4181 0.779205L43.3578 1.5335L44.5711 1.74342L44.3576 2.98161L45.4214 2.23087Z" fill="#E81F76"/>
    <path d="M103.837 13.3781L104.047 12.1364L102.833 11.93L101.773 12.6807L102.986 12.8907L102.776 14.1288L103.837 13.3781Z" fill="#E81F76"/>
    <path d="M100.645 7.38997L100.855 6.14823L99.6385 5.94186L98.5782 6.69616L99.7951 6.89897L99.5816 8.14427L100.645 7.38997Z" fill="#E81F76"/>
    <path d="M52.5553 2.83214L52.7653 1.5904L51.552 1.38403L50.4917 2.13477L51.705 2.34113L51.4951 3.58288L52.5553 2.83214Z" fill="#E81F76"/>
    <path d="M68.0932 7.58924L68.3067 6.34749L67.0934 6.13757L66.0295 6.88831L67.2464 7.09823L67.0329 8.33642L68.0932 7.58924Z" fill="#E81F76"/>
    <path d="M40.3583 2.85001L40.2373 1.5976L39.0098 1.71501L38.1843 2.71837L39.4118 2.60095L39.5328 3.85337L40.3583 2.85001Z" fill="#E81F76"/>
    <path d="M56.0243 8.9662L56.163 7.71379L54.9391 7.57858L53.925 8.39337L55.149 8.52857L55.0138 9.78098L56.0243 8.9662Z" fill="#E81F76"/>
    <path d="M58.6643 8.39696L58.7995 7.14454L57.5756 7.00934L56.5615 7.82412L57.7855 7.95932L57.6467 9.20818L58.6643 8.39696Z" fill="#E81F76"/>
    <path d="M36.925 3.47622L37.6331 2.43728L36.6155 1.74347L35.3381 1.98186L36.3557 2.67567L35.6477 3.71816L36.925 3.47622Z" fill="#E81F76"/>
    <path d="M47.5775 3.81424L47.3498 2.57605L46.1365 2.8002L45.4 3.87116L46.6133 3.64701L46.841 4.88519L47.5775 3.81424Z" fill="#E81F76"/>
    <path d="M42.244 1.70071L42.3116 0.44118L41.0841 0.377136L40.1128 1.24529L41.3474 1.31289L41.2798 2.56887L42.244 1.70071Z" fill="#E81F76"/>
    <path d="M65.4245 8.76691L66.3674 7.93078L65.5455 7.00926L64.2468 6.93454L65.0652 7.85606L64.1294 8.69219L65.4245 8.76691Z" fill="#E81F76"/>
    <path d="M60.5113 9.94459L61.4506 9.1049L60.6287 8.18693L59.3336 8.11221L60.152 9.03374L59.2091 9.86986L60.5113 9.94459Z" fill="#E81F76"/>
    <path d="M52.4128 7.95922L53.3521 7.11953L52.5302 6.19801L51.2315 6.12329L52.0535 7.04837L51.1141 7.8845L52.4128 7.95922Z" fill="#E81F76"/>
    <path d="M59.5397 3.08123L59.0771 1.91064L57.9315 2.36251L57.412 3.55444L58.5612 3.10613L59.0238 4.27672L59.5397 3.08123Z" fill="#E81F76"/>
    <path d="M61.3898 3.09195L60.2869 3.70037L60.8775 4.782L62.1264 5.14492L61.5357 4.06329L62.6387 3.45487L61.3898 3.09195Z" fill="#E81F76"/>
    <path d="M63.6597 6.23711L63.1971 5.06653L62.0514 5.51839L61.532 6.71033L62.6812 6.25846L63.1438 7.42904L63.6597 6.23711Z" fill="#E81F76"/>
    <path d="M61.0127 6.45431L60.5502 5.28372L59.4045 5.73203L58.885 6.92396L60.0307 6.47209L60.4932 7.64624L61.0127 6.45431Z" fill="#E81F76"/>
    <path d="M58.6575 5.77117L58.8176 4.51875L57.5901 4.36575L56.5654 5.16274L57.7894 5.31574L57.6328 6.56816L58.6575 5.77117Z" fill="#E81F76"/>
    <path d="M22.6006 31.7941C23.0204 32.3385 23.2268 32.9576 23.2268 33.655C23.2268 34.6832 22.8745 35.4909 22.1629 36.0709C21.4549 36.6508 20.4586 36.9426 19.1813 36.9426H13.2003V24.8596H18.9927C20.2274 24.8596 21.1952 25.1336 21.8961 25.6815C22.597 26.2294 22.9492 27.0015 22.9492 27.9942C22.9492 28.7022 22.7642 29.2964 22.3942 29.7696C22.0242 30.2464 21.5296 30.5666 20.9105 30.7374C21.6186 30.8975 22.1807 31.2498 22.597 31.7906L22.6006 31.7941ZM16.5591 29.6593H18.2562C19.0995 29.6593 19.5229 29.3107 19.5229 28.6133C19.5229 27.9159 19.0995 27.5352 18.2562 27.5352H16.5591V29.6593ZM19.7791 33.1746C19.7791 32.8082 19.6688 32.5306 19.4446 32.335C19.2205 32.1393 18.9038 32.0432 18.4946 32.0432H16.5555V34.2349H18.5089C19.3557 34.2349 19.7755 33.8827 19.7755 33.1746H19.7791Z" fill="white"/>
    <path d="M27.6461 24.8632V31.8725C27.6461 32.5236 27.7991 33.0252 28.1016 33.381C28.404 33.7368 28.863 33.9112 29.4821 33.9112C30.1012 33.9112 30.5637 33.7333 30.8768 33.3704C31.1935 33.011 31.35 32.5129 31.35 31.8725V24.8632H34.7088V31.8725C34.7088 32.979 34.474 33.9254 34.0043 34.7082C33.5346 35.4909 32.8978 36.0816 32.0936 36.4729C31.286 36.8679 30.3929 37.0636 29.4109 37.0636C28.4289 37.0636 27.5536 36.8679 26.7816 36.4729C26.0095 36.0816 25.4046 35.4945 24.9634 34.7153C24.5222 33.9396 24.3052 32.9897 24.3052 31.8725V24.8632H27.6461Z" fill="white"/>
    <path d="M37.6545 36.0638C36.7507 35.3949 36.2668 34.4378 36.1992 33.1925H39.7821C39.8142 33.6159 39.9422 33.9254 40.1593 34.114C40.3763 34.3097 40.6574 34.4093 40.999 34.4093C41.3085 34.4093 41.5611 34.331 41.7604 34.1745C41.9596 34.0215 42.0593 33.808 42.0593 33.5305C42.0593 33.1782 41.8956 32.9043 41.5611 32.7086C41.2302 32.5164 40.693 32.2994 39.9529 32.0575C39.163 31.7942 38.5262 31.5416 38.0423 31.2961C37.5584 31.0505 37.1314 30.6912 36.7721 30.2144C36.4127 29.7412 36.2313 29.1186 36.2313 28.3571C36.2313 27.5957 36.4269 26.9162 36.8148 26.3611C37.2026 25.8096 37.7398 25.3862 38.423 25.1016C39.1097 24.8134 39.8853 24.6711 40.7535 24.6711C42.1589 24.6711 43.2796 25.0019 44.1193 25.6566C44.959 26.3113 45.4073 27.2364 45.4643 28.4247H41.8138C41.8031 28.0583 41.6892 27.7843 41.4793 27.6028C41.2694 27.4214 40.9954 27.3289 40.6645 27.3289C40.4119 27.3289 40.2055 27.4036 40.0454 27.5495C39.8853 27.6989 39.8035 27.9088 39.8035 28.1828C39.8035 28.4105 39.8924 28.6062 40.0703 28.7734C40.2482 28.9371 40.4688 29.0794 40.7286 29.2004C40.9919 29.3214 41.3797 29.4708 41.892 29.6523C42.657 29.9155 43.2868 30.1753 43.7849 30.435C44.283 30.6912 44.71 31.0505 45.0693 31.5131C45.4287 31.9756 45.6101 32.5627 45.6101 33.2707C45.6101 33.9788 45.4287 34.637 45.0693 35.2063C44.71 35.7791 44.1905 36.2274 43.5074 36.5619C42.8278 36.8928 42.0272 37.0565 41.1022 37.0565C39.6967 37.0565 38.5404 36.722 37.6402 36.0567L37.6545 36.0638Z" fill="white"/>
    <path d="M50.542 24.8632V36.9462H47.1832V24.8632H50.542Z" fill="white"/>
    <path d="M63.9946 36.9462H60.6359L56.1634 30.1931V36.9462H52.8047V24.8632H56.1634L60.6359 31.7017V24.8632H63.9946V36.9462Z" fill="white"/>
    <path d="M69.6162 27.553V29.5242H73.4731V32.0788H69.6162V34.2563H73.989V36.9462H66.2574V24.8632H73.989V27.553H69.6162Z" fill="white"/>
    <path d="M77.0882 36.0638C76.188 35.3949 75.7005 34.4378 75.6329 33.1925H79.2123C79.2479 33.6159 79.3724 33.9254 79.5894 34.114C79.8065 34.3097 80.084 34.4093 80.4291 34.4093C80.7387 34.4093 80.9913 34.331 81.1905 34.1745C81.3898 34.0215 81.4894 33.808 81.4894 33.5305C81.4894 33.1782 81.3222 32.9043 80.9913 32.7086C80.6604 32.5164 80.1231 32.2994 79.3831 32.0575C78.5932 31.7942 77.9563 31.5416 77.4689 31.2961C76.985 31.0505 76.5616 30.6912 76.2022 30.2144C75.8429 29.7412 75.6614 29.1186 75.6614 28.3571C75.6614 27.5957 75.8535 26.9162 76.2449 26.3611C76.6327 25.8096 77.17 25.3862 77.8567 25.1016C78.5434 24.8134 79.319 24.6711 80.1872 24.6711C81.5926 24.6711 82.7169 25.0019 83.5566 25.6566C84.3963 26.3113 84.8446 27.2364 84.9015 28.4247H81.251C81.2404 28.0583 81.1265 27.7843 80.9166 27.6028C80.7031 27.4214 80.4327 27.3289 80.1018 27.3289C79.8492 27.3289 79.6464 27.4036 79.4862 27.5495C79.3261 27.6989 79.2443 27.9088 79.2443 28.1828C79.2443 28.4105 79.3333 28.6062 79.5112 28.7734C79.6891 28.9371 79.9097 29.0794 80.1694 29.2004C80.4327 29.3214 80.8205 29.4708 81.3329 29.6523C82.0978 29.9155 82.7312 30.1753 83.2293 30.435C83.7238 30.6912 84.1543 31.0505 84.5137 31.5131C84.8731 31.9756 85.051 32.5627 85.051 33.2707C85.051 33.9788 84.8695 34.637 84.5137 35.2063C84.1508 35.7791 83.6349 36.2274 82.9517 36.5619C82.2722 36.8928 81.4681 37.0565 80.543 37.0565C79.1376 37.0565 77.9848 36.722 77.081 36.0567L77.0882 36.0638Z" fill="white"/>
    <path d="M87.3705 36.0638C86.4703 35.3949 85.9829 34.4378 85.9153 33.1925H89.4982C89.5338 33.6159 89.6583 33.9254 89.8753 34.114C90.0959 34.3097 90.3735 34.4093 90.715 34.4093C91.0246 34.4093 91.2772 34.331 91.48 34.1745C91.6793 34.0215 91.7789 33.808 91.7789 33.5305C91.7789 33.1782 91.6117 32.9043 91.2808 32.7086C90.9499 32.5164 90.4126 32.2994 89.669 32.0575C88.8827 31.7942 88.2458 31.5416 87.7583 31.2961C87.2709 31.0505 86.851 30.6912 86.4881 30.2144C86.1288 29.7412 85.9509 29.1186 85.9509 28.3571C85.9509 27.5957 86.143 26.9162 86.5344 26.3611C86.9222 25.8096 87.4595 25.3862 88.1461 25.1016C88.8328 24.8134 89.6085 24.6711 90.4766 24.6711C91.8821 24.6711 93.0028 25.0019 93.8461 25.6566C94.6858 26.3113 95.1341 27.2364 95.191 28.4247H91.5405C91.5298 28.0583 91.416 27.7843 91.206 27.6028C90.9926 27.4214 90.7222 27.3289 90.3913 27.3289C90.1386 27.3289 89.9323 27.4036 89.7722 27.5495C89.612 27.6989 89.5338 27.9088 89.5338 28.1828C89.5338 28.4105 89.6227 28.6062 89.8006 28.7734C89.975 28.9371 90.1956 29.0794 90.4588 29.2004C90.7221 29.3214 91.11 29.4708 91.6259 29.6523C92.3909 29.9155 93.0242 30.1753 93.5187 30.435C94.0169 30.6912 94.4438 31.0505 94.8032 31.5131C95.1625 31.9756 95.3404 32.5627 95.3404 33.2707C95.3404 33.9788 95.159 34.637 94.8032 35.2063C94.4403 35.7791 93.9243 36.2274 93.2412 36.5619C92.5616 36.8928 91.7611 37.0565 90.836 37.0565C89.427 37.0565 88.2742 36.722 87.3741 36.0567L87.3705 36.0638Z" fill="white"/>
    <path d="M56.8141 41.1767L55.4977 39.8603H48.2216V42.5857H51.4736V52.1816H54.8964V42.5857H55.4016L56.8141 41.1767Z" fill="white"/>
    <path d="M58.8458 42.6034L60.2121 41.1766L58.8174 39.7819L56.5723 39.7783L57.967 41.1766L56.6007 42.5998L58.8458 42.6034Z" fill="white"/>
    <path d="M24.4083 52.153H20.982L16.4206 45.2648V52.153H12.9943V39.8281H16.4206L20.982 46.8018V39.8281H24.4083V52.153Z" fill="white"/>
    <path d="M29.7916 42.5749V44.5852H33.7232V47.1897H29.7916V49.4099H34.2498V52.1531H26.3652V39.8282H34.2498V42.5749H29.7916Z" fill="white"/>
    <path d="M43.6537 52.1531L41.2591 48.6734L39.2133 52.1531H35.3137L39.3165 45.8412L35.1714 39.8282H39.2097L41.5331 43.2189L43.5256 39.8282H47.4251L43.4758 46.0333L47.6884 52.1495H43.6501L43.6537 52.1531Z" fill="white"/>
  </svg>
);

/* ================================================================
   OKR Score Gauge — SVG donut with score in center
   ================================================================ */
const OKRScoreGauge = ({ score, size = 160 }) => {
  const strokeWidth = 12;
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  const clampedScore = Math.min(Math.max(score, 0), 100);
  const offset = circumference - (clampedScore / 100) * circumference;
  const color = clampedScore >= 75 ? '#10b981' : clampedScore >= 50 ? '#f59e0b' : '#ef4444';
  const label = clampedScore >= 75 ? 'Strong' : clampedScore >= 50 ? 'Moderate' : 'Needs Focus';

  return (
    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
      <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
        <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke="#2a2a4a" strokeWidth={strokeWidth} />
        <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke={color} strokeWidth={strokeWidth}
          strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round"
          transform={`rotate(-90 ${size / 2} ${size / 2})`}
          style={{ transition: 'stroke-dashoffset 1s ease-out, stroke 0.5s ease' }}
        />
        <text x={size / 2} y={size / 2 - 6} textAnchor="middle" dominantBaseline="central"
          fontSize="32" fontWeight="900" fill={color}>{clampedScore.toFixed(1)}</text>
        <text x={size / 2} y={size / 2 + 18} textAnchor="middle" dominantBaseline="central"
          fontSize="11" fontWeight="600" fill="#94a3b8">/ 100</text>
      </svg>
      <span style={{
        marginTop: 2, fontSize: 10, fontWeight: 700, textTransform: 'uppercase',
        letterSpacing: 1, color, background: `${color}18`, padding: '2px 8px', borderRadius: 20,
      }}>{label}</span>
    </div>
  );
};

/* ================================================================
   Metric Tile — compact clickable row for left sidebar
   ================================================================ */
const MetricTile = ({ label, achievement, weight, onClick, isCoverage, isRAG, ragValue, onRAGChange }) => {
  // RAG (Red/Amber/Green) metric: user-selectable buttons
  if (isRAG) {
    const ragColors = { red: '#ef4444', amber: '#f59e0b', green: '#10b981' };
    const ragLabels = { red: 'R', amber: 'A', green: 'G' };
    const currentColor = ragColors[ragValue] || ragColors.red;
    return (
      <div style={{
        display: 'flex', alignItems: 'center', gap: 8, padding: '5px 10px', borderRadius: 8,
        background: 'rgba(255,255,255,0.04)', transition: 'background 0.2s',
        borderLeft: `3px solid ${currentColor}`,
      }}>
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 3 }}>
            <span style={{ fontSize: 10.5, fontWeight: 600, color: '#cbd5e1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', flex: 1 }}>{label}</span>
            <div style={{ display: 'flex', gap: 3, marginLeft: 6 }}>
              {Object.entries(ragLabels).map(([val, lbl]) => (
                <button key={val} onClick={(e) => { e.stopPropagation(); onRAGChange && onRAGChange(val); }}
                  style={{
                    width: 18, height: 18, borderRadius: '50%', border: `2px solid ${ragColors[val]}`,
                    background: ragValue === val ? ragColors[val] : 'transparent',
                    color: ragValue === val ? '#fff' : ragColors[val],
                    fontSize: 8, fontWeight: 800, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',
                    padding: 0, lineHeight: 1, transition: 'all 0.2s',
                  }}>{lbl}</button>
              ))}
            </div>
          </div>
          <div style={{ fontSize: 8.5, color: '#64748b', marginTop: 1 }}>Wt: {weight}%</div>
        </div>
      </div>
    );
  }

  // Pipeline coverage: achievement is coverage/3 (fraction of 3x benchmark), display as %
  if (isCoverage) {
    const pctVal = Math.min(Math.max(achievement, 0) * 100, 100);
    const covColor = achievement >= 1 ? '#10b981' : achievement >= 0.33 ? '#f59e0b' : '#ef4444';
    return (
      <div onClick={onClick} style={{
        display: 'flex', alignItems: 'center', gap: 8, padding: '5px 10px', borderRadius: 8,
        cursor: onClick ? 'pointer' : 'default', background: 'rgba(255,255,255,0.04)', transition: 'background 0.2s',
        borderLeft: `3px solid ${covColor}`,
      }}
        onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.08)'; }}
        onMouseLeave={e => { e.currentTarget.style.background = 'rgba(255,255,255,0.04)'; }}
      >
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: 2 }}>
            <span style={{ fontSize: 10.5, fontWeight: 600, color: '#cbd5e1', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{label}</span>
            <span style={{ fontSize: 10.5, fontWeight: 800, color: covColor, marginLeft: 6, whiteSpace: 'nowrap' }}>{pctVal.toFixed(0)}%</span>
          </div>
          <div style={{ height: 3, background: '#2a2a4a', borderRadius: 2, overflow: 'hidden' }}>
            <div style={{ height: '100%', width: `${pctVal}%`, background: covColor, borderRadius: 2, transition: 'width 0.8s ease-out' }} />
          </div>
          <div style={{ fontSize: 8.5, color: '#64748b', marginTop: 1 }}>Wt: {weight}%</div>
        </div>
      </div>
    );
  }

  const pct = Math.min(Math.max(achievement, 0) * 100, 100);
  const color = achievement >= 0.80 ? (achievement >= 1.0 ? '#10b981' : '#f59e0b') : '#ef4444';
  return (
    <div onClick={onClick} style={{
      display: 'flex', alignItems: 'center', gap: 8, padding: '5px 10px', borderRadius: 8,
      cursor: onClick ? 'pointer' : 'default', background: 'rgba(255,255,255,0.04)', transition: 'background 0.2s',
      borderLeft: `3px solid ${color}`,
    }}
      onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.08)'; }}
      onMouseLeave={e => { e.currentTarget.style.background = 'rgba(255,255,255,0.04)'; }}
    >
      <div style={{ flex: 1, minWidth: 0 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: 2 }}>
          <span style={{ fontSize: 10.5, fontWeight: 600, color: '#cbd5e1', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{label}</span>
          <span style={{ fontSize: 10.5, fontWeight: 800, color, marginLeft: 6, whiteSpace: 'nowrap' }}>{(achievement * 100).toFixed(0)}%</span>
        </div>
        <div style={{ height: 3, background: '#2a2a4a', borderRadius: 2, overflow: 'hidden' }}>
          <div style={{ height: '100%', width: `${pct}%`, background: color, borderRadius: 2, transition: 'width 0.8s ease-out' }} />
        </div>
        <div style={{ fontSize: 8.5, color: '#64748b', marginTop: 1 }}>Wt: {weight}%</div>
      </div>
    </div>
  );
};

/* ================================================================
   Compact Metric Summary Card (for right grid — all metrics)
   ================================================================ */
const MetricSummaryCard = ({ title, value, target, unit, achievement, color, onClick, children, weight, animIndex }) => {
  const hasAchievement = achievement != null;
  const pctColor = hasAchievement ? getAchievementColor(achievement) : '#0ea5e9';
  const isCritical = hasAchievement && achievement < 0.6;
  const isWarning = hasAchievement && achievement >= 0.6 && achievement < 0.8;
  const alertBorder = isCritical ? '#ef4444' : isWarning ? '#f59e0b' : '#f1f5f9';
  const alertShadow = isCritical ? '0 1px 8px rgba(239,68,68,0.12)' : isWarning ? '0 1px 6px rgba(245,158,11,0.1)' : '0 1px 3px rgba(0,0,0,0.06)';
  const animStyle = animIndex != null ? { animation: `cardStaggerIn 0.45s ease-out ${animIndex * 0.06}s both` } : {};
  return (
    <div className="metric-summary-card" onClick={onClick} style={{
      background: '#fff', borderRadius: 10, padding: '10px 12px', cursor: onClick ? 'pointer' : 'default',
      boxShadow: alertShadow, transition: 'all 0.2s',
      display: 'flex', flexDirection: 'column', height: '100%',
      border: `1px solid ${alertBorder}`, position: 'relative', overflow: 'hidden',
      ...animStyle,
    }}
      onMouseEnter={e => { e.currentTarget.style.boxShadow = '0 4px 16px rgba(232,31,118,0.12)'; e.currentTarget.style.borderColor = '#E81F76'; }}
      onMouseLeave={e => { e.currentTarget.style.boxShadow = alertShadow; e.currentTarget.style.borderColor = alertBorder; }}
    >
      <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: 3, background: color || '#E81F76' }} />
      {isCritical && (
        <div className="alert-pulse-dot" style={{
          position: 'absolute', top: 6, right: 8, width: 7, height: 7, borderRadius: '50%',
          background: '#ef4444', animation: 'alertPulse 2s infinite',
        }} />
      )}
      {isWarning && (
        <div style={{
          position: 'absolute', top: 6, right: 8, width: 7, height: 7, borderRadius: '50%',
          background: '#f59e0b', opacity: 0.7,
        }} />
      )}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4, marginTop: 2 }}>
        <span style={{ fontSize: 10, fontWeight: 700, textTransform: 'uppercase', letterSpacing: 0.5, color: '#64748b' }}>{title}</span>
        {hasAchievement && <span style={{
          fontSize: 10, fontWeight: 700, color: pctColor,
          background: pctColor + '18', padding: '1px 6px', borderRadius: 10,
        }}>{(achievement * 100).toFixed(0)}%</span>}
      </div>
      <div style={{ display: 'flex', alignItems: 'baseline', gap: 4, marginBottom: 4 }}>
        <span style={{ fontSize: 16, fontWeight: 800, color: '#1e293b' }}>{value}</span>
        {target != null && <span style={{ fontSize: 9, color: '#94a3b8' }}>/ {target} {unit}</span>}
      </div>
      {children && <div className="metric-chart-area" style={{ flex: 1, minHeight: 80 }}>{children}</div>}
      {weight != null && (
        <div style={{ textAlign: 'right', fontSize: 8, color: '#94a3b8', fontWeight: 600, marginTop: 2 }}>Wt: {weight}%</div>
      )}
    </div>
  );
};

/* ================================================================
   BSC Section Headers (collapsible)
   ================================================================ */
const SectionHeader = ({ label, icon, isCollapsed, onToggle, metricCount, sectionWeight, sectionAchieved }) => {
  const achPct = sectionWeight > 0 ? (sectionAchieved / sectionWeight) * 100 : 0;
  const achColor = achPct >= 100 ? '#10b981' : achPct >= 80 ? '#f59e0b' : '#ef4444';
  return (
  <div onClick={onToggle} style={{
    display: 'flex', alignItems: 'center', gap: 10,
    padding: '8px 14px', borderRadius: 8, cursor: 'pointer',
    background: isCollapsed ? 'linear-gradient(135deg, #e2e8f0, #cbd5e1)' : 'linear-gradient(135deg, #1e293b, #334155)',
    border: isCollapsed ? '1px solid #cbd5e1' : '1px solid #475569',
    marginBottom: 6, transition: 'all 0.2s', userSelect: 'none',
    boxShadow: isCollapsed ? 'none' : '0 2px 6px rgba(30,41,59,0.15)',
    animation: 'fadeIn 0.4s ease-out',
  }}
    onMouseEnter={e => { e.currentTarget.style.opacity = '0.9'; }}
    onMouseLeave={e => { e.currentTarget.style.opacity = '1'; }}
  >
    <span style={{ fontSize: 15 }}>{icon}</span>
    <span style={{ fontSize: 13, fontWeight: 800, color: isCollapsed ? '#1e293b' : '#fff', flex: 1, letterSpacing: 0.3 }}>{label}</span>
    {sectionWeight != null && (
      <span style={{
        fontSize: 10, fontWeight: 700,
        color: isCollapsed ? achColor : achColor,
        background: isCollapsed ? `${achColor}15` : `${achColor}20`,
        padding: '2px 8px', borderRadius: 10,
      }}>{(sectionAchieved || 0).toFixed(1)} / {sectionWeight}%</span>
    )}
    <span style={{ fontSize: 10, color: isCollapsed ? '#94a3b8' : '#64748b', fontWeight: 600 }}>{metricCount}</span>
    <span style={{
      fontSize: 10, color: isCollapsed ? '#64748b' : '#94a3b8', transition: 'transform 0.25s',
      transform: isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)', lineHeight: 1,
    }}>▼</span>
  </div>
  );
};

const SidebarSectionHeader = ({ label, isCollapsed, onToggle }) => (
  <div onClick={onToggle} style={{
    display: 'flex', alignItems: 'center', justifyContent: 'space-between',
    padding: '4px 10px', borderRadius: 6, cursor: 'pointer',
    background: isCollapsed ? 'rgba(232, 31, 118, 0.15)' : 'rgba(232, 31, 118, 0.08)',
    marginBottom: 3, marginTop: 6, userSelect: 'none', transition: 'all 0.2s',
  }}
    onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232, 31, 118, 0.18)'; }}
    onMouseLeave={e => { e.currentTarget.style.background = isCollapsed ? 'rgba(232, 31, 118, 0.15)' : 'rgba(232, 31, 118, 0.08)'; }}
  >
    <span style={{ fontSize: 9, fontWeight: 700, color: '#E81F76', textTransform: 'uppercase', letterSpacing: 0.8 }}>{label}</span>
    <span style={{
      fontSize: 9, color: '#94a3b8', transition: 'transform 0.25s',
      transform: isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)', lineHeight: 1,
    }}>▼</span>
  </div>
);

const RAGMetricCard = ({ label, ragValue, achievement, weight, onRAGChange, animIndex }) => {
  const ragColors = { red: '#ef4444', amber: '#f59e0b', green: '#10b981' };
  const ragLabels = { red: 'Red', amber: 'Amber', green: 'Green' };
  const ragBg = { red: 'rgba(239,68,68,0.06)', amber: 'rgba(245,158,11,0.06)', green: 'rgba(16,185,129,0.06)' };
  const val = ragValue || 'red';
  const currentColor = ragColors[val];
  const currentLabel = ragLabels[val];
  const pctValue = achievement != null ? (achievement * 100).toFixed(0) : '0';
  const isCritical = val === 'red';
  const animStyle = animIndex != null ? { animation: `cardStaggerIn 0.45s ease-out ${animIndex * 0.06}s both` } : {};

  return (
    <div style={{
      background: ragBg[val], borderRadius: 10, padding: '10px 12px',
      boxShadow: isCritical ? '0 1px 8px rgba(239,68,68,0.12)' : '0 1px 3px rgba(0,0,0,0.06)', transition: 'all 0.3s',
      display: 'flex', flexDirection: 'column', border: `1px solid ${isCritical ? '#ef4444' : currentColor + '30'}`,
      position: 'relative', overflow: 'hidden', ...animStyle,
    }}>
      {isCritical && (
        <div className="alert-pulse-dot" style={{
          position: 'absolute', top: 6, right: 8, width: 7, height: 7, borderRadius: '50%',
          background: '#ef4444', animation: 'alertPulse 2s infinite',
        }} />
      )}
      <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: 3, background: currentColor }} />
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4, marginTop: 2 }}>
        <span style={{ fontSize: 9, fontWeight: 700, textTransform: 'uppercase', letterSpacing: 0.5, color: '#64748b', maxWidth: '70%' }}>{label}</span>
        <span style={{
          fontSize: 10, fontWeight: 700, color: currentColor,
          background: `${currentColor}18`, padding: '1px 6px', borderRadius: 10,
        }}>{pctValue}%</span>
      </div>
      <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: 8, padding: '8px 0' }}>
        <div style={{
          width: 52, height: 52, borderRadius: '50%', background: currentColor,
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          boxShadow: `0 4px 16px ${currentColor}40`, transition: 'all 0.3s',
        }}>
          <span style={{ fontSize: 13, fontWeight: 900, color: '#fff' }}>{currentLabel}</span>
        </div>
        <div style={{ display: 'flex', gap: 5 }}>
          {Object.entries(ragLabels).map(([v, lbl]) => (
            <button key={v} onClick={() => onRAGChange(v)} style={{
              padding: '2px 9px', borderRadius: 12, fontSize: 9, fontWeight: 700,
              border: `1.5px solid ${ragColors[v]}`, cursor: 'pointer', transition: 'all 0.2s',
              background: val === v ? ragColors[v] : 'transparent',
              color: val === v ? '#fff' : ragColors[v],
            }}>{lbl}</button>
          ))}
        </div>
      </div>
      <div style={{ fontSize: 8, color: '#94a3b8', textAlign: 'center' }}>Wt: {weight}%</div>
    </div>
  );
};

/* ================================================================
   Compact Legend for mini-charts (inline dots + labels)
   ================================================================ */
const MiniLegend = ({ items }) => (
  <div className="mini-legend" style={{ display: 'flex', flexDirection: 'column', gap: 3, justifyContent: 'center', paddingLeft: 4 }}>
    {items.map(({ color, label }) => (
      <span key={label} style={{ display: 'flex', alignItems: 'center', gap: 3, fontSize: 7.5, color: '#94a3b8', fontWeight: 600, whiteSpace: 'nowrap' }}>
        <span style={{ width: 5, height: 5, borderRadius: '50%', background: color, flexShrink: 0 }} />
        {label}
      </span>
    ))}
  </div>
);

/* ================================================================
   Custom Bar Label — small value on top of each bar
   ================================================================ */
const BarLabel = ({ x, y, width, value, fill }) => {
  if (value === 0 || value === null || value === undefined) return null;
  const displayVal = typeof value === 'number'
    ? (Math.abs(value) >= 100 ? Math.round(value) : Number(value).toFixed(1))
    : value;
  return (
    <text x={x + width / 2} y={y - 3} textAnchor="middle" fontSize={7} fontWeight="700"
      fill={fill || '#64748b'}>{displayVal}</text>
  );
};

/* ================================================================
   Mini Gauge — semi-circle progress for single-value metrics
   ================================================================ */
const MiniGauge = ({ value, target, label, color, format = 'percent' }) => {
  const pct = target !== 0 ? Math.min(Math.max(value / target, 0), 1.5) : 0;
  const displayPct = Math.min(pct, 1.0); // clamp arc to 100%
  const size = 120;
  const strokeWidth = 10;
  const radius = (size - strokeWidth) / 2;
  // Semi-circle: half circumference
  const halfCirc = Math.PI * radius;
  const offset = halfCirc - displayPct * halfCirc;

  const formatVal = format === 'percent'
    ? `${(value * 100).toFixed(0)}%`
    : value;
  const targetVal = format === 'percent' ? `${(target * 100).toFixed(0)}%` : target;

  return (
    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', height: '100%', justifyContent: 'center' }}>
      <svg width={size} height={size / 2 + 16} viewBox={`0 0 ${size} ${size / 2 + 16}`}>
        {/* Background arc */}
        <path
          d={`M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`}
          fill="none" stroke="#e2e8f0" strokeWidth={strokeWidth} strokeLinecap="round"
        />
        {/* Filled arc */}
        <path
          d={`M ${strokeWidth / 2} ${size / 2} A ${radius} ${radius} 0 0 1 ${size - strokeWidth / 2} ${size / 2}`}
          fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round"
          strokeDasharray={halfCirc} strokeDashoffset={offset}
          style={{ transition: 'stroke-dashoffset 1s ease-out' }}
        />
        {/* Center value */}
        <text x={size / 2} y={size / 2 - 4} textAnchor="middle" dominantBaseline="auto"
          fontSize="22" fontWeight="800" fill={color}>{formatVal}</text>
        {/* 0% and 100% labels at arc ends */}
        <text x={strokeWidth / 2 + 2} y={size / 2 + 12} textAnchor="start" fontSize="7" fill="#94a3b8">0%</text>
        <text x={size - strokeWidth / 2 - 2} y={size / 2 + 12} textAnchor="end" fontSize="7" fill="#94a3b8">100%</text>
      </svg>
      <div style={{ display: 'flex', gap: 8, marginTop: 0, fontSize: 9, color: '#94a3b8', fontWeight: 600 }}>
        <span>Target: <span style={{ color: '#475569', fontWeight: 700 }}>{targetVal}</span></span>
      </div>
    </div>
  );
};

/* ================================================================
   On-Time Score Calculator (Simple Average Logic)

   Logic: For each month with achievement data, compute:
     monthly % = achievement / target
   Then the final score = mean of all monthly %s.
   Months with blank/null achievement are excluded entirely.
   ================================================================ */
function computeTimelinessScore(monthlyData) {
  const withData = monthlyData.filter(d => d.achievement !== null && d.achievement !== undefined);
  if (withData.length === 0) return { score: 0, monthlyScores: [] };

  const monthlyScores = withData.map(d => {
    const pct = d.target > 0 ? d.achievement / d.target : 0;
    return {
      month: d.month,
      target: d.target,
      achievement: d.achievement,
      onTimeScore: pct,
    };
  });

  const avgScore = monthlyScores.reduce((s, m) => s + m.onTimeScore, 0) / monthlyScores.length;
  return { score: avgScore, monthlyScores };
}

/* ================================================================
   Key Takeaways Generator
   ================================================================ */
function generateTakeaways(annualMetrics, billingTotals, collectionTotals, billingTimeliness, collectionTimeliness, quarterlyQBRs, quarterlyHeroStories, quarterlyNewLogos, newLogosTotals) {
  const takeaways = [];

  // ARR
  if (annualMetrics?.arr) {
    const arrPct = annualMetrics.arr.achievementTillDate / annualMetrics.arr.targetFY26;
    if (arrPct < 0.5) takeaways.push({ type: 'alert', text: `ARR at ${(arrPct * 100).toFixed(0)}% of target — needs urgent attention to reach ${formatCrore(annualMetrics.arr.targetFY26, 1)}` });
    else if (arrPct >= 0.8) takeaways.push({ type: 'good', text: `ARR tracking well at ${(arrPct * 100).toFixed(0)}% of target` });
  }

  // Service Revenue (KAM only)
  if (annualMetrics?.serviceRev) {
    const srvPct = annualMetrics.serviceRev.achievementTillDate / annualMetrics.serviceRev.targetFY26;
    if (srvPct >= 0.9) takeaways.push({ type: 'good', text: `Service Revenue strong at ${(srvPct * 100).toFixed(0)}% (${formatCrore(annualMetrics.serviceRev.achievementTillDate, 0)} of ${formatCrore(annualMetrics.serviceRev.targetFY26, 0)})` });
    else if (srvPct < 0.7) takeaways.push({ type: 'alert', text: `Service Revenue behind at ${(srvPct * 100).toFixed(0)}% — gap of ${formatCrore(annualMetrics.serviceRev.targetFY26 - annualMetrics.serviceRev.achievementTillDate, 0)}` });
  }

  // NPS (improvement-based)
  if (annualMetrics?.nps) {
    const npsBase = annualMetrics.nps.baseline ?? 0;
    const npsImpr = annualMetrics.nps.achievementTillDate - npsBase;
    const npsNeeded = annualMetrics.nps.targetFY26 - npsBase;
    const npsPctDone = npsNeeded !== 0 ? (npsImpr / npsNeeded) * 100 : 0;
    if (npsPctDone >= 100) takeaways.push({ type: 'good', text: `NPS target achieved! Improved from ${npsBase} to ${annualMetrics.nps.achievementTillDate} (target: +${annualMetrics.nps.targetFY26})` });
    else if (npsPctDone >= 50) takeaways.push({ type: 'alert', text: `NPS improving (${npsBase} \u2192 ${annualMetrics.nps.achievementTillDate}) but ${Math.round(annualMetrics.nps.targetFY26 - annualMetrics.nps.achievementTillDate)} pts still needed to hit +${annualMetrics.nps.targetFY26}` });
    else takeaways.push({ type: 'alert', text: `NPS improvement slow (${npsBase} \u2192 ${annualMetrics.nps.achievementTillDate}, only ${npsPctDone.toFixed(0)}% of needed improvement) \u2014 needs acceleration` });
  }

  // Billing timeliness
  if (billingTimeliness < 0.6) takeaways.push({ type: 'alert', text: `Billing score is ${(billingTimeliness * 100).toFixed(0)}% — billing achievement is significantly below targets` });
  else if (billingTimeliness >= 0.8) takeaways.push({ type: 'good', text: `Billing on track with ${(billingTimeliness * 100).toFixed(0)}% average achievement vs target` });

  // Collection timeliness
  if (collectionTimeliness < 0.6) takeaways.push({ type: 'alert', text: `Collection score is ${(collectionTimeliness * 100).toFixed(0)}% — collection achievement is significantly below targets` });
  else if (collectionTimeliness >= 0.8) takeaways.push({ type: 'good', text: `Collections on track with ${(collectionTimeliness * 100).toFixed(0)}% average achievement vs target` });

  // NDR / GDR (KAM only)
  if (annualMetrics?.ndr) {
    if (annualMetrics.ndr.achievementTillDate < annualMetrics.ndr.targetFY26) takeaways.push({ type: 'warn', text: `NDR at ${(annualMetrics.ndr.achievementTillDate * 100).toFixed(0)}% vs target ${(annualMetrics.ndr.targetFY26 * 100).toFixed(0)}% — net revenue retention falling short` });
  }
  if (annualMetrics?.gdr) {
    if (annualMetrics.gdr.achievementTillDate < annualMetrics.gdr.targetFY26) takeaways.push({ type: 'warn', text: `GDR at ${(annualMetrics.gdr.achievementTillDate * 100).toFixed(0)}% vs target ${(annualMetrics.gdr.targetFY26 * 100).toFixed(0)}% — higher churn than expected` });
  }

  // QBR
  if (quarterlyQBRs && quarterlyQBRs.length > 0) {
    const qbrPct = quarterlyQBRs.reduce((s, q) => s + q.achievement, 0) / quarterlyQBRs.reduce((s, q) => s + q.target, 0);
    if (qbrPct < 0.8) takeaways.push({ type: 'warn', text: `Only ${(qbrPct * 100).toFixed(0)}% of planned QBRs completed — risking customer engagement` });
  }

  // New Logos (Sales)
  if (newLogosTotals && newLogosTotals.totalTarget > 0) {
    const nlPct = newLogosTotals.achievementPercentage;
    if (nlPct < 0.5) takeaways.push({ type: 'alert', text: `New Logos at ${(nlPct * 100).toFixed(0)}% — only ${newLogosTotals.totalAchievement} of ${newLogosTotals.totalTarget} target logos acquired` });
    else if (nlPct >= 0.8) takeaways.push({ type: 'good', text: `New Logos on track at ${(nlPct * 100).toFixed(0)}% (${newLogosTotals.totalAchievement}/${newLogosTotals.totalTarget})` });
  }

  // Sales Capacity Achievement
  if (annualMetrics?.salesCapacity) {
    const scPct = annualMetrics.salesCapacity.achievementTillDate / annualMetrics.salesCapacity.targetFY26;
    if (scPct >= 0.9) takeaways.push({ type: 'good', text: `Sales Capacity Achievement strong at ${(scPct * 100).toFixed(0)}%` });
    else if (scPct < 0.7) takeaways.push({ type: 'warn', text: `Sales Capacity at ${(scPct * 100).toFixed(0)}% — ${annualMetrics.salesCapacity.achievementTillDate} of ${annualMetrics.salesCapacity.targetFY26} target` });
  }

  return takeaways;
}

/* ================================================================
   Key Takeaways Modal
   ================================================================ */
const KeyTakeawaysModal = ({ takeaways, onClose }) => {
  if (!takeaways) return null;
  const icons = { good: '✅', alert: '🚨', warn: '⚠️' };
  const colors = { good: '#10b981', alert: '#ef4444', warn: '#f59e0b' };
  const bgColors = { good: '#f0fdf4', alert: '#fef2f2', warn: '#fffbeb' };
  return (
    <div onClick={onClose} style={{
      position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
      background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(6px)',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      zIndex: 9999, animation: 'fadeIn 0.2s ease',
    }}>
      <div onClick={e => e.stopPropagation()} style={{
        background: '#fff', borderRadius: 16, padding: 28,
        width: '90vw', maxWidth: 700, maxHeight: '85vh', overflowY: 'auto',
        position: 'relative', animation: 'slideUp 0.3s ease',
        boxShadow: '0 24px 48px rgba(0,0,0,0.2)',
      }}>
        <button onClick={onClose} style={{
          position: 'absolute', top: 14, right: 14, width: 34, height: 34, borderRadius: 8,
          border: '1px solid #e2e8f0', background: '#fff', fontSize: 16, cursor: 'pointer',
          display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#64748b',
        }}>✕</button>
        <h3 style={{ fontSize: 20, fontWeight: 700, color: '#1a1a2e', marginBottom: 4 }}>📋 Key Takeaways</h3>
        <p style={{ fontSize: 13, color: '#94a3b8', marginBottom: 20 }}>Auto-generated insights from your OKR data</p>
        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
          {takeaways.map((t, i) => (
            <div key={i} style={{
              display: 'flex', gap: 10, padding: '12px 14px', borderRadius: 10,
              background: bgColors[t.type], border: `1px solid ${colors[t.type]}30`,
            }}>
              <span style={{ fontSize: 18, flexShrink: 0 }}>{icons[t.type]}</span>
              <span style={{ fontSize: 13, color: '#1e293b', lineHeight: 1.5 }}>{t.text}</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

/* ================================================================
   Balanced Scorecard Modal — dynamic table from live data
   ================================================================ */
const BalancedScorecardModal = ({ onClose, annualMetrics, billingTotals, collectionTotals,
  quarterlyQBRs, quarterlyHeroStories, quarterlyNewLogos, newLogosTotals, quarterlyARR, quarterlyServiceRev,
  weightages, metricAchievements, billingTimeliness, collectionTimeliness, okrScore, selectedFY, selectedFunction, pipelineCoverage, ragMetrics }) => {

  const fmt = (v, type) => {
    if (type === 'cr') return `₹${Number(v).toFixed(1)} Cr`;
    if (type === 'pct') return `${(v * 100).toFixed(0)}%`;
    if (type === 'num') return String(Math.round(v));
    if (type === 'score') return `${(v * 100).toFixed(0)}%`;
    return String(v);
  };

  // Computed totals
  const arrTarget = (quarterlyARR || []).reduce((s, q) => s + (q.target || 0), 0);
  const arrAch = (quarterlyARR || []).reduce((s, q) => s + (q.achievement || 0), 0);
  const srvTarget = (quarterlyServiceRev || []).reduce((s, q) => s + (q.target || 0), 0);
  const srvAch = (quarterlyServiceRev || []).reduce((s, q) => s + (q.achievement || 0), 0);
  const billingTarget = billingTotals?.totalTarget || 0;
  const billingAch = billingTotals?.totalAchievement || 0;
  const collTarget = collectionTotals?.totalTarget || 0;
  const collAch = collectionTotals?.totalAchievement || 0;
  const qbrAchTotal = (quarterlyQBRs || []).reduce((s, q) => s + q.achievement, 0);
  const qbrTarTotal = (quarterlyQBRs || []).reduce((s, q) => s + q.target, 0);
  const heroAchTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.achievement, 0);
  const heroTarTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.target, 0);
  const nlAchTotal = newLogosTotals?.totalAchievement || 0;
  const nlTarTotal = newLogosTotals?.totalTarget || 0;

  // Build rows dynamically from weightages
  const allRowDefs = {
    arr: { label: 'Annual Recurring Revenue (ARR)', target: fmt(arrTarget, 'cr'), achievement: fmt(arrAch, 'cr'), pct: metricAchievements.arr },
    serviceRev: { label: 'Service Revenue', target: fmt(srvTarget, 'cr'), achievement: fmt(srvAch, 'cr'), pct: metricAchievements.serviceRev },
    billing: { label: 'On-Time Billing', target: fmt(billingTarget, 'cr'), achievement: fmt(billingAch, 'cr'), pct: billingTimeliness },
    collection: { label: 'On-Time Collection', target: fmt(collTarget, 'cr'), achievement: fmt(collAch, 'cr'), pct: collectionTimeliness },
    ndr: { label: 'Net Dollar Retention (NDR)', target: `${((annualMetrics?.ndr?.targetFY26 || 0) * 100).toFixed(0)}%`, achievement: `${((annualMetrics?.ndr?.achievementTillDate || 0) * 100).toFixed(0)}%`, pct: metricAchievements.ndr },
    gdr: { label: 'Gross Dollar Retention (GDR)', target: `${((annualMetrics?.gdr?.targetFY26 || 0) * 100).toFixed(0)}%`, achievement: `${((annualMetrics?.gdr?.achievementTillDate || 0) * 100).toFixed(0)}%`, pct: metricAchievements.gdr },
    nps: { label: 'NPS Score (Improvement)', target: `${Math.round(annualMetrics?.nps?.baseline ?? 0)} \u2192 ${Math.round(annualMetrics?.nps?.targetFY26 || 0)}`, achievement: String(Math.round(annualMetrics?.nps?.achievementTillDate || 0)), pct: metricAchievements.nps },
    qbr: { label: 'QBRs Held', target: String(Math.round(qbrTarTotal)), achievement: String(Math.round(qbrAchTotal)), pct: metricAchievements.qbr },
    heroStories: { label: 'Hero Stories', target: String(Math.round(heroTarTotal)), achievement: String(Math.round(heroAchTotal)), pct: metricAchievements.heroStories },
    pipelineCoverage: { label: 'Pipeline Coverage', target: '3x', achievement: `${(pipelineCoverage?.coverage || 0).toFixed(1)}x`, pct: metricAchievements.pipelineCoverage, isCoverage: true },
    newLogos: { label: '# of New Logos', target: String(Math.round(nlTarTotal)), achievement: String(Math.round(nlAchTotal)), pct: metricAchievements.newLogos },
    salesCapacity: { label: 'Sales Capacity Achievement', target: String(Math.round(annualMetrics?.salesCapacity?.targetFY26 || 0)), achievement: String(Math.round(annualMetrics?.salesCapacity?.achievementTillDate || 0)), pct: metricAchievements.salesCapacity },
    capabilityAI: { label: 'Capability Development in AI', target: 'Green', achievement: ragMetrics?.capabilityAI || 'red', pct: metricAchievements.capabilityAI, isRAG: true },
    accountStrategy: { label: selectedFunction === 'SALES' ? 'Account Coverage Strategy' : 'Published Account Strategy', target: 'Green', achievement: ragMetrics?.accountStrategy || 'red', pct: metricAchievements.accountStrategy, isRAG: true },
    archDomain: { label: 'Architecture & Domain Knowledge', target: 'Green', achievement: ragMetrics?.archDomain || 'red', pct: metricAchievements.archDomain, isRAG: true },
  };

  const rows = Object.keys(weightages)
    .filter(key => allRowDefs[key])
    .map(key => ({ key, ...allRowDefs[key] }))
    .sort((a, b) => (weightages[b.key]?.weight || 0) - (weightages[a.key]?.weight || 0));

  const totalWeight = rows.reduce((s, r) => s + (weightages[r.key]?.weight || 0), 0);

  // BSC section groupings for the scorecard table
  const scorecardSections = selectedFunction === 'SALES' ? [
    { label: 'Financial', icon: '💰', metrics: ['arr', 'billing', 'collection', 'newLogos'] },
    { label: 'Customer', icon: '🤝', metrics: ['nps'] },
    { label: 'Internal Process', icon: '⚙️', metrics: ['pipelineCoverage', 'accountStrategy', 'qbr', 'salesCapacity'] },
    { label: 'Learning & Growth', icon: '📚', metrics: ['capabilityAI', 'archDomain'] },
  ] : [
    { label: 'Financial', icon: '💰', metrics: ['arr', 'serviceRev', 'ndr', 'gdr', 'billing', 'collection'] },
    { label: 'Customer', icon: '🤝', metrics: ['nps'] },
    { label: 'Internal Process', icon: '⚙️', metrics: ['pipelineCoverage', 'accountStrategy', 'qbr', 'heroStories'] },
    { label: 'Learning & Growth', icon: '📚', metrics: ['capabilityAI', 'archDomain'] },
  ];

  const scorecardRef = React.useRef(null);
  const [scorecardExporting, setScorecardExporting] = React.useState(false);

  const handleScorecardPDF = async () => {
    if (scorecardExporting || !scorecardRef.current) return;
    setScorecardExporting(true);
    try {
      const html2canvas = (await import('html2canvas')).default;
      const { jsPDF } = await import('jspdf');
      const el = scorecardRef.current;

      // Temporarily expand modal so html2canvas captures ALL content (not just visible viewport)
      const prevMaxH = el.style.maxHeight;
      const prevOverflow = el.style.overflowY;
      el.style.maxHeight = 'none';
      el.style.overflowY = 'visible';

      const canvas = await html2canvas(el, {
        scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false,
        scrollY: 0, windowHeight: el.scrollHeight,
      });

      // Restore modal styles
      el.style.maxHeight = prevMaxH;
      el.style.overflowY = prevOverflow;

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 8; // mm margin on each side
      const usableW = pageW - margin * 2;
      const usableH = pageH - margin * 2;

      // Scale image width to fit page width, then paginate vertically
      const imgW = usableW;
      const imgH = (canvas.height / canvas.width) * imgW;

      if (imgH <= usableH) {
        // Fits on one page — center vertically
        pdf.addImage(imgData, 'PNG', margin, margin + (usableH - imgH) / 2, imgW, imgH);
      } else {
        // Multi-page: slice the canvas into page-sized vertical strips
        const pageCanvasH = (usableH / imgH) * canvas.height; // px height per page
        let yPos = 0;
        let pageNum = 0;

        while (yPos < canvas.height) {
          if (pageNum > 0) pdf.addPage();

          // Create a slice of the canvas for this page
          const sliceH = Math.min(pageCanvasH, canvas.height - yPos);
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = sliceH;
          const ctx = pageCanvas.getContext('2d');
          ctx.drawImage(canvas, 0, yPos, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

          const sliceData = pageCanvas.toDataURL('image/png');
          const sliceImgH = (sliceH / canvas.width) * imgW;
          pdf.addImage(sliceData, 'PNG', margin, margin, imgW, sliceImgH);

          yPos += sliceH;
          pageNum++;
        }
      }

      pdf.save(`${selectedFunction || 'KAM'}_Balanced_Scorecard_${selectedFY || 'FY'}.pdf`);
    } catch (err) {
      console.error('Scorecard PDF export failed:', err);
    } finally {
      setScorecardExporting(false);
    }
  };

  return (
    <div onClick={onClose} style={{
      position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
      background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(6px)',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      zIndex: 9999, animation: 'fadeIn 0.2s ease',
    }}>
      <div onClick={e => e.stopPropagation()} ref={scorecardRef} style={{
        background: '#fff', borderRadius: 16, padding: 28,
        width: '94vw', maxWidth: 900, maxHeight: '90vh', overflowY: 'auto',
        position: 'relative', animation: 'slideUp 0.3s ease',
        boxShadow: '0 24px 48px rgba(0,0,0,0.2)',
      }}>
        <div style={{ position: 'absolute', top: 14, right: 14, display: 'flex', gap: 8 }}>
          <button onClick={handleScorecardPDF} disabled={scorecardExporting} style={{
            height: 34, paddingInline: 14, borderRadius: 8,
            border: '1px solid rgba(232,31,118,0.3)', background: scorecardExporting ? '#f1f5f9' : 'rgba(232,31,118,0.06)',
            fontSize: 12, fontWeight: 600, cursor: scorecardExporting ? 'default' : 'pointer',
            display: 'flex', alignItems: 'center', gap: 6, color: '#E81F76', transition: 'all 0.2s',
          }}
            onMouseEnter={e => { if (!scorecardExporting) e.currentTarget.style.background = 'rgba(232,31,118,0.15)'; }}
            onMouseLeave={e => { e.currentTarget.style.background = scorecardExporting ? '#f1f5f9' : 'rgba(232,31,118,0.06)'; }}
          >{scorecardExporting
            ? <><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{animation:'spin 1s linear infinite'}}><path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4m-3.93 7.07l-2.83-2.83M7.76 7.76L4.93 4.93"/></svg><span>Exporting…</span></>
            : <><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Download PDF</span></>
          }</button>
          <button onClick={onClose} style={{
            width: 34, height: 34, borderRadius: 8,
            border: '1px solid #e2e8f0', background: '#fff', fontSize: 16, cursor: 'pointer',
            display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#64748b',
          }}>✕</button>
        </div>

        <h3 style={{ fontSize: 20, fontWeight: 700, color: '#1a1a2e', marginBottom: 4 }}>📊 {selectedFunction || 'KAM'} Balanced Scorecard</h3>
        <p style={{ fontSize: 13, color: '#94a3b8', marginBottom: 16 }}>{selectedFY || 'FY'} — Live from dashboard data</p>

        <div className="scorecard-table-wrap" style={{ overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 13 }}>
            <thead>
              <tr style={{ background: '#1a1a2e', color: '#fff' }}>
                <th style={{ padding: '10px 14px', textAlign: 'left', fontWeight: 700, borderRadius: '8px 0 0 0' }}>Metric</th>
                <th style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700 }}>Weightage</th>
                <th style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700 }}>{selectedFY || 'FY'} Target</th>
                <th style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700 }}>Achievement</th>
                <th style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700 }}>Achievement %</th>
                <th style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700, borderRadius: '0 8px 0 0' }}>Weighted Score</th>
              </tr>
            </thead>
            <tbody>
              {scorecardSections.map(section => {
                const sectionRows = section.metrics
                  .filter(k => weightages[k] && allRowDefs[k])
                  .map(k => ({ key: k, ...allRowDefs[k] }));
                if (sectionRows.length === 0) return null;
                const secWeight = sectionRows.reduce((s, r) => s + (weightages[r.key]?.weight || 0), 0);
                const secAchieved = sectionRows.reduce((s, r) => {
                  const ach = Math.min(r.pct || 0, 1);
                  return s + ach * (weightages[r.key]?.weight || 0);
                }, 0);
                const secAchPct = secWeight > 0 ? (secAchieved / secWeight) * 100 : 0;
                const secColor = secAchPct >= 90 ? '#10b981' : secAchPct >= 70 ? '#f59e0b' : '#ef4444';
                return (
                  <React.Fragment key={section.label}>
                    {/* Section header row */}
                    <tr style={{ background: 'linear-gradient(135deg, #334155, #475569)' }}>
                      <td colSpan={4} style={{ padding: '8px 14px', fontWeight: 800, fontSize: 13, color: '#fff' }}>
                        {section.icon} {section.label}
                      </td>
                      <td style={{ padding: '8px 14px', textAlign: 'center' }}>
                        <span style={{ fontSize: 11, fontWeight: 700, color: secColor, background: `${secColor}20`, padding: '2px 8px', borderRadius: 10 }}>
                          {secAchPct.toFixed(0)}%
                        </span>
                      </td>
                      <td style={{ padding: '8px 14px', textAlign: 'center', fontWeight: 700, fontSize: 12, color: '#E81F76' }}>
                        {secAchieved.toFixed(1)} / {secWeight}%
                      </td>
                    </tr>
                    {/* Metric rows in this section */}
                    {sectionRows.map((r, i) => {
                      const weight = weightages[r.key]?.weight || 0;
                      if (r.isCoverage) {
                        const covPct = r.pct || 0;
                        const covColor = covPct >= 1 ? '#10b981' : covPct >= 0.33 ? '#f59e0b' : '#ef4444';
                        const weightedScore = Math.min(covPct, 1.0) * weight;
                        return (
                          <tr key={r.key} style={{ background: i % 2 === 0 ? '#f8fafc' : '#fff', borderBottom: '1px solid #e2e8f0' }}>
                            <td style={{ padding: '10px 14px 10px 28px', fontWeight: 600, color: '#1e293b' }}>{r.label}</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', color: '#64748b', fontWeight: 600 }}>{weight.toFixed(0)}%</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', color: '#475569', fontWeight: 600 }}>{r.target}</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', color: '#1e293b', fontWeight: 700 }}>{r.achievement}</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center' }}>
                              <span style={{ display: 'inline-block', padding: '2px 10px', borderRadius: 12, background: `${covColor}18`, color: covColor, fontWeight: 700, fontSize: 12 }}>{(covPct * 100).toFixed(0)}%</span>
                            </td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700, color: '#E81F76' }}>{weightedScore.toFixed(1)}%</td>
                          </tr>
                        );
                      }
                      if (r.isRAG) {
                        const ragColors = { red: '#ef4444', amber: '#f59e0b', green: '#10b981' };
                        const ragLabels = { red: 'Red', amber: 'Amber', green: 'Green' };
                        const ragVal = r.achievement || 'red';
                        const ragColor = ragColors[ragVal] || ragColors.red;
                        const ragScore = r.pct || 0;
                        const weightedScore = Math.min(Math.max(ragScore, 0), 1.0) * weight;
                        return (
                          <tr key={r.key} style={{ background: i % 2 === 0 ? '#f8fafc' : '#fff', borderBottom: '1px solid #e2e8f0' }}>
                            <td style={{ padding: '10px 14px 10px 28px', fontWeight: 600, color: '#1e293b' }}>{r.label}</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', color: '#64748b', fontWeight: 600 }}>{weight.toFixed(0)}%</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', color: '#475569', fontWeight: 600 }}>{r.target}</td>
                            <td style={{ padding: '10px 14px', textAlign: 'center' }}>
                              <span style={{ display: 'inline-block', padding: '2px 10px', borderRadius: 12, background: `${ragColor}18`, color: ragColor, fontWeight: 700, fontSize: 12 }}>{ragLabels[ragVal] || 'Red'}</span>
                            </td>
                            <td style={{ padding: '10px 14px', textAlign: 'center' }}>
                              <span style={{ display: 'inline-block', padding: '2px 10px', borderRadius: 12, background: `${ragColor}18`, color: ragColor, fontWeight: 700, fontSize: 12 }}>{(ragScore * 100).toFixed(0)}%</span>
                            </td>
                            <td style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700, color: '#E81F76' }}>{weightedScore.toFixed(1)}%</td>
                          </tr>
                        );
                      }
                      const cappedPct = Math.min(Math.max(r.pct, 0), 1.0);
                      const weightedScore = cappedPct * weight;
                      const achPctVal = r.pct * 100;
                      const achColor = achPctVal >= 90 ? '#10b981' : achPctVal >= 70 ? '#f59e0b' : '#ef4444';
                      return (
                        <tr key={r.key} style={{ background: i % 2 === 0 ? '#f8fafc' : '#fff', borderBottom: '1px solid #e2e8f0' }}>
                          <td style={{ padding: '10px 14px 10px 28px', fontWeight: 600, color: '#1e293b' }}>{r.label}</td>
                          <td style={{ padding: '10px 14px', textAlign: 'center', color: '#64748b', fontWeight: 600 }}>{weight.toFixed(0)}%</td>
                          <td style={{ padding: '10px 14px', textAlign: 'center', color: '#475569', fontWeight: 600 }}>{r.target}</td>
                          <td style={{ padding: '10px 14px', textAlign: 'center', color: '#1e293b', fontWeight: 700 }}>{r.achievement}</td>
                          <td style={{ padding: '10px 14px', textAlign: 'center' }}>
                            <span style={{ display: 'inline-block', padding: '2px 10px', borderRadius: 12, background: `${achColor}18`, color: achColor, fontWeight: 700, fontSize: 12 }}>{achPctVal.toFixed(0)}%</span>
                          </td>
                          <td style={{ padding: '10px 14px', textAlign: 'center', fontWeight: 700, color: '#E81F76' }}>{weightedScore.toFixed(1)}%</td>
                        </tr>
                      );
                    })}
                  </React.Fragment>
                );
              })}
            </tbody>
            <tfoot>
              <tr style={{ background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)', color: '#fff' }}>
                <td style={{ padding: '12px 14px', fontWeight: 800, fontSize: 14, borderRadius: '0 0 0 8px' }}>Overall OKR Score</td>
                <td style={{ padding: '12px 14px', textAlign: 'center', fontWeight: 700 }}>{totalWeight.toFixed(0)}%</td>
                <td style={{ padding: '12px 14px' }}></td>
                <td style={{ padding: '12px 14px' }}></td>
                <td style={{ padding: '12px 14px' }}></td>
                <td style={{ padding: '12px 14px', textAlign: 'center', fontWeight: 800, fontSize: 18, color: '#E81F76', borderRadius: '0 0 8px 0' }}>{okrScore.toFixed(1)}%</td>
              </tr>
            </tfoot>
          </table>
        </div>

        {/* Color legend */}
        <div style={{ display: 'flex', gap: 16, marginTop: 14, fontSize: 11, color: '#64748b', justifyContent: 'center' }}>
          <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <span style={{ width: 10, height: 10, borderRadius: '50%', background: '#10b981' }} /> ≥ 90% On Track
          </span>
          <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <span style={{ width: 10, height: 10, borderRadius: '50%', background: '#f59e0b' }} /> 70–89% Needs Attention
          </span>
          <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <span style={{ width: 10, height: 10, borderRadius: '50%', background: '#ef4444' }} /> &lt; 70% At Risk
          </span>
        </div>
      </div>
    </div>
  );
};

/* ================================================================
   Drill-Down Modal — metric-specific details
   ================================================================ */
const DrillDownModal = ({ section, onClose, billingTimelinessData, collectionTimelinessData, selectedFY }) => {
  const [subView, setSubView] = useState('overall');
  useEffect(() => setSubView('overall'), [section]);

  if (!section) return null;
  const ctx = useKamDataContext();
  const { annualMetrics, monthlyBilling, monthlyCollection, quarterlyQBRs, quarterlyHeroStories,
    quarterlyNewLogos, newLogosTotals,
    billingTotals, collectionTotals, quarterlyARR, quarterlyServiceRev, pipelineCoverage, accountOwnerPerformance,
    selectedFunction } = ctx;

  /* Toggle buttons for sections that support Account Owner view */
  const hasOwnerView = section === 'arr' || section === 'billing' || section === 'collection';
  const ViewToggle = () => hasOwnerView ? (
    <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>
      {[['overall', 'Overall'], ['byOwner', 'By Account Owner']].map(([key, label]) => (
        <button key={key} onClick={() => setSubView(key)} style={{
          padding: '6px 16px', borderRadius: 8, border: 'none', fontSize: 12, fontWeight: 600, cursor: 'pointer',
          background: subView === key ? '#E81F76' : '#f1f5f9',
          color: subView === key ? '#fff' : '#64748b', transition: 'all 0.2s',
        }}>{label}</button>
      ))}
    </div>
  ) : null;

  /* Reusable Account Owner horizontal bar chart + table */
  const OwnerBreakdown = ({ dataKey, label, unit = 'Cr' }) => {
    const owners = [...(accountOwnerPerformance || [])].sort((a, b) => b[dataKey] - a[dataKey]);
    const total = owners.reduce((s, o) => s + o[dataKey], 0);
    return (
      <div>
        <div style={{ background: '#f8fafc', borderRadius: 10, padding: 14, marginBottom: 16, textAlign: 'center' }}>
          <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Total {label} (All Owners)</div>
          <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>₹{Number(total).toFixed(1)} {unit}</div>
        </div>
        <ResponsiveContainer width="100%" height={Math.max(280, owners.length * 36)}>
          <BarChart data={owners} layout="vertical" margin={{ top: 5, right: 50, bottom: 5, left: 10 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" horizontal={false} />
            <XAxis type="number" tick={{ fontSize: 11, fill: '#6b7280' }} tickFormatter={(v) => `${v}`} />
            <YAxis type="category" dataKey="name" tick={{ fontSize: 11, fill: '#374151' }} width={120} />
            <Tooltip formatter={(v) => [`₹${Number(v).toFixed(1)} ${unit}`, label]} />
            <Bar dataKey={dataKey} name={label} radius={[0, 4, 4, 0]} barSize={20}
              label={{ position: 'right', fontSize: 10, fontWeight: 700, fill: '#64748b', formatter: (v) => `₹${Math.abs(Number(v)).toFixed(1)}` }}>
              {owners.map((entry, i) => (
                <Cell key={i} fill={entry[dataKey] >= 0 ? '#6366f1' : '#ef4444'} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12, marginTop: 16 }}>
          <thead>
            <tr style={{ background: '#f8fafc' }}>
              <th style={{ padding: '8px 12px', textAlign: 'left', color: '#64748b', fontWeight: 600 }}>Account Owner</th>
              <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>{label} (₹ {unit})</th>
            </tr>
          </thead>
          <tbody>
            {owners.map((o, i) => (
              <tr key={i} style={{ borderBottom: '1px solid #f1f5f9' }}>
                <td style={{ padding: '8px 12px', fontWeight: 600 }}>{o.name}</td>
                <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                  <span style={{ fontWeight: 700, color: o[dataKey] >= 0 ? '#1e293b' : '#ef4444' }}>
                    {o[dataKey] < 0 ? '−' : ''}₹{Math.abs(o[dataKey]).toFixed(1)} {unit}
                  </span>
                </td>
              </tr>
            ))}
            <tr style={{ borderTop: '2px solid #1a1a2e', background: '#f1f5f9' }}>
              <td style={{ padding: '8px 12px', fontWeight: 800, color: '#1a1a2e' }}>Total</td>
              <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                <span style={{ fontWeight: 800, color: '#1a1a2e' }}>₹{Number(total).toFixed(1)} {unit}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    );
  };

  const titles = {
    billing: 'On-Time Billing — Timeliness Analysis',
    collection: 'On-Time Collection — Timeliness Analysis',
    qbr: 'QBRs Held — Quarterly Breakdown',
    arr: 'ARR — Annual Recurring Revenue',
    serviceRev: 'Service Revenue — Quarterly Breakdown',
    ndr: 'Net Dollar Retention (NDR)',
    gdr: 'Gross Dollar Retention (GDR)',
    nps: 'NPS Score',
    heroStories: 'Hero Stories — Quarterly Breakdown',
    newLogos: '# of New Logos — Quarterly Breakdown',
    salesCapacity: 'Sales Capacity Achievement',
    pipelineCoverage: 'Pipeline Coverage — Open Pipeline vs Remaining Target',
  };

  const renderContent = () => {
    /* --- ARR Drill-Down: Annual + Quarterly bar chart --- */
    if (section === 'arr') {
      const m = annualMetrics.arr;
      const qData = quarterlyARR || [];
      return (
        <div>
          <ViewToggle />
          {subView === 'overall' ? (
            <>
              <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
                <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
                  <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{formatCrore(m.targetFY26, 1)}</div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achieved YTD</div>
                  <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(m.achievementTillDate / m.targetFY26) }}>{formatCrore(m.achievementTillDate, 1)}</div>
                </div>
                <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Gap to Target</div>
                  <div style={{ fontSize: 24, fontWeight: 800, color: '#ef4444' }}>{formatCrore(m.targetFY26 - m.achievementTillDate, 1)}</div>
                </div>
              </div>
              {qData.length > 0 && (
                <>
                  <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, color: '#1e293b' }}>Quarterly Breakdown</h4>
                  <ResponsiveContainer width="100%" height={280}>
                    <BarChart data={qData} barGap={8} margin={{ top: 18 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                      <XAxis dataKey="quarter" tick={{ fontSize: 12, fill: '#6b7280' }} />
                      <YAxis tick={{ fontSize: 12, fill: '#6b7280' }} />
                      <Tooltip formatter={(v) => formatCrore(v, 1)} />
                      <Bar dataKey="target" name="Target" fill="#c7d2fe" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel fill="#a5b4c8" />} />
                      <Bar dataKey="achievement" name="Achievement" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel />}>
                        {qData.map((entry, i) => (
                          <Cell key={i} fill={getAchievementColor(entry.percentage)} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </>
              )}
            </>
          ) : (
            <OwnerBreakdown dataKey="arrAchievement" label="ARR Achievement" />
          )}
        </div>
      );
    }

    /* --- Service Revenue Drill-Down --- */
    if (section === 'serviceRev') {
      const m = annualMetrics.serviceRev;
      const qData = quarterlyServiceRev || [];
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{formatCrore(m.targetFY26, 0)}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achieved YTD</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(m.achievementTillDate / m.targetFY26) }}>{formatCrore(m.achievementTillDate, 0)}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Gap to Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: m.targetFY26 - m.achievementTillDate > 0 ? '#ef4444' : '#10b981' }}>{formatCrore(m.targetFY26 - m.achievementTillDate, 0)}</div>
            </div>
          </div>
          {qData.length > 0 && (
            <>
              <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, color: '#1e293b' }}>Quarterly Breakdown</h4>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={qData} barGap={8} margin={{ top: 18 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="quarter" tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <YAxis tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <Tooltip formatter={(v) => formatCrore(v, 1)} />
                  <Bar dataKey="target" name="Target" fill="#c7d2fe" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel fill="#a5b4c8" />} />
                  <Bar dataKey="achievement" name="Achievement" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel />}>
                    {qData.map((entry, i) => (
                      <Cell key={i} fill={getAchievementColor(entry.percentage)} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </>
          )}
        </div>
      );
    }

    /* --- NDR Drill-Down --- */
    if (section === 'ndr') {
      const m = annualMetrics.ndr;
      const pct = m.achievementTillDate / m.targetFY26;
      const achPct = (m.achievementTillDate * 100).toFixed(0);
      const tarPct = (m.targetFY26 * 100).toFixed(0);
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 20, textAlign: 'center' }}>
              <div style={{ fontSize: 12, color: '#94a3b8', marginBottom: 6 }}>Target NDR</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: '#1e293b' }}>{tarPct}%</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 20, textAlign: 'center' }}>
              <div style={{ fontSize: 12, color: '#94a3b8', marginBottom: 6 }}>Current NDR</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: getAchievementColor(pct) }}>{achPct}%</div>
            </div>
          </div>
          <div style={{ background: pct >= 1 ? '#f0fdf4' : '#fef2f2', borderRadius: 10, padding: 16 }}>
            <p style={{ fontSize: 13, color: '#1e293b', lineHeight: 1.6 }}>
              NDR measures how much revenue is retained + expanded from existing customers. A value above 100% means you're growing within existing accounts.
              Current NDR of <strong>{achPct}%</strong> vs target <strong>{tarPct}%</strong> means
              {pct >= 1 ? ' the team is successfully expanding within existing accounts.' : ` there's a gap of ${((m.targetFY26 - m.achievementTillDate) * 100).toFixed(0)}% to close.`}
            </p>
          </div>
        </div>
      );
    }

    /* --- GDR Drill-Down --- */
    if (section === 'gdr') {
      const m = annualMetrics.gdr;
      const pct = m.achievementTillDate / m.targetFY26;
      const achPct = (m.achievementTillDate * 100).toFixed(0);
      const tarPct = (m.targetFY26 * 100).toFixed(0);
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 20, textAlign: 'center' }}>
              <div style={{ fontSize: 12, color: '#94a3b8', marginBottom: 6 }}>Target GDR</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: '#1e293b' }}>{tarPct}%</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 20, textAlign: 'center' }}>
              <div style={{ fontSize: 12, color: '#94a3b8', marginBottom: 6 }}>Current GDR</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: getAchievementColor(pct) }}>{achPct}%</div>
            </div>
          </div>
          <div style={{ background: pct >= 1 ? '#f0fdf4' : '#fef2f2', borderRadius: 10, padding: 16 }}>
            <p style={{ fontSize: 13, color: '#1e293b', lineHeight: 1.6 }}>
              GDR measures gross revenue retention (before upsells). A value of 100% means zero churn.
              Current GDR of <strong>{achPct}%</strong> vs target <strong>{tarPct}%</strong>
              {pct >= 1 ? ' — excellent, minimal customer churn.' : ` indicates ${((1 - m.achievementTillDate) * 100).toFixed(1)}% revenue churn, higher than the ${((1 - m.targetFY26) * 100).toFixed(1)}% target.`}
            </p>
          </div>
        </div>
      );
    }

    /* --- NPS Drill-Down --- */
    if (section === 'nps') {
      const m = annualMetrics.nps;
      const hasBaseline = m.baseline !== undefined && m.baseline !== null;
      const baseline = hasBaseline ? m.baseline : 0;
      const improvement = m.achievementTillDate - baseline;
      const totalNeeded = m.targetFY26 - baseline;
      const achievementPct = totalNeeded !== 0 ? Math.max(0, (improvement / totalNeeded) * 100) : 0;
      const remaining = m.targetFY26 - m.achievementTillDate;

      return (
        <div>
          {/* 3-box summary: Baseline, Current, Target */}
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16 }}>
            <div style={{ background: '#fef2f2', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Q1 Baseline</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: '#ef4444' }}>{baseline}</div>
            </div>
            <div style={{ background: improvement > 0 ? '#fffbeb' : '#fef2f2', borderRadius: 10, padding: 16, textAlign: 'center', border: '2px solid #E81F76' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Current NPS</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: m.achievementTillDate >= 0 ? '#10b981' : '#f59e0b' }}>{m.achievementTillDate}</div>
            </div>
            <div style={{ background: '#f0fdf4', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Target NPS</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: '#10b981' }}>+{m.targetFY26}</div>
            </div>
          </div>

          {/* Progress bar: Baseline → Current → Target */}
          <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, marginBottom: 16 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11, color: '#64748b', marginBottom: 8 }}>
              <span>Improvement Progress</span>
              <span style={{ fontWeight: 700, color: '#E81F76' }}>{achievementPct.toFixed(1)}%</span>
            </div>
            <div style={{ position: 'relative', height: 10, background: '#e2e8f0', borderRadius: 6, overflow: 'hidden' }}>
              <div style={{
                height: '100%', borderRadius: 6,
                width: `${Math.min(100, achievementPct)}%`,
                background: achievementPct >= 80 ? 'linear-gradient(90deg, #10b981, #34d399)' : achievementPct >= 40 ? 'linear-gradient(90deg, #f59e0b, #fbbf24)' : 'linear-gradient(90deg, #ef4444, #f97316)',
                transition: 'width 0.5s',
              }} />
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: '#94a3b8', marginTop: 4 }}>
              <span>{baseline} (Q1)</span>
              <span>+{m.targetFY26} (Target)</span>
            </div>
          </div>

          {/* Calculation explanation */}
          <div style={{ background: '#eef2ff', border: '1px solid #c7d2fe', borderRadius: 10, padding: 14, marginBottom: 16 }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, color: '#4338ca', marginBottom: 8 }}>How NPS Achievement is Calculated</h4>
            <div style={{ fontSize: 12, color: '#475569', lineHeight: 1.8 }}>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginBottom: 10 }}>
                <div style={{ background: '#fff', borderRadius: 6, padding: '8px 10px' }}>
                  <span style={{ color: '#94a3b8' }}>Improvement Made:</span>{' '}
                  <strong>{m.achievementTillDate} - ({baseline}) = {improvement > 0 ? '+' : ''}{improvement} pts</strong>
                </div>
                <div style={{ background: '#fff', borderRadius: 6, padding: '8px 10px' }}>
                  <span style={{ color: '#94a3b8' }}>Improvement Needed:</span>{' '}
                  <strong>+{m.targetFY26} - ({baseline}) = {totalNeeded} pts</strong>
                </div>
              </div>
              <div style={{ background: '#fff', borderRadius: 8, padding: '10px 12px', textAlign: 'center', border: '1px dashed #c7d2fe' }}>
                <span style={{ color: '#94a3b8' }}>Achievement</span> ={' '}
                <strong style={{ color: '#4338ca' }}>Improvement / Total Needed</strong> ={' '}
                <strong>{improvement} / {totalNeeded}</strong> ={' '}
                <span style={{ fontSize: 16, fontWeight: 800, color: '#E81F76' }}>{achievementPct.toFixed(1)}%</span>
              </div>
            </div>
          </div>

          {/* Status message */}
          <div style={{ background: remaining <= 0 ? '#f0fdf4' : '#fffbeb', borderRadius: 10, padding: 14 }}>
            <p style={{ fontSize: 13, color: '#1e293b', lineHeight: 1.6, margin: 0 }}>
              {remaining <= 0
                ? `NPS target achieved! Current NPS of ${m.achievementTillDate} has met or exceeded the target of +${m.targetFY26}.`
                : `NPS improved by ${improvement} points (from ${baseline} to ${m.achievementTillDate}). Still needs ${remaining} more points to reach the target of +${m.targetFY26}.`
              }
            </p>
          </div>
        </div>
      );
    }

    /* --- Billing Timeliness Drill-Down --- */
    if (section === 'billing') {
      const data = billingTimelinessData?.monthlyScores || [];
      const avgScore = data.length > 0 ? data.reduce((s, d) => s + d.onTimeScore, 0) / data.length : 0;
      const exampleMonth = data[0];
      return (
        <div>
          <ViewToggle />
          {subView === 'overall' ? (
          <>
          {/* Explanation box */}
          <div style={{ background: '#eef2ff', border: '1px solid #c7d2fe', borderRadius: 10, padding: 14, marginBottom: 16 }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, color: '#4338ca', marginBottom: 6 }}>How Billing Score Works</h4>
            <p style={{ fontSize: 12, color: '#475569', lineHeight: 1.6, margin: 0 }}>
              Each month's billing score = <strong>Achievement ÷ Target</strong>.
              The overall score is the <strong>mean of all monthly scores</strong> (excluding months where achievement is blank).
            </p>
          </div>

          {/* Step-by-step Calculation */}
          <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: 10, padding: 14, marginBottom: 16 }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, color: '#166534', marginBottom: 8 }}>Actual Calculation</h4>
            <div style={{ fontSize: 12, color: '#1e293b', lineHeight: 1.8 }}>
              <div style={{ marginBottom: 6 }}>
                <strong>Formula:</strong> Score = Mean of all monthly (Achievement ÷ Target)
              </div>
              {exampleMonth && (
                <div style={{ background: '#fff', border: '1px solid #d1fae5', borderRadius: 8, padding: 10, marginTop: 8, marginBottom: 8 }}>
                  <strong>Worked Example — {exampleMonth.month}:</strong>
                  <div style={{ marginTop: 4 }}>
                    <div>• Target: <strong>{Number(exampleMonth.target).toFixed(1)} Cr</strong></div>
                    <div>• Achievement: <strong>{Number(exampleMonth.achievement).toFixed(1)} Cr</strong></div>
                    <div>• Score: {Number(exampleMonth.achievement).toFixed(1)} / {Number(exampleMonth.target).toFixed(1)} = <strong>{(exampleMonth.onTimeScore * 100).toFixed(1)}%</strong></div>
                  </div>
                </div>
              )}
              <div style={{ marginTop: 6 }}>
                <strong>Final Score:</strong> ({data.map(d => `${(d.onTimeScore * 100).toFixed(0)}%`).join(' + ')}) ÷ {data.length} months = <strong style={{ color: getAchievementColor(avgScore), fontSize: 14 }}>{(avgScore * 100).toFixed(1)}%</strong>
              </div>
            </div>
          </div>

          <BillingChart dateRange={[0, 11]} />
          {data.length > 0 && (
            <div style={{ marginTop: 16 }}>
              <h4 style={{ fontSize: 14, fontWeight: 700, marginBottom: 10, color: '#1e293b' }}>Monthly Billing Breakdown</h4>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                <thead>
                  <tr style={{ background: '#f8fafc' }}>
                    <th style={{ padding: '8px 12px', textAlign: 'left', color: '#64748b', fontWeight: 600 }}>Month</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Target</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Achievement</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Score</th>
                  </tr>
                </thead>
                <tbody>
                  {data.map((d, i) => (
                    <tr key={i} style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px 12px', fontWeight: 600 }}>{d.month}</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>{Number(d.target).toFixed(1)} Cr</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>{Number(d.achievement).toFixed(1)} Cr</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                        <span style={{
                          fontWeight: 700, color: getAchievementColor(d.onTimeScore),
                          background: getAchievementColor(d.onTimeScore) + '18', padding: '2px 8px', borderRadius: 8,
                        }}>{(d.onTimeScore * 100).toFixed(1)}%</span>
                      </td>
                    </tr>
                  ))}
                  <tr style={{ borderTop: '2px solid #1a1a2e', background: '#f1f5f9' }}>
                    <td style={{ padding: '8px 12px', fontWeight: 800, color: '#1a1a2e' }}>Total</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 800, color: '#1a1a2e' }}>{data.reduce((s, d) => s + Number(d.target), 0).toFixed(1)} Cr</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 800, color: '#1a1a2e' }}>{data.reduce((s, d) => s + Number(d.achievement), 0).toFixed(1)} Cr</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                      <span style={{
                        fontWeight: 700, color: getAchievementColor(avgScore),
                        background: getAchievementColor(avgScore) + '18', padding: '2px 8px', borderRadius: 8,
                      }}>{(avgScore * 100).toFixed(1)}%</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          )}
          </>
          ) : (
            <OwnerBreakdown dataKey="billing" label="Billing" />
          )}
        </div>
      );
    }

    /* --- Collection Drill-Down --- */
    if (section === 'collection') {
      const data = collectionTimelinessData?.monthlyScores || [];
      const avgScore = data.length > 0 ? data.reduce((s, d) => s + d.onTimeScore, 0) / data.length : 0;
      const exampleMonth = data[0];
      return (
        <div>
          <ViewToggle />
          {subView === 'overall' ? (
          <>
          <div style={{ background: '#eef2ff', border: '1px solid #c7d2fe', borderRadius: 10, padding: 14, marginBottom: 16 }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, color: '#4338ca', marginBottom: 6 }}>How Collection Score Works</h4>
            <p style={{ fontSize: 12, color: '#475569', lineHeight: 1.6, margin: 0 }}>
              Each month's collection score = <strong>Achievement ÷ Target</strong>.
              The overall score is the <strong>mean of all monthly scores</strong> (excluding months where achievement is blank).
            </p>
          </div>

          {/* Step-by-step Calculation */}
          <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: 10, padding: 14, marginBottom: 16 }}>
            <h4 style={{ fontSize: 13, fontWeight: 700, color: '#166534', marginBottom: 8 }}>Actual Calculation</h4>
            <div style={{ fontSize: 12, color: '#1e293b', lineHeight: 1.8 }}>
              <div style={{ marginBottom: 6 }}>
                <strong>Formula:</strong> Score = Mean of all monthly (Achievement ÷ Target)
              </div>
              {exampleMonth && (
                <div style={{ background: '#fff', border: '1px solid #d1fae5', borderRadius: 8, padding: 10, marginTop: 8, marginBottom: 8 }}>
                  <strong>Worked Example — {exampleMonth.month}:</strong>
                  <div style={{ marginTop: 4 }}>
                    <div>• Target: <strong>{Number(exampleMonth.target).toFixed(1)} Cr</strong></div>
                    <div>• Achievement: <strong>{Number(exampleMonth.achievement).toFixed(1)} Cr</strong></div>
                    <div>• Score: {Number(exampleMonth.achievement).toFixed(1)} / {Number(exampleMonth.target).toFixed(1)} = <strong>{(exampleMonth.onTimeScore * 100).toFixed(1)}%</strong></div>
                  </div>
                </div>
              )}
              <div style={{ marginTop: 6 }}>
                <strong>Final Score:</strong> ({data.map(d => `${(d.onTimeScore * 100).toFixed(0)}%`).join(' + ')}) ÷ {data.length} months = <strong style={{ color: getAchievementColor(avgScore), fontSize: 14 }}>{(avgScore * 100).toFixed(1)}%</strong>
              </div>
            </div>
          </div>

          <CollectionChart dateRange={[0, 11]} />
          {data.length > 0 && (
            <div style={{ marginTop: 16 }}>
              <h4 style={{ fontSize: 14, fontWeight: 700, marginBottom: 10, color: '#1e293b' }}>Monthly Collection Breakdown</h4>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                <thead>
                  <tr style={{ background: '#f8fafc' }}>
                    <th style={{ padding: '8px 12px', textAlign: 'left', color: '#64748b', fontWeight: 600 }}>Month</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Target</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Achievement</th>
                    <th style={{ padding: '8px 12px', textAlign: 'right', color: '#64748b', fontWeight: 600 }}>Score</th>
                  </tr>
                </thead>
                <tbody>
                  {data.map((d, i) => (
                    <tr key={i} style={{ borderBottom: '1px solid #f1f5f9' }}>
                      <td style={{ padding: '8px 12px', fontWeight: 600 }}>{d.month}</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>{Number(d.target).toFixed(1)} Cr</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>{Number(d.achievement).toFixed(1)} Cr</td>
                      <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                        <span style={{
                          fontWeight: 700, color: getAchievementColor(d.onTimeScore),
                          background: getAchievementColor(d.onTimeScore) + '18', padding: '2px 8px', borderRadius: 8,
                        }}>{(d.onTimeScore * 100).toFixed(1)}%</span>
                      </td>
                    </tr>
                  ))}
                  <tr style={{ borderTop: '2px solid #1a1a2e', background: '#f1f5f9' }}>
                    <td style={{ padding: '8px 12px', fontWeight: 800, color: '#1a1a2e' }}>Total</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 800, color: '#1a1a2e' }}>{data.reduce((s, d) => s + Number(d.target), 0).toFixed(1)} Cr</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 800, color: '#1a1a2e' }}>{data.reduce((s, d) => s + Number(d.achievement), 0).toFixed(1)} Cr</td>
                    <td style={{ padding: '8px 12px', textAlign: 'right' }}>
                      <span style={{
                        fontWeight: 700, color: getAchievementColor(avgScore),
                        background: getAchievementColor(avgScore) + '18', padding: '2px 8px', borderRadius: 8,
                      }}>{(avgScore * 100).toFixed(1)}%</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          )}
          </>
          ) : (
            <OwnerBreakdown dataKey="collection" label="Collection" />
          )}
        </div>
      );
    }

    /* --- QBR Drill-Down (only QBRs) --- */
    if (section === 'qbr') {
      const qData = quarterlyQBRs || [];
      const qbrTotalAch = qData.reduce((s, q) => s + q.achievement, 0);
      const qbrTotalTar = qData.reduce((s, q) => s + q.target, 0);
      const qbrOverallPct = qbrTotalTar > 0 ? qbrTotalAch / qbrTotalTar : 0;
      const qbrChartData = qData.map(q => ({
        quarter: q.quarter,
        target: q.target,
        achievement: q.achievement,
        percentage: q.percentage,
      }));
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{qbrTotalTar}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achieved YTD</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(qbrOverallPct) }}>{qbrTotalAch}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achievement</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(qbrOverallPct) }}>{(qbrOverallPct * 100).toFixed(0)}%</div>
            </div>
          </div>
          {qbrChartData.length > 0 && (
            <>
              <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, color: '#1e293b' }}>Quarterly QBRs Held</h4>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={qbrChartData} barGap={8} margin={{ top: 18 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="quarter" tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <YAxis tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <Tooltip formatter={(v) => [Number(v).toFixed(1), '']} />
                  <Bar dataKey="target" name="Target" fill="#c7d2fe" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel fill="#a5b4c8" />} />
                  <Bar dataKey="achievement" name="Achievement" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel />}>
                    {qbrChartData.map((entry, i) => (
                      <Cell key={i} fill={getAchievementColor(entry.percentage)} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', gap: 10, marginTop: 14, justifyContent: 'center', flexWrap: 'wrap' }}>
                {qData.map(q => (
                  <div key={q.quarter} style={{
                    padding: '6px 14px', borderRadius: 8, border: `1px solid ${getAchievementColor(q.percentage)}40`,
                    background: `${getAchievementColor(q.percentage)}10`, textAlign: 'center',
                  }}>
                    <div style={{ fontSize: 11, color: '#64748b', fontWeight: 600 }}>{q.quarter}</div>
                    <div style={{ fontSize: 16, fontWeight: 800, color: getAchievementColor(q.percentage) }}>
                      {q.achievement}/{q.target} <span style={{ fontSize: 12 }}>({(q.percentage * 100).toFixed(0)}%)</span>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      );
    }

    /* --- Hero Stories Drill-Down (only Hero Stories) --- */
    if (section === 'heroStories') {
      const hData = quarterlyHeroStories || [];
      const heroTotalAch = hData.reduce((s, q) => s + q.achievement, 0);
      const heroTotalTar = hData.reduce((s, q) => s + q.target, 0);
      const heroOverallPct = heroTotalTar > 0 ? heroTotalAch / heroTotalTar : 0;
      const heroChartData = hData.map(q => ({
        quarter: q.quarter,
        target: q.target,
        achievement: q.achievement,
        percentage: q.percentage,
      }));
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{heroTotalTar}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achieved YTD</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(heroOverallPct) }}>{heroTotalAch}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achievement</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(heroOverallPct) }}>{(heroOverallPct * 100).toFixed(0)}%</div>
            </div>
          </div>
          {heroChartData.length > 0 && (
            <>
              <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, color: '#1e293b' }}>Quarterly Hero Stories</h4>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={heroChartData} barGap={8}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="quarter" tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <YAxis tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <Tooltip formatter={(v) => [Number(v).toFixed(1), '']} />
                  <Bar dataKey="target" name="Target" fill="#fde68a" radius={[4, 4, 0, 0]} barSize={35} label={{ position: 'top', fontSize: 12, fontWeight: 700, fill: '#94a3b8' }} />
                  <Bar dataKey="achievement" name="Achievement" radius={[4, 4, 0, 0]} barSize={35} label={{ position: 'top', fontSize: 12, fontWeight: 700, fill: '#1e293b' }}>
                    {heroChartData.map((entry, i) => (
                      <Cell key={i} fill={getAchievementColor(entry.percentage)} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', gap: 10, marginTop: 14, justifyContent: 'center', flexWrap: 'wrap' }}>
                {hData.map(q => (
                  <div key={q.quarter} style={{
                    padding: '6px 14px', borderRadius: 8, border: `1px solid ${getAchievementColor(q.percentage)}40`,
                    background: `${getAchievementColor(q.percentage)}10`, textAlign: 'center',
                  }}>
                    <div style={{ fontSize: 11, color: '#64748b', fontWeight: 600 }}>{q.quarter}</div>
                    <div style={{ fontSize: 16, fontWeight: 800, color: getAchievementColor(q.percentage) }}>
                      {q.achievement}/{q.target} <span style={{ fontSize: 12 }}>({(q.percentage * 100).toFixed(0)}%)</span>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      );
    }

    /* --- New Logos Drill-Down (quarterly breakdown, same pattern as QBRs) --- */
    if (section === 'newLogos') {
      const nlData = quarterlyNewLogos || [];
      const nlTotalAch = nlData.reduce((s, q) => s + q.achievement, 0);
      const nlTotalTar = nlData.reduce((s, q) => s + q.target, 0);
      const nlOverallPct = nlTotalTar > 0 ? nlTotalAch / nlTotalTar : 0;
      const nlChartData = nlData.map(q => ({
        quarter: q.quarter,
        target: q.target,
        achievement: q.achievement,
        percentage: q.percentage,
      }));
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{nlTotalTar}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achieved YTD</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(nlOverallPct) }}>{nlTotalAch}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achievement</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(nlOverallPct) }}>{(nlOverallPct * 100).toFixed(0)}%</div>
            </div>
          </div>
          {nlChartData.length > 0 && (
            <>
              <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, color: '#1e293b' }}>Quarterly New Logos</h4>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={nlChartData} barGap={8} margin={{ top: 22, right: 10, bottom: 0, left: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="quarter" tick={{ fontSize: 12, fill: '#6b7280' }} />
                  <YAxis tick={{ fontSize: 12, fill: '#6b7280' }} allowDecimals={false} domain={[0, dataMax => Math.ceil(dataMax * 1.25) || 1]} />
                  <Tooltip formatter={(v) => [Number(v).toFixed(0), '']} />
                  <Bar dataKey="target" name="Target" fill="#fde68a" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel fill="#a5b4c8" />} />
                  <Bar dataKey="achievement" name="Achievement" radius={[4, 4, 0, 0]} barSize={35} label={<BarLabel fill="#f59e0b" />}>
                    {nlChartData.map((entry, i) => (
                      <Cell key={i} fill={getAchievementColor(entry.percentage)} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', gap: 10, marginTop: 14, justifyContent: 'center', flexWrap: 'wrap' }}>
                {nlData.map(q => (
                  <div key={q.quarter} style={{
                    padding: '6px 14px', borderRadius: 8, border: `1px solid ${getAchievementColor(q.percentage)}40`,
                    background: `${getAchievementColor(q.percentage)}10`, textAlign: 'center',
                  }}>
                    <div style={{ fontSize: 11, color: '#64748b', fontWeight: 600 }}>{q.quarter}</div>
                    <div style={{ fontSize: 16, fontWeight: 800, color: getAchievementColor(q.percentage) }}>
                      {q.achievement}/{q.target} <span style={{ fontSize: 12 }}>({(q.percentage * 100).toFixed(0)}%)</span>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      );
    }

    /* --- Sales Capacity Achievement Drill-Down (annual target vs achievement, same pattern as NPS) --- */
    if (section === 'salesCapacity') {
      const sc = annualMetrics?.salesCapacity;
      if (!sc) return <p>Sales Capacity data not available.</p>;
      const scPct = sc.targetFY26 > 0 ? sc.achievementTillDate / sc.targetFY26 : 0;
      return (
        <div>
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>{selectedFY || 'FY'} Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>{sc.targetFY26}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achievement YTD</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(scPct) }}>{sc.achievementTillDate}</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Achievement %</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: getAchievementColor(scPct) }}>{(scPct * 100).toFixed(0)}%</div>
            </div>
          </div>
          {/* Progress bar */}
          <div style={{ marginBottom: 20 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, color: '#64748b', marginBottom: 6 }}>
              <span>Progress to Target</span>
              <span>{(scPct * 100).toFixed(0)}%</span>
            </div>
            <div style={{ width: '100%', height: 16, background: '#e2e8f0', borderRadius: 8, overflow: 'hidden' }}>
              <div style={{
                height: '100%', borderRadius: 8, transition: 'width 0.8s ease-out',
                width: `${Math.min(scPct * 100, 100)}%`,
                background: `linear-gradient(90deg, ${getAchievementColor(scPct)}, ${getAchievementColor(scPct)}99)`,
              }} />
            </div>
          </div>
          {/* Status */}
          <div style={{
            background: scPct >= 0.9 ? '#f0fdf4' : scPct >= 0.7 ? '#fffbeb' : '#fef2f2',
            border: `1px solid ${getAchievementColor(scPct)}30`,
            borderRadius: 10, padding: 16,
          }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: getAchievementColor(scPct), marginBottom: 4 }}>
              {scPct >= 0.9 ? '✅ On Track' : scPct >= 0.7 ? '⚠️ Needs Attention' : '🔴 At Risk'}
            </div>
            <div style={{ fontSize: 12, color: '#475569' }}>
              {scPct >= 0.9
                ? `Sales capacity achievement of ${sc.achievementTillDate} out of ${sc.targetFY26} is on track.`
                : `Sales capacity at ${sc.achievementTillDate} out of ${sc.targetFY26} target. ${sc.targetFY26 - sc.achievementTillDate} remaining to achieve the target.`
              }
            </div>
          </div>
        </div>
      );
    }

    /* --- Pipeline Coverage Drill-Down --- */
    if (section === 'pipelineCoverage') {
      const pc = pipelineCoverage || { openPipeline: 0, remainingTarget: 0, coverage: 0 };
      const arrTarget = (quarterlyARR || []).reduce((s, q) => s + (q.target || 0), 0);
      const arrAch = (quarterlyARR || []).reduce((s, q) => s + (q.achievement || 0), 0);
      const covColor = pc.coverage >= 3 ? '#10b981' : pc.coverage >= 1 ? '#f59e0b' : '#ef4444';
      const benchmark3x = pc.remainingTarget * 3;

      // Donut chart: show Open Pipeline as filled, gap (if any) as grey
      // If pipeline > benchmark, show pipeline as full ring + excess indicator
      const pipelineTotal = Math.max(pc.openPipeline, benchmark3x, 1);
      const donutData = pc.openPipeline >= benchmark3x
        ? [
            { name: 'Benchmark (3x)', value: benchmark3x, fill: covColor },
            { name: 'Surplus', value: pc.openPipeline - benchmark3x, fill: '#6ee7b7' },
          ]
        : [
            { name: 'Open Pipeline', value: pc.openPipeline, fill: covColor },
            { name: 'Gap to 3x', value: benchmark3x - pc.openPipeline, fill: '#e2e8f0' },
          ];

      return (
        <div>
          {/* Stat cards */}
          <div className="drill-stat-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 20 }}>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Open Pipeline</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#1e293b' }}>₹{pc.openPipeline.toFixed(0)} Cr</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Remaining ARR Target</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#64748b' }}>₹{pc.remainingTarget.toFixed(1)} Cr</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Coverage Ratio</div>
              <div style={{ fontSize: 28, fontWeight: 900, color: covColor }}>{pc.coverage.toFixed(1)}x</div>
            </div>
            <div style={{ background: '#f8fafc', borderRadius: 10, padding: 16, textAlign: 'center' }}>
              <div style={{ fontSize: 11, color: '#94a3b8', marginBottom: 4 }}>Benchmark</div>
              <div style={{ fontSize: 24, fontWeight: 800, color: '#0ea5e9' }}>3.0x</div>
            </div>
          </div>

          {/* Donut Pie Chart with center label */}
          <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 4, color: '#1e293b' }}>Pipeline vs 3x Benchmark</h4>
          <p style={{ fontSize: 12, color: '#94a3b8', marginBottom: 12 }}>
            {pc.openPipeline >= benchmark3x
              ? 'Green = meets 3x benchmark, Light green = surplus above 3x'
              : `Colored = Open Pipeline (₹${pc.openPipeline.toFixed(0)} Cr), Grey = gap to reach 3x (₹${(benchmark3x - pc.openPipeline).toFixed(0)} Cr)`}
          </p>
          <div style={{ position: 'relative', width: '100%', display: 'flex', justifyContent: 'center' }}>
            <ResponsiveContainer width="100%" height={280}>
              <PieChart>
                <Pie
                  data={donutData}
                  cx="50%"
                  cy="50%"
                  innerRadius={80}
                  outerRadius={120}
                  startAngle={90}
                  endAngle={-270}
                  dataKey="value"
                  stroke="none"
                  paddingAngle={2}
                >
                  {donutData.map((entry, i) => (
                    <Cell key={i} fill={entry.fill} />
                  ))}
                </Pie>
                <Tooltip formatter={(v, name) => [`₹${Number(v).toFixed(1)} Cr`, name]}
                  contentStyle={{ fontSize: 12, borderRadius: 8, border: '1px solid #e2e8f0', padding: '8px 12px' }} />
              </PieChart>
            </ResponsiveContainer>
            {/* Center label overlay */}
            <div style={{
              position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
              textAlign: 'center', pointerEvents: 'none',
            }}>
              <div style={{ fontSize: 36, fontWeight: 900, color: covColor, lineHeight: 1 }}>{pc.coverage.toFixed(1)}x</div>
              <div style={{ fontSize: 12, color: '#64748b', fontWeight: 600, marginTop: 2 }}>Coverage</div>
              <div style={{ fontSize: 11, color: '#94a3b8', marginTop: 2 }}>Target: 3.0x</div>
            </div>
          </div>
          {/* Donut legend */}
          <div style={{ display: 'flex', justifyContent: 'center', gap: 24, marginTop: 8, marginBottom: 20 }}>
            {donutData.map((d, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: '#475569' }}>
                <div style={{ width: 12, height: 12, borderRadius: 3, background: d.fill }} />
                <span style={{ fontWeight: 600 }}>{d.name}</span>
                <span style={{ color: '#94a3b8' }}>₹{Number(d.value).toFixed(1)} Cr</span>
              </div>
            ))}
          </div>

          {/* ARR Breakdown */}
          <h4 style={{ fontSize: 15, fontWeight: 700, marginBottom: 12, marginTop: 8, color: '#1e293b' }}>ARR Breakdown</h4>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16 }}>
            <div style={{ background: '#f0f9ff', borderRadius: 10, padding: 14, textAlign: 'center', border: '1px solid #bae6fd' }}>
              <div style={{ fontSize: 11, color: '#0369a1', marginBottom: 4 }}>Total ARR Target</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: '#0c4a6e' }}>₹{arrTarget.toFixed(1)} Cr</div>
            </div>
            <div style={{ background: '#f0fdf4', borderRadius: 10, padding: 14, textAlign: 'center', border: '1px solid #bbf7d0' }}>
              <div style={{ fontSize: 11, color: '#166534', marginBottom: 4 }}>ARR Achieved</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: '#14532d' }}>₹{arrAch.toFixed(1)} Cr</div>
            </div>
            <div style={{ background: '#fef2f2', borderRadius: 10, padding: 14, textAlign: 'center', border: '1px solid #fecaca' }}>
              <div style={{ fontSize: 11, color: '#991b1b', marginBottom: 4 }}>Remaining Target</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: '#7f1d1d' }}>₹{pc.remainingTarget.toFixed(1)} Cr</div>
            </div>
          </div>

          {/* Coverage interpretation */}
          <div style={{ background: `${covColor}10`, border: `1px solid ${covColor}30`, borderRadius: 10, padding: 16, marginTop: 8 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: covColor, marginBottom: 4 }}>
              {pc.coverage >= 3 ? '✅ Healthy Coverage' : pc.coverage >= 1 ? '⚠️ Needs Attention' : '🔴 Critical — Pipeline Below Target'}
            </div>
            <div style={{ fontSize: 12, color: '#475569' }}>
              {pc.coverage >= 3
                ? `Pipeline of ₹${pc.openPipeline.toFixed(0)} Cr is ${pc.coverage.toFixed(1)}x the remaining ARR target. This is healthy — a 3x coverage is the recommended benchmark.`
                : pc.coverage >= 1
                ? `Pipeline of ₹${pc.openPipeline.toFixed(0)} Cr covers ${pc.coverage.toFixed(1)}x the remaining target. Aim for at least 3x coverage to de-risk the number.`
                : `Pipeline of ₹${pc.openPipeline.toFixed(0)} Cr is below the remaining target of ₹${pc.remainingTarget.toFixed(1)} Cr. Urgent pipeline generation needed.`
              }
            </div>
          </div>
        </div>
      );
    }

    return <p>No detail available.</p>;
  };

  return (
    <div onClick={onClose} style={{
      position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
      background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(6px)',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      zIndex: 9999, animation: 'fadeIn 0.2s ease',
    }}>
      <div className="drill-modal-content" onClick={e => e.stopPropagation()} style={{
        background: '#fff', borderRadius: 16, padding: 28,
        width: '92vw', maxWidth: 1100, maxHeight: '90vh', overflowY: 'auto',
        position: 'relative', animation: 'slideUp 0.3s ease',
        boxShadow: '0 24px 48px rgba(0,0,0,0.2)',
      }}>
        <button onClick={onClose} style={{
          position: 'absolute', top: 14, right: 14, width: 34, height: 34, borderRadius: 8,
          border: '1px solid #e2e8f0', background: '#fff', fontSize: 16, cursor: 'pointer',
          display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#64748b',
        }}>✕</button>
        <h3 style={{ fontSize: 20, fontWeight: 700, color: '#1a1a2e', marginBottom: 4 }}>{titles[section] || 'Detail View'}</h3>
        <p style={{ fontSize: 13, color: '#94a3b8', marginBottom: 20 }}>Click outside or ✕ to close</p>
        {renderContent()}
      </div>
    </div>
  );
};

/* ================================================================
   Main Dashboard Content
   ================================================================ */
function DashboardContent() {
  const {
    isLive, lastUpdated, data, loading,
    annualMetrics, monthlyBilling, monthlyCollection,
    quarterlyQBRs, quarterlyHeroStories,
    quarterlyNewLogos, newLogosTotals,
    billingTotals, collectionTotals,
    weightages, quarterlyARR, quarterlyServiceRev, pipelineCoverage,
    ragMetrics: serverRagMetrics,
    availableFunctions, selectedFunction, changeFunction,
    availableYears, selectedFY, changeFY,
  } = useKamDataContext();

  // RAG metrics: merge server data + localStorage fallback + optimistic local state
  const [localRag, setLocalRag] = useState({});

  // Load from localStorage on mount and when function/FY changes
  const lsKey = `rag_${selectedFunction}_${selectedFY}`;
  const storedRag = useMemo(() => {
    try { return JSON.parse(localStorage.getItem(lsKey) || '{}'); }
    catch { return {}; }
  }, [lsKey, localRag]); // re-read when localRag changes (because we write to LS on save)

  // Merge: server data < localStorage < optimistic local state
  const ragMetrics = { ...(serverRagMetrics || {}), ...storedRag, ...localRag };

  // Reset optimistic state when server sends fresh data (WebSocket update)
  useEffect(() => { setLocalRag({}); }, [serverRagMetrics]);

  const updateRAG = useCallback(async (key, value) => {
    // Optimistic local update
    setLocalRag(prev => ({ ...prev, [key]: value }));

    // Always save to localStorage immediately (so it persists on refresh)
    const currentLsKey = `rag_${selectedFunction}_${selectedFY}`;
    const stored = JSON.parse(localStorage.getItem(currentLsKey) || '{}');
    stored[key] = value;
    localStorage.setItem(currentLsKey, JSON.stringify(stored));

    // Also try to save to server (Excel) for persistence across users
    try {
      const resp = await fetch('http://localhost:3001/api/rag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ function: selectedFunction, fy: selectedFY, key, value }),
      });
      if (resp.ok) {
        // Server saved successfully — clear localStorage for this key since Excel is source of truth
        // (will be re-read from server on next load)
      }
    } catch {
      // Server offline — localStorage already saved above, so data persists
    }
  }, [selectedFunction, selectedFY]);

  const [drillSection, setDrillSection] = useState(null);
  const [showTakeaways, setShowTakeaways] = useState(false);
  const [showScorecard, setShowScorecard] = useState(false);
  const [showBalancedImg, setShowBalancedImg] = useState(false);
  const [collapsedSections, setCollapsedSections] = useState({});
  const toggleSection = useCallback((sectionKey) => {
    setCollapsedSections(prev => ({ ...prev, [sectionKey]: !prev[sectionKey] }));
  }, []);
  const [pdfExporting, setPdfExporting] = useState(false);
  const dashboardRef = useRef(null);

  /* ---------- PDF Download ---------- */
  const handleDownloadPDF = useCallback(async () => {
    if (pdfExporting || !dashboardRef.current) return;
    setPdfExporting(true);
    try {
      const html2canvas = (await import('html2canvas')).default;
      const { jsPDF } = await import('jspdf');

      const el = dashboardRef.current;

      // Temporarily expand to full content for capture
      const origHeight = el.style.height;
      const origOverflow = el.style.overflow;
      el.style.height = 'auto';
      el.style.overflow = 'visible';

      const canvas = await html2canvas(el, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#f8fafc',
        logging: false,
        windowWidth: 1440,  // Force desktop-width capture
      });

      // Restore original styles
      el.style.height = origHeight;
      el.style.overflow = origOverflow;

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;

      // Landscape A4
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const ratio = Math.min(pageW / imgWidth, pageH / imgHeight);
      const w = imgWidth * ratio;
      const h = imgHeight * ratio;
      const x = (pageW - w) / 2;
      const y = (pageH - h) / 2;

      pdf.addImage(imgData, 'PNG', x, y, w, h);

      const fyLabel = selectedFY || 'FY';
      pdf.save(`${selectedFunction}_OKR_Dashboard_${fyLabel}.pdf`);
    } catch (err) {
      console.error('PDF export failed:', err);
    } finally {
      setPdfExporting(false);
    }
  }, [pdfExporting, selectedFunction, selectedFY]);
  const openDrill = useCallback((section) => setDrillSection(section), []);
  const closeDrill = useCallback(() => setDrillSection(null), []);

  // Dynamic document title
  React.useEffect(() => {
    const fyPart = selectedFY ? ` ${selectedFY}` : '';
    document.title = `BusinessNext — ${selectedFunction} OKR Dashboard${fyPart}`;
  }, [selectedFunction, selectedFY]);

  /* ---------- Timeliness Score Calculation ---------- */
  const billingTimeliness = useMemo(() => computeTimelinessScore(monthlyBilling), [monthlyBilling]);
  const collectionTimeliness = useMemo(() => computeTimelinessScore(monthlyCollection), [monthlyCollection]);

  /* ---------- OKR Score Calculation (data-driven from weightages) ---------- */
  const { okrScore, metricAchievements } = useMemo(() => {
    const safeDiv = (a, b) => (b === 0 ? 0 : a / b);
    const qbrAchTotal = quarterlyQBRs.reduce((s, q) => s + q.achievement, 0);
    const qbrTarTotal = quarterlyQBRs.reduce((s, q) => s + q.target, 0);
    const heroAchTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.achievement, 0);
    const heroTarTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.target, 0);
    const nlAchTotal = (quarterlyNewLogos || []).reduce((s, q) => s + q.achievement, 0);
    const nlTarTotal = (quarterlyNewLogos || []).reduce((s, q) => s + q.target, 0);

    const pcCoverage = pipelineCoverage?.coverage || 0;

    // Build raw achievements for all possible metrics
    const raw = {};
    if (weightages.arr) raw.arr = safeDiv(annualMetrics?.arr?.achievementTillDate || 0, annualMetrics?.arr?.targetFY26 || 1);
    if (weightages.serviceRev) raw.serviceRev = safeDiv(annualMetrics?.serviceRev?.achievementTillDate || 0, annualMetrics?.serviceRev?.targetFY26 || 1);
    if (weightages.pipelineCoverage) raw.pipelineCoverage = pcCoverage / 3; // achievement vs 3x benchmark
    if (weightages.ndr) raw.ndr = safeDiv(annualMetrics?.ndr?.achievementTillDate || 0, annualMetrics?.ndr?.targetFY26 || 1);
    if (weightages.gdr) raw.gdr = safeDiv(annualMetrics?.gdr?.achievementTillDate || 0, annualMetrics?.gdr?.targetFY26 || 1);
    // NPS: improvement-based calculation when baseline exists
    // Achievement = (YearEnd - Baseline) / (Target - Baseline)
    if (weightages.nps) {
      const npsData = annualMetrics?.nps;
      if (npsData && npsData.baseline !== undefined && npsData.baseline !== null) {
        const improvement = (npsData.achievementTillDate || 0) - npsData.baseline;
        const totalNeeded = (npsData.targetFY26 || 0) - npsData.baseline;
        raw.nps = totalNeeded !== 0 ? Math.max(0, improvement / totalNeeded) : 0;
      } else {
        raw.nps = safeDiv(Math.max(0, npsData?.achievementTillDate || 0), npsData?.targetFY26 || 1);
      }
    }
    if (weightages.billing) raw.billing = billingTimeliness.score;
    if (weightages.collection) raw.collection = collectionTimeliness.score;
    if (weightages.qbr) raw.qbr = safeDiv(qbrAchTotal, qbrTarTotal);
    if (weightages.heroStories) raw.heroStories = safeDiv(heroAchTotal, heroTarTotal);
    if (weightages.newLogos) raw.newLogos = safeDiv(nlAchTotal, nlTarTotal);
    if (weightages.salesCapacity) raw.salesCapacity = safeDiv(annualMetrics?.salesCapacity?.achievementTillDate || 0, annualMetrics?.salesCapacity?.targetFY26 || 1);

    // RAG metrics: Red=0%, Amber=50%, Green=100%
    const ragToScore = (v) => v === 'green' ? 1.0 : v === 'amber' ? 0.5 : 0.0;
    if (weightages.capabilityAI) raw.capabilityAI = ragToScore(ragMetrics?.capabilityAI);
    if (weightages.accountStrategy) raw.accountStrategy = ragToScore(ragMetrics?.accountStrategy);
    if (weightages.archDomain) raw.archDomain = ragToScore(ragMetrics?.archDomain);

    const capped = {};
    for (const key of Object.keys(raw)) capped[key] = Math.min(Math.max(raw[key], 0), 1.0);
    let score = 0;
    for (const key of Object.keys(capped)) score += capped[key] * (weightages[key]?.weight || 0);
    return { okrScore: score, metricAchievements: raw };
  }, [annualMetrics, billingTimeliness, collectionTimeliness, quarterlyQBRs, quarterlyHeroStories, quarterlyNewLogos, weightages, pipelineCoverage, ragMetrics]);

  /* ---------- Health Banner Stats ---------- */
  const healthStats = useMemo(() => {
    const activeKeys = Object.keys(weightages).filter(k => weightages[k]);
    const total = activeKeys.length;
    let onTrack = 0, atRisk = 0, critical = 0;
    const criticalMetrics = [];
    const atRiskMetrics = [];
    const metricLabels = {
      arr: 'ARR', serviceRev: 'Service Rev', ndr: 'NDR', gdr: 'GDR',
      billing: 'Billing', collection: 'Collection', nps: 'NPS',
      pipelineCoverage: 'Pipeline', qbr: 'QBRs', heroStories: 'Hero Stories',
      newLogos: 'New Logos', salesCapacity: 'Sales Capacity',
      capabilityAI: 'AI Capability', accountStrategy: 'Account Strategy', archDomain: 'Arch & Domain',
    };
    activeKeys.forEach(k => {
      const ach = metricAchievements[k] ?? 0;
      if (ach >= 0.8) { onTrack++; }
      else if (ach >= 0.6) { atRisk++; atRiskMetrics.push(metricLabels[k] || k); }
      else { critical++; criticalMetrics.push(metricLabels[k] || k); }
    });
    const overallStatus = critical > 0 ? 'critical' : atRisk > 0 ? 'at-risk' : 'on-track';
    return { total, onTrack, atRisk, critical, overallStatus, criticalMetrics, atRiskMetrics };
  }, [weightages, metricAchievements]);

  /* ---------- Takeaways ---------- */
  const takeaways = useMemo(() =>
    generateTakeaways(annualMetrics, billingTotals, collectionTotals, billingTimeliness.score, collectionTimeliness.score, quarterlyQBRs, quarterlyHeroStories, quarterlyNewLogos, newLogosTotals),
    [annualMetrics, billingTotals, collectionTotals, billingTimeliness, collectionTimeliness, quarterlyQBRs, quarterlyHeroStories, quarterlyNewLogos, newLogosTotals]
  );

  /* ---------- All metric tiles (data-driven from weightages) ---------- */
  const metricTileConfig = {
    arr: { label: 'ARR', drill: 'arr' },
    serviceRev: { label: 'Service Revenue', drill: 'serviceRev' },
    pipelineCoverage: { label: 'Pipeline Coverage', drill: 'pipelineCoverage', isCoverage: true },
    ndr: { label: 'NDR', drill: 'ndr' },
    gdr: { label: 'GDR', drill: 'gdr' },
    nps: { label: 'NPS', drill: 'nps' },
    billing: { label: 'Billing (Timeliness)', drill: 'billing' },
    collection: { label: 'Collection (Timeliness)', drill: 'collection' },
    qbr: { label: 'QBRs Held', drill: 'qbr' },
    heroStories: { label: 'Hero Stories', drill: 'heroStories' },
    newLogos: { label: '# of New Logos', drill: 'newLogos' },
    salesCapacity: { label: 'Sales Capacity', drill: 'salesCapacity' },
    capabilityAI: { label: 'Capability Development in AI', isRAG: true },
    accountStrategy: { label: selectedFunction === 'SALES' ? 'Account Coverage Strategy' : 'Published Account Strategy', isRAG: true },
    archDomain: { label: 'Architecture & Domain Knowledge', isRAG: true },
  };
  const metricTiles = Object.keys(weightages)
    .filter(key => metricTileConfig[key])
    .map(key => ({
      key,
      label: metricTileConfig[key].label,
      achievement: metricAchievements[key] || 0,
      weight: weightages[key]?.weight || 0,
      drill: metricTileConfig[key].drill,
      isCoverage: metricTileConfig[key].isCoverage || false,
      isRAG: metricTileConfig[key].isRAG || false,
      ragValue: ragMetrics?.[key] || 'red',
    }))
    .sort((a, b) => b.weight - a.weight);

  /* ---------- Balanced Scorecard Section Groupings ---------- */
  const BSC_SECTIONS = useMemo(() => {
    if (selectedFunction === 'SALES') {
      return [
        { key: 'financial', label: 'Financial', icon: '💰', metrics: ['arr', 'billing', 'collection', 'newLogos'] },
        { key: 'customer', label: 'Customer', icon: '🤝', metrics: ['nps'] },
        { key: 'internalProcess', label: 'Internal Process', icon: '⚙️', metrics: ['pipelineCoverage', 'accountStrategy', 'qbr', 'salesCapacity'] },
        { key: 'learningGrowth', label: 'Learning & Growth', icon: '📚', metrics: ['capabilityAI', 'archDomain'] },
      ];
    }
    return [
      { key: 'financial', label: 'Financial', icon: '💰', metrics: ['arr', 'serviceRev', 'ndr', 'gdr', 'billing', 'collection'] },
      { key: 'customer', label: 'Customer', icon: '🤝', metrics: ['nps'] },
      { key: 'internalProcess', label: 'Internal Process', icon: '⚙️', metrics: ['pipelineCoverage', 'accountStrategy', 'qbr', 'heroStories'] },
      { key: 'learningGrowth', label: 'Learning & Growth', icon: '📚', metrics: ['capabilityAI', 'archDomain'] },
    ];
  }, [selectedFunction]);

  /* ---------- Helper for sparkline data ---------- */
  const qbrCombined = quarterlyQBRs.map((q, i) => ({
    q: q.quarter.replace(/FY\d+/, '').trim(),
    qbr: q.achievement, qbrTarget: q.target,
    hero: (quarterlyHeroStories || [])[i]?.achievement || 0, heroTarget: (quarterlyHeroStories || [])[i]?.target || 0,
  }));
  const qbrTotal = quarterlyQBRs.reduce((s, q) => s + q.achievement, 0);
  const qbrTargetTotal = quarterlyQBRs.reduce((s, q) => s + q.target, 0);
  const heroTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.achievement, 0);
  const heroTargetTotal = (quarterlyHeroStories || []).reduce((s, q) => s + q.target, 0);
  const heroCombined = (quarterlyHeroStories || []).map(q => ({
    q: q.quarter.replace(/FY\d+/, '').trim(),
    hero: q.achievement, heroTarget: q.target, percentage: q.percentage,
  }));
  // New Logos helpers
  const nlData = (quarterlyNewLogos || []).map(q => ({
    q: q.quarter.replace(/FY\d+/, '').trim(),
    ...q,
  }));
  const nlTotal = (quarterlyNewLogos || []).reduce((s, q) => s + q.achievement, 0);
  const nlTargetTotal = (quarterlyNewLogos || []).reduce((s, q) => s + q.target, 0);

  /* ---------- Render ---------- */
  return (
    <div ref={dashboardRef} className="dashboard-shell" style={{
      height: '100vh', overflow: 'hidden', display: 'flex', flexDirection: 'column',
      background: '#f8fafc', fontFamily: "'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif",
    }}>

      {/* ====== Header Bar ====== */}
      <header className="dashboard-header" style={{
        height: 46, minHeight: 46, display: 'flex', alignItems: 'center', justifyContent: 'space-between',
        padding: '0 20px', background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
        color: '#fff', flexShrink: 0,
      }}>
        <div className="header-left" style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
          <span className="bn-logo"><BusinessNextLogo /></span>
          <select value={selectedFunction} onChange={e => changeFunction(e.target.value)} style={{
            background: 'rgba(232,31,118,0.15)', color: '#E81F76', border: '1px solid rgba(232,31,118,0.3)',
            borderRadius: 6, padding: '3px 8px', fontSize: 13, fontWeight: 800, cursor: 'pointer',
            outline: 'none', letterSpacing: 0.5,
          }}>
            {availableFunctions.map(f => <option key={f} value={f}>{f}</option>)}
          </select>
          <span style={{ fontSize: 13, fontWeight: 700, letterSpacing: -0.3, color: '#e2e8f0' }}>OKR Dashboard</span>
          {availableYears.length > 0 && <>
            <span style={{ fontSize: 11, color: '#64748b', margin: '0 2px' }}>—</span>
            <select value={selectedFY} onChange={e => changeFY(e.target.value)} style={{
              background: 'rgba(232,31,118,0.15)', color: '#E81F76', border: '1px solid rgba(232,31,118,0.3)',
              borderRadius: 6, padding: '3px 8px', fontSize: 12, fontWeight: 800, cursor: 'pointer',
              outline: 'none', letterSpacing: 0.5,
            }}>
              {availableYears.map(fy => <option key={fy} value={fy}>{fy}</option>)}
            </select>
          </>}
        </div>
        <div className="header-right" style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          {/* Scorecard Summary Button (dynamic data table) */}
          {data && (
            <button onClick={() => setShowScorecard(true)} style={{
              display: 'flex', alignItems: 'center', gap: 5, padding: '4px 12px', borderRadius: 6,
              border: '1px solid rgba(232,31,118,0.4)', background: 'rgba(232,31,118,0.1)',
              color: '#E81F76', fontSize: 10, fontWeight: 700, cursor: 'pointer',
              textTransform: 'uppercase', letterSpacing: 0.5, transition: 'all 0.2s',
            }}
              onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.2)'; }}
              onMouseLeave={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.1)'; }}
            >
              📊<span className="btn-label"> Scorecard Summary</span>
            </button>
          )}
          {/* Balanced Scorecard Button (image popup) */}
          {data && (
            <button onClick={() => setShowBalancedImg(true)} style={{
              display: 'flex', alignItems: 'center', gap: 5, padding: '4px 12px', borderRadius: 6,
              border: '1px solid rgba(232,31,118,0.4)', background: 'rgba(232,31,118,0.1)',
              color: '#E81F76', fontSize: 10, fontWeight: 700, cursor: 'pointer',
              textTransform: 'uppercase', letterSpacing: 0.5, transition: 'all 0.2s',
            }}
              onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.2)'; }}
              onMouseLeave={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.1)'; }}
            >
              🎯<span className="btn-label"> Balanced Scorecard</span>
            </button>
          )}
          {/* PDF Download Button */}
          <button onClick={handleDownloadPDF} disabled={pdfExporting} style={{
            display: 'flex', alignItems: 'center', gap: 5, padding: '4px 12px', borderRadius: 6,
            border: '1px solid rgba(232,31,118,0.4)', background: 'rgba(232,31,118,0.1)',
            color: '#E81F76', fontSize: 10, fontWeight: 700, cursor: pdfExporting ? 'wait' : 'pointer',
            textTransform: 'uppercase', letterSpacing: 0.5, transition: 'all 0.2s',
            opacity: pdfExporting ? 0.6 : 1,
          }}
            onMouseEnter={e => { if (!pdfExporting) e.currentTarget.style.background = 'rgba(232,31,118,0.2)'; }}
            onMouseLeave={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.1)'; }}
          >
            {pdfExporting ? <><span>⏳</span><span className="btn-label"> Exporting...</span></> : <><span>📄</span><span className="btn-label"> Download PDF</span></>}
          </button>
          {/* Key Takeaways Button */}
          <button onClick={() => setShowTakeaways(true)} style={{
            display: 'flex', alignItems: 'center', gap: 5, padding: '4px 12px', borderRadius: 6,
            border: '1px solid rgba(232,31,118,0.4)', background: 'rgba(232,31,118,0.1)',
            color: '#E81F76', fontSize: 10, fontWeight: 700, cursor: 'pointer',
            textTransform: 'uppercase', letterSpacing: 0.5, transition: 'all 0.2s',
          }}
            onMouseEnter={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.2)'; }}
            onMouseLeave={e => { e.currentTarget.style.background = 'rgba(232,31,118,0.1)'; }}
          >
            📋<span className="btn-label"> Key Takeaways</span>
          </button>
          <span style={{
            display: 'flex', alignItems: 'center', gap: 4, fontSize: 10, fontWeight: 700,
            textTransform: 'uppercase', letterSpacing: 1, padding: '3px 8px', borderRadius: 20,
            background: isLive ? 'rgba(16,185,129,0.2)' : 'rgba(148,163,184,0.2)',
            color: isLive ? '#10b981' : '#94a3b8',
          }}>
            <span style={{
              width: 6, height: 6, borderRadius: '50%', flexShrink: 0,
              background: isLive ? '#10b981' : '#94a3b8',
              animation: isLive ? 'pulse-live 2s infinite' : 'none',
            }} />
            {isLive ? 'LIVE' : 'STATIC'}
          </span>
          {lastUpdated && <span className="header-timestamp" style={{ fontSize: 10, color: '#94a3b8' }}>{lastUpdated.toLocaleTimeString()}</span>}
          <span style={{ fontSize: 9, fontWeight: 600, background: 'rgba(232,31,118,0.15)', color: '#E81F76', padding: '2px 8px', borderRadius: 6 }}>INR Cr</span>
        </div>
      </header>

      {/* ====== Health Banner ====== */}
      {data && (() => {
        const hs = healthStats;
        const statusConfig = {
          'on-track':  { bg: 'linear-gradient(90deg, #059669, #10b981)', icon: '✅', label: 'On Track', glow: 'rgba(16,185,129,0.15)' },
          'at-risk':   { bg: 'linear-gradient(90deg, #d97706, #f59e0b)', icon: '⚠️', label: 'Needs Attention', glow: 'rgba(245,158,11,0.15)' },
          'critical':  { bg: 'linear-gradient(90deg, #dc2626, #ef4444)', icon: '🔴', label: 'At Risk', glow: 'rgba(239,68,68,0.15)' },
        };
        const cfg = statusConfig[hs.overallStatus];
        return (
          <div className="health-banner" style={{
            display: 'flex', alignItems: 'center', gap: 12, padding: '5px 16px',
            background: cfg.glow, borderBottom: '1px solid rgba(0,0,0,0.04)',
            animation: 'fadeIn 0.5s ease-out',
          }}>
            <div style={{
              display: 'flex', alignItems: 'center', gap: 6,
              background: cfg.bg, padding: '3px 12px', borderRadius: 20,
              color: '#fff', fontSize: 10, fontWeight: 800, letterSpacing: 0.5, textTransform: 'uppercase',
              boxShadow: `0 2px 8px ${cfg.glow}`,
            }}>
              <span>{cfg.icon}</span>
              <span>{cfg.label}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12, fontSize: 10, fontWeight: 600 }}>
              <span style={{ color: '#10b981' }}>● {hs.onTrack} On Track</span>
              {hs.atRisk > 0 && <span style={{ color: '#f59e0b' }}>● {hs.atRisk} Warning</span>}
              {hs.critical > 0 && <span style={{ color: '#ef4444' }}>● {hs.critical} Critical</span>}
              <span style={{ color: '#94a3b8' }}>({hs.onTrack}/{hs.total} metrics ≥80%)</span>
            </div>
            {hs.criticalMetrics.length > 0 && (
              <div style={{
                marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 4, fontSize: 9,
                color: '#ef4444', fontWeight: 600,
              }}>
                <span>🔻 Focus:</span>
                {hs.criticalMetrics.slice(0, 3).map((m, i) => (
                  <span key={i} style={{ background: 'rgba(239,68,68,0.1)', padding: '1px 7px', borderRadius: 8, fontSize: 9 }}>{m}</span>
                ))}
                {hs.criticalMetrics.length > 3 && <span>+{hs.criticalMetrics.length - 3} more</span>}
              </div>
            )}
            {hs.criticalMetrics.length === 0 && hs.atRiskMetrics.length > 0 && (
              <div style={{
                marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 4, fontSize: 9,
                color: '#f59e0b', fontWeight: 600,
              }}>
                <span>⚡ Watch:</span>
                {hs.atRiskMetrics.slice(0, 3).map((m, i) => (
                  <span key={i} style={{ background: 'rgba(245,158,11,0.1)', padding: '1px 7px', borderRadius: 8, fontSize: 9 }}>{m}</span>
                ))}
                {hs.atRiskMetrics.length > 3 && <span>+{hs.atRiskMetrics.length - 3} more</span>}
              </div>
            )}
          </div>
        );
      })()}

      {/* ====== Loading screen while switching functions / fetching data ====== */}
      {loading && !data && (
        <div style={{
          flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
          gap: 20,
        }}>
          <style>{`
            @keyframes spinRing { to { transform: rotate(360deg); } }
            @keyframes loadPulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
          `}</style>
          <div style={{ position: 'relative', width: 56, height: 56 }}>
            <div style={{
              width: 56, height: 56, borderRadius: '50%',
              border: '3px solid #f1f5f9',
              borderTopColor: '#E81F76',
              animation: 'spinRing 0.9s linear infinite',
            }} />
            <div style={{
              position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
              fontSize: 20,
            }}>📊</div>
          </div>
          <div style={{ textAlign: 'center' }}>
            <div style={{
              fontSize: 15, fontWeight: 700, color: '#1e293b', marginBottom: 4,
              animation: 'loadPulse 1.5s ease-in-out infinite',
            }}>
              Loading {selectedFunction || ''} Dashboard...
            </div>
            <div style={{ fontSize: 12, color: '#94a3b8' }}>
              Fetching {selectedFY || ''} data
            </div>
          </div>
        </div>
      )}

      {/* ====== Placeholder when no data is available ====== */}
      {!loading && !data && selectedFunction && (
        <div style={{
          flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
          padding: 40, textAlign: 'center', gap: 16,
        }}>
          <div style={{ fontSize: 48, opacity: 0.3 }}>📊</div>
          <h2 style={{ fontSize: 22, fontWeight: 800, color: '#1e293b', margin: 0 }}>
            {selectedFunction} Dashboard
          </h2>
          <p style={{ fontSize: 14, color: '#64748b', maxWidth: 420, lineHeight: 1.6 }}>
            No data available for <strong>{selectedFunction}</strong> yet. Place a <code style={{
              background: '#f1f5f9', padding: '2px 6px', borderRadius: 4, fontSize: 12,
            }}>{selectedFunction}_Dashboard_FY26.xlsx</code> file in the server folder to get started.
          </p>
          <div style={{
            marginTop: 8, padding: '10px 20px', borderRadius: 8,
            background: 'linear-gradient(135deg, #1a1a2e, #16213e)',
            color: '#94a3b8', fontSize: 11, fontWeight: 600,
          }}>
            Generate a template: <code style={{ color: '#E81F76' }}>node generate-template.cjs {selectedFunction} FY26</code>
          </div>
        </div>
      )}

      {/* ====== Main Body (all functions with data) ====== */}
      {data && (
      <div className="dashboard-body" style={{ flex: 1, display: 'flex', overflow: 'hidden', padding: 8, gap: 8 }}>

        {/* ---- Left Column: OKR Gauge + All Metric Tiles ---- */}
        <div className="dashboard-sidebar" style={{
          width: '24%', minWidth: 220, display: 'flex', flexDirection: 'column', gap: 6,
          background: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)',
          borderRadius: 12, padding: 10, overflow: 'hidden',
          animation: 'slideUp 0.5s ease-out',
        }}>
          <div className="okr-gauge-wrap" style={{ display: 'flex', justifyContent: 'center', flexShrink: 0 }}>
            <OKRScoreGauge score={okrScore} size={140} />
          </div>
          <div className="okr-label" style={{
            textAlign: 'center', fontSize: 10, fontWeight: 700,
            color: '#E81F76', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 2,
          }}>Cumulative OKR Score</div>
          <div className="metric-tiles-scroll" style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: 2, overflowY: 'auto', paddingRight: 3 }}>
            {BSC_SECTIONS.map(section => {
              const sectionTiles = section.metrics
                .filter(k => weightages[k] && metricTileConfig[k])
                .map(k => metricTiles.find(t => t.key === k))
                .filter(Boolean);
              if (sectionTiles.length === 0) return null;
              const isCollapsed = !!collapsedSections[section.key];
              return (
                <div key={section.key}>
                  <SidebarSectionHeader label={section.label} isCollapsed={isCollapsed}
                    onToggle={() => toggleSection(section.key)} />
                  {!isCollapsed && sectionTiles.map(tile => (
                    <MetricTile key={tile.key} label={tile.label} achievement={tile.achievement}
                      weight={tile.weight} onClick={tile.drill ? () => openDrill(tile.drill) : undefined}
                      isCoverage={tile.isCoverage}
                      isRAG={tile.isRAG} ragValue={tile.ragValue}
                      onRAGChange={tile.isRAG ? (val) => updateRAG(tile.key, val) : undefined} />
                  ))}
                </div>
              );
            })}
          </div>
        </div>

        {/* ---- Right Area: Sectioned metric cards grid ---- */}
        <div className="dashboard-metrics-grid" style={{
          flex: 1, display: 'flex', flexDirection: 'column',
          gap: 2, overflowY: 'auto', overflowX: 'hidden',
        }}>
          {(() => { let cardIdx = 0; return BSC_SECTIONS.map(section => {
            const activeMetrics = section.metrics.filter(k => weightages[k]);
            if (activeMetrics.length === 0) return null;
            const isCollapsed = !!collapsedSections[section.key];
            const sectionWeight = activeMetrics.reduce((s, k) => s + (weightages[k]?.weight || 0), 0);
            const sectionAchievedWt = activeMetrics.reduce((s, k) => {
              const ach = Math.min(metricAchievements[k] || 0, 1);
              return s + ach * (weightages[k]?.weight || 0);
            }, 0);
            return (
              <div key={section.key} style={{ marginBottom: 2 }}>
                <SectionHeader label={section.label} icon={section.icon} isCollapsed={isCollapsed}
                  onToggle={() => toggleSection(section.key)} metricCount={activeMetrics.length}
                  sectionWeight={sectionWeight} sectionAchieved={sectionAchievedWt} />
                {!isCollapsed && (
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8, padding: '4px 0' }}>
                    {activeMetrics.map(mk => { const ci = cardIdx++;
                      /* ---- ARR ---- */
                      if (mk === 'arr' && annualMetrics?.arr) return (
                        <MetricSummaryCard key="arr" title="ARR" value={formatCrore(annualMetrics.arr.achievementTillDate, 1)}
                          target={annualMetrics.arr.targetFY26.toFixed(1)} unit="Cr"
                          achievement={metricAchievements.arr} color="#6366f1" onClick={() => openDrill('arr')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          {(quarterlyARR || []).length > 0 && (
                            <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                              <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={quarterlyARR} margin={{ top: 12, right: 4, bottom: 2, left: 4 }} barGap={2}>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                  <XAxis dataKey="quarter" tick={{ fontSize: 9, fill: '#94a3b8' }} axisLine={false} tickLine={false}
                                    tickFormatter={(v) => v.replace(/FY\d+\s*/, '')} />
                                  <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                    formatter={(v, name) => [`${Number(v).toFixed(1)} Cr`, name === 'target' ? 'Target' : 'Actual']}
                                    labelFormatter={(l) => l} />
                                  <Bar dataKey="target" fill="#c7d2fe" radius={[3, 3, 0, 0]} barSize={10} name="target" label={<BarLabel fill="#a5b4c8" />} />
                                  <Bar dataKey="achievement" radius={[3, 3, 0, 0]} barSize={10} name="achievement" label={<BarLabel fill="#6366f1" />}>
                                    {(quarterlyARR || []).map((e, i) => <Cell key={i} fill={getAchievementColor(e.percentage)} />)}
                                  </Bar>
                                </BarChart>
                              </ResponsiveContainer>
                              <MiniLegend items={[{ color: '#c7d2fe', label: 'Target' }, { color: '#6366f1', label: 'Actual' }]} />
                            </div>
                          )}
                        </MetricSummaryCard>
                      );
                      /* ---- Service Revenue ---- */
                      if (mk === 'serviceRev') return (
                        <MetricSummaryCard key="serviceRev" title="Service Revenue" value={formatCrore(annualMetrics?.serviceRev?.achievementTillDate || 0, 0)}
                          target={annualMetrics?.serviceRev?.targetFY26 || 0} unit="Cr"
                          achievement={metricAchievements.serviceRev} color="#8b5cf6" onClick={() => openDrill('serviceRev')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          {(quarterlyServiceRev || []).length > 0 && (
                            <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                              <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={quarterlyServiceRev} margin={{ top: 12, right: 4, bottom: 2, left: 4 }} barGap={2}>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                  <XAxis dataKey="quarter" tick={{ fontSize: 9, fill: '#94a3b8' }} axisLine={false} tickLine={false}
                                    tickFormatter={(v) => v.replace(/FY\d+\s*/, '')} />
                                  <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                    formatter={(v, name) => [`${Number(v).toFixed(1)} Cr`, name === 'target' ? 'Target' : 'Actual']}
                                    labelFormatter={(l) => l} />
                                  <Bar dataKey="target" fill="#c7d2fe" radius={[3, 3, 0, 0]} barSize={10} name="target" label={<BarLabel fill="#a5b4c8" />} />
                                  <Bar dataKey="achievement" radius={[3, 3, 0, 0]} barSize={10} name="achievement" label={<BarLabel fill="#8b5cf6" />}>
                                    {(quarterlyServiceRev || []).map((e, i) => <Cell key={i} fill={getAchievementColor(e.percentage)} />)}
                                  </Bar>
                                </BarChart>
                              </ResponsiveContainer>
                              <MiniLegend items={[{ color: '#c7d2fe', label: 'Target' }, { color: '#8b5cf6', label: 'Actual' }]} />
                            </div>
                          )}
                        </MetricSummaryCard>
                      );
                      /* ---- NDR ---- */
                      if (mk === 'ndr' && annualMetrics?.ndr) return (
                        <MetricSummaryCard key="ndr" title="NDR" value={`${(annualMetrics.ndr.achievementTillDate * 100).toFixed(0)}%`}
                          target={`${(annualMetrics.ndr.targetFY26 * 100).toFixed(0)}`} unit="%"
                          achievement={metricAchievements.ndr} color="#06b6d4" onClick={() => openDrill('ndr')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <MiniGauge value={annualMetrics.ndr.achievementTillDate} target={annualMetrics.ndr.targetFY26}
                            label="NDR" color={getAchievementColor(metricAchievements.ndr)} format="percent" />
                        </MetricSummaryCard>
                      );
                      /* ---- GDR ---- */
                      if (mk === 'gdr' && annualMetrics?.gdr) return (
                        <MetricSummaryCard key="gdr" title="GDR" value={`${(annualMetrics.gdr.achievementTillDate * 100).toFixed(0)}%`}
                          target={`${(annualMetrics.gdr.targetFY26 * 100).toFixed(0)}`} unit="%"
                          achievement={metricAchievements.gdr} color="#14b8a6" onClick={() => openDrill('gdr')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <MiniGauge value={annualMetrics.gdr.achievementTillDate} target={annualMetrics.gdr.targetFY26}
                            label="GDR" color={getAchievementColor(metricAchievements.gdr)} format="percent" />
                        </MetricSummaryCard>
                      );
                      /* ---- Billing Timeliness ---- */
                      if (mk === 'billing') return (
                        <MetricSummaryCard key="billing" title="Billing Timeliness" value={`${(billingTimeliness.score * 100).toFixed(0)}%`}
                          target="100" unit="%" achievement={billingTimeliness.score} color="#6366f1" onClick={() => openDrill('billing')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                            <ResponsiveContainer width="100%" height="100%">
                              <ComposedChart data={monthlyBilling.filter(d => d.achievement !== null)} margin={{ top: 4, right: 4, bottom: 2, left: 4 }}>
                                <defs><linearGradient id="sparkBill" x1="0" y1="0" x2="0" y2="1">
                                  <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3} /><stop offset="95%" stopColor="#6366f1" stopOpacity={0.02} />
                                </linearGradient></defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                <XAxis dataKey="month" tick={{ fontSize: 8, fill: '#94a3b8' }} axisLine={false} tickLine={false}
                                  tickFormatter={(v) => v.substring(0, 3)} interval={1} />
                                <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                  formatter={(v, name) => [`${Number(v).toFixed(1)} Cr`, name === 'target' ? 'Target' : 'Billed']}
                                  labelFormatter={(l) => `${l}`} />
                                <Area type="monotone" dataKey="achievement" stroke="#6366f1" strokeWidth={1.5} fill="url(#sparkBill)" dot={false} activeDot={{ r: 3, fill: '#6366f1' }} name="achievement" />
                                <Line type="monotone" dataKey="target" stroke="#94a3b8" strokeWidth={1} strokeDasharray="3 3" dot={false} name="target" />
                              </ComposedChart>
                            </ResponsiveContainer>
                            <MiniLegend items={[{ color: '#6366f1', label: 'Billed' }, { color: '#94a3b8', label: 'Target' }]} />
                          </div>
                        </MetricSummaryCard>
                      );
                      /* ---- Collection Timeliness ---- */
                      if (mk === 'collection') return (
                        <MetricSummaryCard key="collection" title="Collection Timeliness" value={`${(collectionTimeliness.score * 100).toFixed(0)}%`}
                          target="100" unit="%" achievement={collectionTimeliness.score} color="#06b6d4" onClick={() => openDrill('collection')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                            <ResponsiveContainer width="100%" height="100%">
                              <ComposedChart data={monthlyCollection.filter(d => d.achievement !== null)} margin={{ top: 4, right: 4, bottom: 2, left: 4 }}>
                                <defs><linearGradient id="sparkColl" x1="0" y1="0" x2="0" y2="1">
                                  <stop offset="5%" stopColor="#06b6d4" stopOpacity={0.3} /><stop offset="95%" stopColor="#06b6d4" stopOpacity={0.02} />
                                </linearGradient></defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                <XAxis dataKey="month" tick={{ fontSize: 8, fill: '#94a3b8' }} axisLine={false} tickLine={false}
                                  tickFormatter={(v) => v.substring(0, 3)} interval={1} />
                                <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                  formatter={(v, name) => [`${Number(v).toFixed(1)} Cr`, name === 'target' ? 'Target' : 'Collected']}
                                  labelFormatter={(l) => `${l}`} />
                                <Area type="monotone" dataKey="achievement" stroke="#06b6d4" strokeWidth={1.5} fill="url(#sparkColl)" dot={false} activeDot={{ r: 3, fill: '#06b6d4' }} name="achievement" />
                                <Line type="monotone" dataKey="target" stroke="#94a3b8" strokeWidth={1} strokeDasharray="3 3" dot={false} name="target" />
                              </ComposedChart>
                            </ResponsiveContainer>
                            <MiniLegend items={[{ color: '#06b6d4', label: 'Collected' }, { color: '#94a3b8', label: 'Target' }]} />
                          </div>
                        </MetricSummaryCard>
                      );
                      /* ---- NPS ---- */
                      if (mk === 'nps' && annualMetrics?.nps) {
                        const npsM = annualMetrics.nps;
                        const npsBaseline = npsM.baseline ?? 0;
                        const npsImprovement = npsM.achievementTillDate - npsBaseline;
                        const npsTotal = npsM.targetFY26 - npsBaseline;
                        const npsPct = npsTotal !== 0 ? Math.max(0, (npsImprovement / npsTotal) * 100) : 0;
                        return (
                          <MetricSummaryCard key="nps" title="NPS Score" value={npsM.achievementTillDate}
                            target={`+${npsM.targetFY26}`} unit=""
                            achievement={metricAchievements.nps} color={npsPct >= 50 ? '#10b981' : npsPct >= 25 ? '#f59e0b' : '#ef4444'}
                            onClick={() => openDrill('nps')}
                            weight={weightages[mk]?.weight || 0} animIndex={ci}
                          >
                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: 4 }}>
                              <span style={{ fontSize: 28, fontWeight: 900, color: npsM.achievementTillDate >= 0 ? '#10b981' : '#E81F76' }}>
                                {npsM.achievementTillDate}
                              </span>
                              <div style={{ display: 'flex', justifyContent: 'space-between', width: '85%', fontSize: 9, marginBottom: -1 }}>
                                <span style={{ color: '#ef4444', fontWeight: 700 }}>Q1: {npsBaseline}</span>
                                <span style={{ color: '#10b981', fontWeight: 700 }}>Target: +{npsM.targetFY26}</span>
                              </div>
                              <div style={{ width: '85%', height: 5, background: '#e2e8f0', borderRadius: 3, overflow: 'hidden' }}>
                                <div style={{
                                  height: '100%', borderRadius: 3, transition: 'width 0.8s ease-out',
                                  width: `${Math.min(100, npsPct)}%`,
                                  background: npsPct >= 50 ? 'linear-gradient(90deg, #10b981, #34d399)' : npsPct >= 25 ? 'linear-gradient(90deg, #f59e0b, #fbbf24)' : 'linear-gradient(90deg, #ef4444, #f97316)',
                                }} />
                              </div>
                              <div style={{ fontSize: 9, color: '#64748b', textAlign: 'center', lineHeight: 1.4 }}>
                                Improved <strong style={{ color: '#E81F76' }}>{npsImprovement}</strong> of <strong>{npsTotal}</strong> pts needed
                              </div>
                            </div>
                          </MetricSummaryCard>
                        );
                      }
                      /* ---- Pipeline Coverage ---- */
                      if (mk === 'pipelineCoverage') return (
                        <MetricSummaryCard key="pipelineCoverage" title="Pipeline Coverage" value={`${(pipelineCoverage?.coverage || 0).toFixed(1)}x`}
                          target="3" unit="x" achievement={null} color="#0ea5e9" onClick={() => openDrill('pipelineCoverage')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          {(() => {
                            const cov = pipelineCoverage?.coverage || 0;
                            const pcColor = cov >= 3 ? '#10b981' : cov >= 1 ? '#f59e0b' : '#ef4444';
                            const maxScale = 5; const pctG = Math.min(cov / maxScale, 1); const benchmarkPct = 3 / maxScale;
                            const size = 120; const sw = 10; const r = (size - sw) / 2;
                            const halfC = Math.PI * r; const offset = halfC - pctG * halfC;
                            const bmAngle = Math.PI * (1 - benchmarkPct);
                            const tickLen = 8;
                            const bmX1 = size / 2 + (r - tickLen) * Math.cos(bmAngle);
                            const bmY1 = size / 2 - (r - tickLen) * Math.sin(bmAngle);
                            const bmX2 = size / 2 + (r + tickLen) * Math.cos(bmAngle);
                            const bmY2 = size / 2 - (r + tickLen) * Math.sin(bmAngle);
                            const lblX = size / 2 + (r + 16) * Math.cos(bmAngle);
                            const lblY = size / 2 - (r + 16) * Math.sin(bmAngle);
                            return (
                              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', height: '100%', justifyContent: 'center' }}>
                                <svg width={size} height={size / 2 + 18} viewBox={`0 0 ${size} ${size / 2 + 18}`}>
                                  <path d={`M ${sw / 2} ${size / 2} A ${r} ${r} 0 0 1 ${size - sw / 2} ${size / 2}`}
                                    fill="none" stroke="#e2e8f0" strokeWidth={sw} strokeLinecap="round" />
                                  <path d={`M ${sw / 2} ${size / 2} A ${r} ${r} 0 0 1 ${size - sw / 2} ${size / 2}`}
                                    fill="none" stroke={pcColor} strokeWidth={sw} strokeLinecap="round"
                                    strokeDasharray={halfC} strokeDashoffset={offset}
                                    style={{ transition: 'stroke-dashoffset 1s ease-out' }} />
                                  <line x1={bmX1} y1={bmY1} x2={bmX2} y2={bmY2} stroke="#0ea5e9" strokeWidth={2} strokeLinecap="round" />
                                  <text x={lblX} y={lblY} textAnchor="middle" dominantBaseline="middle" fontSize="7" fontWeight="700" fill="#0ea5e9">3x</text>
                                  <text x={size / 2} y={size / 2 - 4} textAnchor="middle" dominantBaseline="auto" fontSize="22" fontWeight="800" fill={pcColor}>{cov.toFixed(1)}x</text>
                                  <text x={sw / 2 + 2} y={size / 2 + 14} textAnchor="start" fontSize="7" fill="#94a3b8">0x</text>
                                  <text x={size - sw / 2 - 2} y={size / 2 + 14} textAnchor="end" fontSize="7" fill="#94a3b8">5x</text>
                                </svg>
                                <div style={{ display: 'flex', gap: 14, marginTop: 0, fontSize: 9, color: '#64748b', fontWeight: 600 }}>
                                  <span>Pipeline: ₹{(pipelineCoverage?.openPipeline || 0).toFixed(0)} Cr</span>
                                  <span>Rem. Target: ₹{(pipelineCoverage?.remainingTarget || 0).toFixed(1)} Cr</span>
                                </div>
                              </div>
                            );
                          })()}
                        </MetricSummaryCard>
                      );
                      /* ---- QBRs Held ---- */
                      if (mk === 'qbr') return (
                        <MetricSummaryCard key="qbr" title="QBRs Held" value={`${qbrTotal}/${qbrTargetTotal}`}
                          target={null} unit="" achievement={metricAchievements.qbr} color="#8b5cf6" onClick={() => openDrill('qbr')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                            <ResponsiveContainer width="100%" height="100%">
                              <BarChart data={qbrCombined} margin={{ top: 12, right: 4, bottom: 2, left: 4 }} barGap={2}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                <XAxis dataKey="q" tick={{ fontSize: 9, fill: '#94a3b8' }} axisLine={false} tickLine={false} />
                                <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                  formatter={(v, name) => [Number(v).toFixed(1), name === 'qbrTarget' ? 'Target' : 'QBRs']}
                                  labelFormatter={(l) => l} />
                                <Bar dataKey="qbrTarget" fill="#c7d2fe" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#a5b4c8" />} />
                                <Bar dataKey="qbr" fill="#8b5cf6" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#8b5cf6" />} />
                              </BarChart>
                            </ResponsiveContainer>
                            <MiniLegend items={[{ color: '#c7d2fe', label: 'Target' }, { color: '#8b5cf6', label: 'Done' }]} />
                          </div>
                        </MetricSummaryCard>
                      );
                      /* ---- Hero Stories ---- */
                      if (mk === 'heroStories') return (
                        <MetricSummaryCard key="heroStories" title="Hero Stories" value={`${heroTotal}/${heroTargetTotal}`}
                          target={null} unit="" achievement={heroTargetTotal > 0 ? heroTotal / heroTargetTotal : 0} color="#f97316"
                          onClick={() => openDrill('heroStories')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                            <ResponsiveContainer width="100%" height="100%">
                              <BarChart data={heroCombined} margin={{ top: 12, right: 4, bottom: 2, left: 4 }} barGap={2}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                <XAxis dataKey="q" tick={{ fontSize: 9, fill: '#94a3b8' }} axisLine={false} tickLine={false} />
                                <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                  formatter={(v, name) => [Number(v).toFixed(1), name === 'heroTarget' ? 'Target' : 'Hero Stories']}
                                  labelFormatter={(l) => l} />
                                <Bar dataKey="heroTarget" fill="#fed7aa" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#c2956a" />} />
                                <Bar dataKey="hero" fill="#f97316" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#f97316" />} />
                              </BarChart>
                            </ResponsiveContainer>
                            <MiniLegend items={[{ color: '#fed7aa', label: 'Target' }, { color: '#f97316', label: 'Done' }]} />
                          </div>
                        </MetricSummaryCard>
                      );
                      /* ---- New Logos ---- */
                      if (mk === 'newLogos') return (
                        <MetricSummaryCard key="newLogos" title="# of New Logos" value={`${nlTotal}/${nlTargetTotal}`}
                          target={null} unit="" achievement={metricAchievements.newLogos || 0} color="#f59e0b" onClick={() => openDrill('newLogos')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          {nlData.length > 0 && (
                            <div className="metric-chart-wrap" style={{ display: 'flex', height: '100%', gap: 2 }}>
                              <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={nlData} margin={{ top: 12, right: 4, bottom: 2, left: 4 }} barGap={2}>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" vertical={false} />
                                  <XAxis dataKey="q" tick={{ fontSize: 9, fill: '#94a3b8' }} axisLine={false} tickLine={false} />
                                  <Tooltip contentStyle={{ fontSize: 11, borderRadius: 8, border: '1px solid #e2e8f0', padding: '6px 10px' }}
                                    formatter={(v, name) => [Number(v).toFixed(0), name === 'target' ? 'Target' : 'Acquired']}
                                    labelFormatter={(l) => l} />
                                  <Bar dataKey="target" fill="#fde68a" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#a5b4c8" />} />
                                  <Bar dataKey="achievement" radius={[3, 3, 0, 0]} barSize={10} label={<BarLabel fill="#f59e0b" />}>
                                    {nlData.map((e, i) => <Cell key={i} fill={getAchievementColor(e.percentage)} />)}
                                  </Bar>
                                </BarChart>
                              </ResponsiveContainer>
                              <MiniLegend items={[{ color: '#fde68a', label: 'Target' }, { color: '#f59e0b', label: 'Done' }]} />
                            </div>
                          )}
                        </MetricSummaryCard>
                      );
                      /* ---- Sales Capacity ---- */
                      if (mk === 'salesCapacity' && annualMetrics?.salesCapacity) return (
                        <MetricSummaryCard key="salesCapacity" title="Sales Capacity"
                          value={annualMetrics.salesCapacity.achievementTillDate}
                          target={annualMetrics.salesCapacity.targetFY26} unit=""
                          achievement={metricAchievements.salesCapacity || 0} color="#6366f1" onClick={() => openDrill('salesCapacity')}
                          weight={weightages[mk]?.weight || 0} animIndex={ci}
                        >
                          <MiniGauge value={annualMetrics.salesCapacity.achievementTillDate / (annualMetrics.salesCapacity.targetFY26 || 1)}
                            target={1} label="Capacity" color={getAchievementColor(metricAchievements.salesCapacity || 0)} format="percent" />
                        </MetricSummaryCard>
                      );
                      /* ---- RAG Metrics (individual cards) ---- */
                      if (mk === 'capabilityAI' || mk === 'accountStrategy' || mk === 'archDomain') return (
                        <RAGMetricCard key={mk} label={metricTileConfig[mk].label}
                          ragValue={ragMetrics?.[mk] || 'red'} achievement={metricAchievements[mk]}
                          weight={weightages[mk]?.weight || 0} onRAGChange={(val) => updateRAG(mk, val)} animIndex={ci} />
                      );
                      return null;
                    })}
                  </div>
                )}
              </div>
            );
          }); })()}
        </div>
      </div>
      )}

      {/* ====== Modals ====== */}
      {data && (
        <DrillDownModal section={drillSection} onClose={closeDrill}
          billingTimelinessData={billingTimeliness} collectionTimelinessData={collectionTimeliness}
          selectedFY={selectedFY} />
      )}
      {showTakeaways && <KeyTakeawaysModal takeaways={takeaways} onClose={() => setShowTakeaways(false)} />}
      {showScorecard && data && (
        <BalancedScorecardModal
          onClose={() => setShowScorecard(false)}
          annualMetrics={annualMetrics}
          billingTotals={billingTotals}
          collectionTotals={collectionTotals}
          quarterlyQBRs={quarterlyQBRs}
          quarterlyHeroStories={quarterlyHeroStories}
          quarterlyNewLogos={quarterlyNewLogos}
          newLogosTotals={newLogosTotals}
          quarterlyARR={quarterlyARR}
          quarterlyServiceRev={quarterlyServiceRev}
          weightages={weightages}
          metricAchievements={metricAchievements}
          billingTimeliness={billingTimeliness.score}
          collectionTimeliness={collectionTimeliness.score}
          okrScore={okrScore}
          selectedFY={selectedFY}
          selectedFunction={selectedFunction}
          pipelineCoverage={pipelineCoverage}
          ragMetrics={ragMetrics}
        />
      )}
      {showBalancedImg && (
        <div onClick={() => setShowBalancedImg(false)} style={{
          position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
          background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(6px)',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          zIndex: 9999, animation: 'fadeIn 0.2s ease',
        }}>
          <div onClick={e => e.stopPropagation()} style={{
            background: '#fff', borderRadius: 16, padding: 20,
            width: '96vw', maxWidth: 1100, maxHeight: '94vh', overflowY: 'auto',
            position: 'relative', animation: 'slideUp 0.3s ease',
            boxShadow: '0 24px 48px rgba(0,0,0,0.25)',
          }}>
            <button onClick={() => setShowBalancedImg(false)} style={{
              position: 'absolute', top: 12, right: 12, width: 34, height: 34, borderRadius: 8,
              border: '1px solid #e2e8f0', background: '#fff', fontSize: 16, cursor: 'pointer',
              display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#64748b',
              zIndex: 1,
            }}>✕</button>
            <h3 style={{ fontSize: 20, fontWeight: 700, color: '#1a1a2e', marginBottom: 12 }}>🎯 {selectedFunction || 'KAM'} OKR — Balanced Scorecard</h3>
            <img
              src={selectedFunction === 'SALES' ? './sales-balanced-scorecard.jpg' : './kam-balanced-scorecard.jpg'}
              alt={`${selectedFunction || 'KAM'} Balanced Scorecard`}
              style={{ width: '100%', height: 'auto', borderRadius: 8, display: 'block' }}
            />
          </div>
        </div>
      )}

      {/* AI Chat Bubble */}
      <ChatBubble selectedFunction={selectedFunction} selectedFY={selectedFY} />
    </div>
  );
}

/* ================================================================
   AI Chat Bubble (Floating, Ollama-powered)
   ================================================================ */
function ChatBubble({ selectedFunction, selectedFY }) {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isStreaming, setIsStreaming] = useState(false);
  const [btnBottom, setBtnBottom] = useState(24);
  const isDragging = useRef(false);
  const dragStartY = useRef(0);
  const dragStartBottom = useRef(0);
  const hasDragged = useRef(false);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  const scrollToBottom = useCallback(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, []);

  useEffect(() => { scrollToBottom(); }, [messages, scrollToBottom]);
  useEffect(() => { if (isOpen && inputRef.current) inputRef.current.focus(); }, [isOpen]);

  // Drag handlers for the floating button
  const onPointerDown = useCallback((e) => {
    isDragging.current = true;
    hasDragged.current = false;
    dragStartY.current = e.clientY;
    dragStartBottom.current = btnBottom;
    e.currentTarget.setPointerCapture(e.pointerId);
  }, [btnBottom]);

  const onPointerMove = useCallback((e) => {
    if (!isDragging.current) return;
    const delta = dragStartY.current - e.clientY;
    if (Math.abs(delta) > 4) hasDragged.current = true;
    const newBottom = Math.max(10, Math.min(window.innerHeight - 70, dragStartBottom.current + delta));
    setBtnBottom(newBottom);
  }, []);

  const onPointerUp = useCallback((e) => {
    isDragging.current = false;
    if (!hasDragged.current) {
      setIsOpen(true);
    }
  }, []);

  const suggestedQuestions = [
    { icon: '📊', text: 'CEO Summary' },
    { icon: '⚠️', text: 'Underperforming metrics' },
    { icon: '🏆', text: 'Top performers' },
    { icon: '💰', text: 'Billing vs Collection' },
    { icon: '🔄', text: 'Compare KAM vs SALES' },
  ];

  const sendMessage = useCallback(async (text) => {
    const userMsg = text || input.trim();
    if (!userMsg || isStreaming) return;

    setInput('');
    const newMessages = [...messages, { role: 'user', content: userMsg }];
    setMessages([...newMessages, { role: 'assistant', content: '', streaming: true }]);
    setIsStreaming(true);

    try {
      const response = await fetch('http://localhost:3001/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: userMsg,
          function: selectedFunction,
          fy: selectedFY,
          history: newMessages.slice(-6),
        }),
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const data = line.slice(6).trim();
          if (data === '[DONE]') break;

          try {
            const parsed = JSON.parse(data);
            if (parsed.token) {
              fullText += parsed.token;
              setMessages(prev => {
                const updated = [...prev];
                updated[updated.length - 1] = { role: 'assistant', content: fullText, streaming: true };
                return updated;
              });
            }
            if (parsed.error) {
              fullText = `Error: ${parsed.error}`;
              setMessages(prev => {
                const updated = [...prev];
                updated[updated.length - 1] = { role: 'assistant', content: fullText, streaming: false };
                return updated;
              });
              setIsStreaming(false);
              return;
            }
          } catch (e) {}
        }
      }

      setMessages(prev => {
        const updated = [...prev];
        updated[updated.length - 1] = { role: 'assistant', content: fullText || 'No response from AI.', streaming: false };
        return updated;
      });
    } catch (err) {
      const errorMsg = err.message.includes('Failed to fetch')
        ? 'Cannot connect to server. Make sure the backend is running.'
        : `Error: ${err.message}`;
      setMessages(prev => {
        const updated = [...prev];
        updated[updated.length - 1] = { role: 'assistant', content: errorMsg, streaming: false };
        return updated;
      });
    }
    setIsStreaming(false);
  }, [input, isStreaming, messages, selectedFunction, selectedFY]);

  const handleKeyDown = useCallback((e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }, [sendMessage]);

  /* ── AI Avatar component with pulsing glow ── */
  const AIAvatar = ({ size = 28, animate = false }) => (
    <div style={{
      width: size, height: size, borderRadius: '50%',
      background: 'linear-gradient(135deg, #E81F76, #ff6b9d)',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      boxShadow: animate ? '0 0 12px rgba(232, 31, 118, 0.5), 0 0 24px rgba(232, 31, 118, 0.2)' : '0 0 8px rgba(232, 31, 118, 0.3)',
      animation: animate ? 'aiPulse 2s ease-in-out infinite' : 'none',
      flexShrink: 0,
    }}>
      <svg width={size * 0.55} height={size * 0.55} viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
        <path d="M9 14h6"/>
        <rect x="8" y="12" width="8" height="8" rx="2"/>
        <circle cx="10" cy="16" r="1" fill="#fff"/>
        <circle cx="14" cy="16" r="1" fill="#fff"/>
      </svg>
    </div>
  );

  /* ── Typing indicator (three dots) ── */
  const TypingIndicator = () => (
    <div style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '4px 0' }}>
      {[0, 1, 2].map(i => (
        <span key={i} style={{
          width: 7, height: 7, borderRadius: '50%',
          background: '#E81F76',
          animation: `typingBounce 1.2s ease-in-out ${i * 0.15}s infinite`,
          opacity: 0.6,
        }} />
      ))}
    </div>
  );

  return (
    <>
      {/* ── Futuristic Chat Styles ── */}
      <style>{`
        @keyframes chatSlideUp {
          from { opacity: 0; transform: translateY(20px) scale(0.95); }
          to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes aiPulse {
          0%, 100% { box-shadow: 0 0 8px rgba(232,31,118,0.4), 0 0 16px rgba(232,31,118,0.15); }
          50% { box-shadow: 0 0 16px rgba(232,31,118,0.6), 0 0 32px rgba(232,31,118,0.25); }
        }
        @keyframes typingBounce {
          0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
          30% { transform: translateY(-6px); opacity: 1; }
        }
        @keyframes floatBtn {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-4px); }
        }
        @keyframes glowRing {
          0%, 100% { box-shadow: 0 0 12px rgba(232,31,118,0.4), 0 0 24px rgba(232,31,118,0.15); }
          50% { box-shadow: 0 0 20px rgba(232,31,118,0.6), 0 0 40px rgba(232,31,118,0.2); }
        }
        @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
        }
        @keyframes shimmer {
          0% { background-position: -200% center; }
          100% { background-position: 200% center; }
        }
        .fx-chat-bubble-btn {
          animation: floatBtn 3s ease-in-out infinite, glowRing 2s ease-in-out infinite;
        }
        .fx-chat-bubble-btn:hover {
          transform: scale(1.12) !important;
          box-shadow: 0 0 24px rgba(232,31,118,0.6), 0 0 48px rgba(232,31,118,0.25) !important;
        }
        .fx-chat-window {
          animation: chatSlideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .fx-msg-area::-webkit-scrollbar { width: 5px; }
        .fx-msg-area::-webkit-scrollbar-track { background: transparent; }
        .fx-msg-area::-webkit-scrollbar-thumb { background: rgba(232,31,118,0.2); border-radius: 10px; }
        .fx-msg-area::-webkit-scrollbar-thumb:hover { background: rgba(232,31,118,0.4); }
        .fx-chat-input:focus {
          outline: none;
          border-color: #E81F76;
          box-shadow: 0 0 0 3px rgba(232,31,118,0.1), 0 0 12px rgba(232,31,118,0.08);
        }
        .fx-suggested-btn {
          transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .fx-suggested-btn:hover {
          background: linear-gradient(135deg, #E81F76, #ff6b9d) !important;
          color: #fff !important;
          border-color: transparent !important;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(232,31,118,0.3);
        }
        .fx-send-btn:hover:not(:disabled) {
          box-shadow: 0 4px 16px rgba(232,31,118,0.4);
          transform: scale(1.05);
        }
        .fx-clear-btn:hover {
          background: rgba(255,255,255,0.25) !important;
        }
        .fx-chat-md p { margin: 0 0 8px 0; line-height: 1.6; }
        .fx-chat-md p:last-child { margin-bottom: 0; }
        .fx-chat-md ul, .fx-chat-md ol { margin: 6px 0; padding-left: 18px; }
        .fx-chat-md li { margin: 3px 0; line-height: 1.5; }
        .fx-chat-md strong { color: #E81F76; font-weight: 600; }
        .fx-chat-md code { background: rgba(232,31,118,0.08); color: #E81F76; padding: 1px 5px; border-radius: 4px; font-size: 12px; }
        .fx-chat-md h1, .fx-chat-md h2, .fx-chat-md h3 { font-size: 13px; font-weight: 700; margin: 10px 0 4px 0; color: #1a1a2e; }
      `}</style>

      {/* ── Floating Chat Button (draggable) ── */}
      {!isOpen && (
        <button
          className="fx-chat-bubble-btn"
          onPointerDown={onPointerDown}
          onPointerMove={onPointerMove}
          onPointerUp={onPointerUp}
          title="Drag to reposition \u2022 Click to open"
          style={{
            position: 'fixed', bottom: btnBottom, right: 24, zIndex: 10000,
            width: 58, height: 58, borderRadius: '50%',
            background: 'linear-gradient(135deg, #E81F76 0%, #ff6b9d 100%)',
            border: '2px solid rgba(255,255,255,0.2)',
            cursor: isDragging.current ? 'grabbing' : 'grab',
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            transition: isDragging.current ? 'none' : 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.3s',
            touchAction: 'none',
          }}
        >
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
            <path d="M9 14h6"/>
            <rect x="8" y="12" width="8" height="8" rx="2"/>
            <circle cx="10" cy="16" r="1" fill="#fff"/>
            <circle cx="14" cy="16" r="1" fill="#fff"/>
          </svg>
        </button>
      )}

      {/* ── Chat Window ── */}
      {isOpen && (
        <div className="fx-chat-window" style={{
          position: 'fixed', bottom: Math.min(btnBottom + 66, window.innerHeight - 530), right: 24, zIndex: 10000,
          width: 400, height: 520, borderRadius: 20,
          background: '#0f0f1a',
          border: '1px solid rgba(232,31,118,0.2)',
          boxShadow: '0 20px 60px rgba(0,0,0,0.4), 0 0 30px rgba(232,31,118,0.08)',
          display: 'flex', flexDirection: 'column', overflow: 'hidden',
        }}>

          {/* ── Header ── */}
          <div style={{
            background: 'linear-gradient(135deg, rgba(232,31,118,0.15) 0%, rgba(255,107,157,0.08) 100%)',
            borderBottom: '1px solid rgba(232,31,118,0.15)',
            padding: '14px 18px', display: 'flex', alignItems: 'center', justifyContent: 'space-between',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <AIAvatar size={34} animate={isStreaming} />
              <div>
                <div style={{
                  fontWeight: 700, fontSize: 14, color: '#fff',
                  letterSpacing: '0.5px',
                }}>OKR AI Analyst</div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginTop: 2 }}>
                  <span style={{
                    width: 6, height: 6, borderRadius: '50%',
                    background: isStreaming ? '#fbbf24' : '#34d399',
                    boxShadow: isStreaming ? '0 0 6px rgba(251,191,36,0.5)' : '0 0 6px rgba(52,211,153,0.5)',
                    animation: isStreaming ? 'blink 1s infinite' : 'none',
                  }} />
                  <span style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', fontWeight: 500 }}>
                    {isStreaming ? 'Analyzing...' : `${selectedFunction} \u00b7 ${selectedFY}`}
                  </span>
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
              {messages.length > 0 && (
                <button
                  className="fx-clear-btn"
                  onClick={() => setMessages([])}
                  title="Clear chat"
                  style={{
                    background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)',
                    borderRadius: 8, color: 'rgba(255,255,255,0.6)', cursor: 'pointer',
                    padding: '5px 12px', fontSize: 11, fontWeight: 500,
                    transition: 'all 0.2s', letterSpacing: '0.3px',
                  }}
                >Clear</button>
              )}
              <button
                onClick={() => setIsOpen(false)}
                style={{
                  background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 8, color: 'rgba(255,255,255,0.6)', cursor: 'pointer',
                  width: 30, height: 30, display: 'flex', alignItems: 'center', justifyContent: 'center',
                  fontSize: 16, transition: 'all 0.2s',
                }}
              >{'\u2715'}</button>
            </div>
          </div>

          {/* ── Messages Area ── */}
          <div className="fx-msg-area" style={{
            flex: 1, overflowY: 'auto', padding: '16px',
            display: 'flex', flexDirection: 'column', gap: 14,
            background: 'linear-gradient(180deg, #0f0f1a 0%, #141425 100%)',
          }}>
            {/* Welcome screen */}
            {messages.length === 0 && (
              <div style={{ textAlign: 'center', padding: '16px 8px' }}>
                <div style={{
                  width: 56, height: 56, borderRadius: '50%', margin: '0 auto 14px',
                  background: 'linear-gradient(135deg, rgba(232,31,118,0.15), rgba(255,107,157,0.08))',
                  border: '1px solid rgba(232,31,118,0.2)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                }}>
                  <AIAvatar size={36} animate />
                </div>
                <div style={{
                  fontSize: 16, fontWeight: 700, color: '#fff', marginBottom: 6,
                  letterSpacing: '0.3px',
                }}>
                  OKR AI Analyst
                </div>
                <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.4)', marginBottom: 22, lineHeight: 1.5 }}>
                  Ask about any metric across KAM, SALES, and all fiscal years.
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                  {suggestedQuestions.map((q) => (
                    <button
                      key={q.text}
                      className="fx-suggested-btn"
                      onClick={() => sendMessage(`${q.icon} ${q.text}`)}
                      style={{
                        background: 'rgba(255,255,255,0.04)',
                        border: '1px solid rgba(255,255,255,0.08)',
                        borderRadius: 12, padding: '10px 14px',
                        fontSize: 12, cursor: 'pointer',
                        color: 'rgba(255,255,255,0.7)',
                        display: 'flex', alignItems: 'center', gap: 10,
                        textAlign: 'left',
                      }}
                    >
                      <span style={{ fontSize: 16, flexShrink: 0 }}>{q.icon}</span>
                      <span>{q.text}</span>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Message bubbles */}
            {messages.map((msg, i) => (
              <div key={i} style={{
                display: 'flex', gap: 10,
                flexDirection: msg.role === 'user' ? 'row-reverse' : 'row',
                alignItems: 'flex-start',
              }}>
                {/* Avatar for bot messages */}
                {msg.role === 'assistant' && (
                  <AIAvatar size={26} animate={msg.streaming} />
                )}

                <div style={{
                  maxWidth: '80%',
                  padding: '10px 14px',
                  borderRadius: msg.role === 'user' ? '14px 14px 4px 14px' : '14px 14px 14px 4px',
                  background: msg.role === 'user'
                    ? 'linear-gradient(135deg, #E81F76, #ff6b9d)'
                    : 'rgba(255,255,255,0.06)',
                  color: msg.role === 'user' ? '#fff' : 'rgba(255,255,255,0.88)',
                  fontSize: 13, lineHeight: 1.55,
                  border: msg.role === 'user' ? 'none' : '1px solid rgba(255,255,255,0.06)',
                  boxShadow: msg.role === 'user'
                    ? '0 2px 12px rgba(232,31,118,0.25)'
                    : '0 1px 4px rgba(0,0,0,0.15)',
                }}>
                  {msg.role === 'user' ? (
                    <span style={{ fontWeight: 500 }}>{msg.content}</span>
                  ) : (
                    <div className="fx-chat-md">
                      {!msg.content && msg.streaming ? (
                        <TypingIndicator />
                      ) : (
                        <>
                          <ReactMarkdown>{msg.content}</ReactMarkdown>
                          {msg.streaming && msg.content && (
                            <span style={{
                              display: 'inline-block', width: 2, height: 14,
                              background: '#E81F76', marginLeft: 2,
                              animation: 'blink 0.8s infinite',
                              verticalAlign: 'text-bottom',
                              boxShadow: '0 0 4px rgba(232,31,118,0.5)',
                            }} />
                          )}
                        </>
                      )}
                    </div>
                  )}
                </div>
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>

          {/* ── Input Area ── */}
          <div style={{
            padding: '12px 14px',
            borderTop: '1px solid rgba(232,31,118,0.1)',
            display: 'flex', gap: 8,
            background: 'rgba(15,15,26,0.95)',
          }}>
            <input
              ref={inputRef}
              className="fx-chat-input"
              type="text"
              placeholder={isStreaming ? 'AI is thinking...' : 'Ask about your metrics...'}
              value={input}
              onChange={e => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              disabled={isStreaming}
              style={{
                flex: 1, padding: '11px 14px', borderRadius: 12,
                border: '1px solid rgba(255,255,255,0.1)',
                background: 'rgba(255,255,255,0.05)',
                color: '#fff', fontSize: 13,
                transition: 'all 0.25s',
              }}
            />
            <button
              className="fx-send-btn"
              onClick={() => sendMessage()}
              disabled={isStreaming || !input.trim()}
              style={{
                width: 42, height: 42, borderRadius: 12, border: 'none',
                background: isStreaming || !input.trim()
                  ? 'rgba(255,255,255,0.05)'
                  : 'linear-gradient(135deg, #E81F76, #ff6b9d)',
                color: isStreaming || !input.trim() ? 'rgba(255,255,255,0.2)' : '#fff',
                cursor: isStreaming || !input.trim() ? 'not-allowed' : 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                transition: 'all 0.25s',
                boxShadow: isStreaming || !input.trim() ? 'none' : '0 2px 12px rgba(232,31,118,0.3)',
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>

          {/* ── Powered by footer ── */}
          <div style={{
            textAlign: 'center', padding: '6px',
            fontSize: 9, color: 'rgba(255,255,255,0.2)',
            borderTop: '1px solid rgba(255,255,255,0.03)',
            letterSpacing: '0.5px', fontWeight: 500,
          }}>
            POWERED BY GROQ | LLAMA 3.3 70B
          </div>
        </div>
      )}
    </>
  );
}

/* ================================================================
   App Root
   ================================================================ */
function App() {
  return (
    <KamDataProvider>
      <DashboardContent />
    </KamDataProvider>
  );
}

export default App;
